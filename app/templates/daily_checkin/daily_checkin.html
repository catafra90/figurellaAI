{% extends "base.html" %}

{% block content %}
<div class="h-screen flex flex-col bg-gray-50">

  <!-- Header -->
  <div class="flex-shrink-0 flex justify-between items-center px-4 py-3 bg-white shadow">
    <h2 class="text-2xl font-bold figurella-pink">Daily Checks</h2>
    <a href="{{ url_for('daily_checkin.report_history') }}"
       class="text-gray-500 hover:text-figurella" title="View History">
      <i class="bi bi-clock-history text-2xl"></i>
    </a>
  </div>

  <!-- Tabs -->
  <div class="bg-white border-b">
    <div class="px-4">
      <ul id="dc-tabs" class="flex gap-8 text-sm justify-end">
        <li>
          <button class="dc-tab active relative py-3" data-tab="daily-form" type="button">
            <span class="font-medium">Daily Report</span>
            <span class="dc-underline"></span>
          </button>
        </li>
        <li>
          <button class="dc-tab relative py-3" data-tab="monthly-plan" type="button">
            <span class="font-medium">Monthly Planning</span>
            <span class="dc-underline"></span>
          </button>
        </li>
        <li>
          <button class="dc-tab relative py-3" data-tab="active-clients" type="button">
            <span class="font-medium">Active Clients</span>
            <span class="dc-underline"></span>
          </button>
        </li>
      </ul>
    </div>
  </div>

  <!-- Body -->
  <div class="flex-1 overflow-y-auto p-4">

    <!-- TAB: DAILY REPORT -->
    <section id="tab-daily-form" class="tab-panel space-y-6">
      <form id="daily-form" method="POST"
            action="{{ url_for('daily_checkin.submit_report') }}"
            class="space-y-6" novalidate>

        <!-- Sales -->
        <div class="bg-white rounded-2xl shadow p-6">
          <div class="flex items-center justify-between mb-4">
            <h3 class="text-xl font-semibold">üí∞ Sales</h3>
            <button type="button" class="bg-figurella text-white px-4 py-2 rounded"
                    onclick="DC.addRow('sales')">+ Add Sale</button>
          </div>
          <div id="sales-section"></div>
        </div>

        <!-- Leads -->
        <div class="bg-white rounded-2xl shadow p-6">
          <div class="flex items-center justify-between mb-4">
            <h3 class="text-xl font-semibold">üìù Leads</h3>
            <button type="button" class="bg-figurella text-white px-4 py-2 rounded"
                    onclick="DC.addRow('leads')">+ Add Lead</button>
          </div>
          <div id="leads-section"></div>
        </div>

        <!-- Consultations -->
        <div class="bg-white rounded-2xl shadow p-6">
          <div class="flex items-center justify-between mb-4">
            <h3 class="text-xl font-semibold">üìÖ Consultations</h3>
            <button type="button" class="bg-figurella text-white px-4 py-2 rounded"
                    onclick="DC.addRow('consultations')">+ Add Consultation</button>
          </div>
          <div id="consultations-section"></div>
        </div>

        <!-- Opportunities -->
        <div class="bg-white rounded-2xl shadow p-6">
          <div class="flex items-center justify-between mb-4">
            <h3 class="text-xl font-semibold">üí° Opportunities</h3>
            <button type="button" class="bg-figurella text-white px-4 py-2 rounded"
                    onclick="DC.addRow('opportunities')">+ Add Opportunity</button>
          </div>
          <div id="opportunities-section"></div>
        </div>

        <!-- Attendances -->
        <div class="bg-white rounded-2xl shadow p-6">
          <div class="flex items-center justify-between mb-4">
            <h3 class="text-xl font-semibold">üßç Attendances</h3>
            <button type="button" class="bg-figurella text-white px-4 py-2 rounded"
                    onclick="DC.addRow('attendances')">+ Add Attendance</button>
          </div>
          <div id="attendances-section"></div>
        </div>

        <div class="h-24"></div>
      </form>
    </section>

    <!-- TAB: MONTHLY PLANNING -->
    <section id="tab-monthly-plan" class="tab-panel hidden">
      {% include 'daily_checkin/monthly_planning.html' %}
    </section>

<!-- TAB: ACTIVE CLIENTS -->
<section id="tab-active-clients" class="tab-panel hidden">
  {% include 'daily_checkin/active_clients.html' %}
</section>

 

  <!-- Sticky Submit Bar (only for Daily tab) -->
  <div id="dc-submitbar" class="sticky bottom-0 bg-white shadow-inner p-4 flex justify-end z-10">
    <button type="submit" form="daily-form"
            class="bg-figurella text-white px-6 py-2 rounded-full shadow hover:bg-pink-700 transition">
      Submit Report
    </button>
  </div>
</div>

<!-- Toast -->
<div id="dc-toast" class="fixed bottom-20 right-4 hidden bg-green-600 text-white px-4 py-2 rounded-lg shadow">
  ‚úÖ Report submitted
</div>

<style>
  .dc-tab { color:#111827; }
  .dc-tab.active { color:#CC0066; }
  .dc-underline{
    position:absolute; left:0; right:0; bottom:0;
    height:3px; background:#CC0066; border-radius:3px;
    transform:scaleX(0); transform-origin:left; transition:transform .18s;
  }
  .dc-tab.active .dc-underline{ transform:scaleX(1); }
</style>

<script>
/* Tabs: show/hide + keep footer only for Daily */
(function(){
  const tabs = document.querySelectorAll('.dc-tab');
  const panels = {
    'daily-form':     document.getElementById('tab-daily-form'),
    'monthly-plan':   document.getElementById('tab-monthly-plan'),
    'active-clients': document.getElementById('tab-active-clients')
  };
  const submitBar = document.getElementById('dc-submitbar');

  function setActive(key){
    tabs.forEach(b=>b.classList.remove('active'));
    document.querySelector(`.dc-tab[data-tab="${key}"]`)?.classList.add('active');
    Object.keys(panels).forEach(k=>panels[k].classList.add('hidden'));
    panels[key].classList.remove('hidden');
    submitBar.style.display = (key === 'daily-form') ? 'flex' : 'none';
  }

  tabs.forEach(btn=> btn.addEventListener('click', ()=> setActive(btn.dataset.tab)));
  setActive('daily-form'); // default
})();
</script>

<script>
/* Active Clients: lightweight client-side plumbing
   When you're ready, have your backend return something like:
   GET /daily-check-in/active_clients  ->  { "rows": [ {client, status, plan, start, expiration, sessions, residual}, ... ], "updated_at": "2025-08-24T12:34:56Z" }
*/
(function(){
  const $body = document.getElementById('ac-body');
  const $empty = document.getElementById('ac-empty');
  const $meta = document.getElementById('ac-meta');
  const $search = document.getElementById('ac-search');

  async function fetchActiveClients(){
    try{
      // TODO: replace URL with your real endpoint or file loader route
      const res = await fetch('{{ url_for("daily_checkin.active_clients_json") if false else "#" }}', {headers:{'Accept':'application/json'}});
      if(!res.ok) throw new Error('no endpoint yet');
      const data = await res.json();
      renderRows(Array.isArray(data.rows)? data.rows : []);
      $meta.textContent = data.updated_at ? `Updated ${new Date(data.updated_at).toLocaleString()}` : '';
    }catch(_){
      // keep placeholder until endpoint exists
      renderRows([]);
      $meta.textContent = 'Connect data source';
    }
  }

  function renderRows(rows){
    // clear
    $body.querySelectorAll('tr').forEach(tr=>tr.remove());
    if(!rows.length){
      $body.appendChild($empty);
      $empty.classList.remove('hidden');
      return;
    }
    $empty.classList.add('hidden');
    for(const r of rows){
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td class="border px-3 py-2">${escapeHTML(r.client || '')}</td>
        <td class="border px-3 py-2">${escapeHTML(r.status || '')}</td>
        <td class="border px-3 py-2">${escapeHTML(r.plan || '')}</td>
        <td class="border px-3 py-2">${escapeHTML(r.start || '')}</td>
        <td class="border px-3 py-2">${escapeHTML(r.expiration || '')}</td>
        <td class="border px-3 py-2">${escapeHTML(r.sessions || '')}</td>
        <td class="border px-3 py-2">${escapeHTML(r.residual || '')}</td>
      `;
      $body.appendChild(tr);
    }
  }

  function escapeHTML(s){
    return String(s).replace(/[&<>"']/g, m => ({
      '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'
    }[m]));
  }

  // search filter (client/status/plan)
  function filterRows(q){
    const query = (q||'').trim().toLowerCase();
    $body.querySelectorAll('tr').forEach(tr=>{
      if(tr.id === 'ac-empty') return;
      const text = tr.textContent.toLowerCase();
      tr.style.display = text.includes(query) ? '' : 'none';
    });
  }

  document.getElementById('ac-refresh')?.addEventListener('click', fetchActiveClients);
  $search?.addEventListener('input', e=> filterRows(e.target.value));

  // no auto-fetch yet (endpoint not wired); call fetchActiveClients() once you add the route
  // fetchActiveClients();
})();
</script>

<script>
/* Daily Report autosave + submit (unchanged) */
(function () {
  const DRAFT_KEY = 'daily_checkin_draft_v3';
  const FIELDS = {
    sales: ['client_name','package_sold','revenue'],
    leads: ['lead_name','lead_date','lead_source'],
    consultations: ['consult_client','consult_outcome','consult_source'],
    opportunities: ['opp_name','opp_provider','opp_description'],
    attendances: ['att_attended','att_no_show']
  };
  const SECTIONS = {
    sales: document.getElementById('sales-section'),
    leads: document.getElementById('leads-section'),
    consultations: document.getElementById('consultations-section'),
    opportunities: document.getElementById('opportunities-section'),
    attendances: document.getElementById('attendances-section')
  };
  const $form  = document.getElementById('daily-form');
  const $toast = document.getElementById('dc-toast');

  function showToast(){ $toast.classList.remove('hidden'); setTimeout(()=> $toast.classList.add('hidden'), 1800); }

  function buildRow(section, values = {}) {
    const fields = FIELDS[section];
    const row = document.createElement('div');
    row.className = 'dc-row grid gap-2 mb-2';
    row.style.gridTemplateColumns = `repeat(${fields.length}, minmax(0, 1fr))`;
    fields.forEach((f) => {
      const input = document.createElement('input');
      input.name = `${f}[]`;
      input.className = 'border p-2 rounded w-full';
      input.placeholder = f.replace(/_/g, ' ');
      if (values && values[f] != null) input.value = values[f];
      input.addEventListener('input', saveDraftDebounced);
      row.appendChild(input);
    });
    return row;
  }

  function collectDraft(){
    const draft = {};
    Object.keys(SECTIONS).forEach(section=>{
      const container = SECTIONS[section];
      const fields    = FIELDS[section];
      const rows      = Array.from(container.querySelectorAll('.dc-row'));
      draft[section]  = rows.map(row=>{
        const obj={}; fields.forEach(f=>{
          const el = row.querySelector(`input[name="${f}[]"]`);
          obj[f] = el ? el.value : '';
        }); return obj;
      });
    });
    draft._ts = Date.now();
    return draft;
  }

  function saveDraft(){ localStorage.setItem(DRAFT_KEY, JSON.stringify(collectDraft())); }
  let saveTimer=null;
  function saveDraftDebounced(){ if(saveTimer) clearTimeout(saveTimer); saveTimer=setTimeout(saveDraft,200); }

  function renderFromDraft(draft){
    Object.keys(SECTIONS).forEach(section=>{
      const container = SECTIONS[section];
      container.innerHTML='';
      const rows = (draft && draft[section] && draft[section].length) ? draft[section] : [ {} ];
      rows.forEach(r=> container.appendChild(buildRow(section, r)));
    });
  }

  window.DC = {
    addRow(section){
      if(!SECTIONS[section]) return;
      SECTIONS[section].appendChild(buildRow(section, {}));
      saveDraft();
    }
  };

  (function init(){
    let draft=null; try{ draft = JSON.parse(localStorage.getItem(DRAFT_KEY) || 'null'); }catch(_){}
    renderFromDraft(draft);
    $form.addEventListener('input', saveDraftDebounced);
    $form.addEventListener('submit', handleSubmit);
  })();

  async function handleSubmit(e){
    e.preventDefault();
    const formData = new FormData($form); formData.append('ajax','1');
    try{
      const res = await fetch($form.action, { method:'POST', body:formData, headers:{'Accept':'application/json'} });
      if(!res.ok) throw new Error('Non-200 response');
      localStorage.removeItem(DRAFT_KEY);
      renderFromDraft(null);
      showToast();
    }catch(err){
      $form.submit();
    }
  }
})();
</script>
{% endblock %}
