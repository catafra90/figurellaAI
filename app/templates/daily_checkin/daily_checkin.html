{% extends "base.html" %}

{% block content %}
<div class="h-screen flex flex-col bg-gray-50">

  <!-- Header (always visible) -->
  <div class="flex-shrink-0 flex justify-between items-center px-4 py-3 bg-white shadow">
    <h2 class="text-2xl font-bold figurella-pink">Daily Check-in</h2>
    <a href="{{ url_for('daily_checkin.report_history') }}"
       class="text-gray-500 hover:text-figurella"
       title="View History">
      <i class="bi bi-clock-history text-2xl"></i>
    </a>
  </div>

  <!-- Scrollable content with form inside -->
  <div class="flex-1 overflow-y-auto p-4">
    <form id="daily-form" method="POST" action="{{ url_for('daily_checkin.submit_report') }}" class="space-y-6" novalidate>

      <!-- Sales Section -->
      <div class="bg-white rounded-2xl shadow p-6">
        <div class="flex items-center justify-between mb-4">
          <h3 class="text-xl font-semibold">üí∞ Sales</h3>
          <button type="button"
                  class="bg-figurella text-white px-4 py-2 rounded"
                  onclick="DC.addRow('sales')">
            + Add Sale
          </button>
        </div>
        <div id="sales-section"></div>
      </div>

      <!-- Leads Section -->
      <div class="bg-white rounded-2xl shadow p-6">
        <div class="flex items-center justify-between mb-4">
          <h3 class="text-xl font-semibold">üìù Leads</h3>
          <button type="button"
                  class="bg-figurella text-white px-4 py-2 rounded"
                  onclick="DC.addRow('leads')">
            + Add Lead
          </button>
        </div>
        <div id="leads-section"></div>
      </div>

      <!-- Consultations Section -->
      <div class="bg-white rounded-2xl shadow p-6">
        <div class="flex items-center justify-between mb-4">
          <h3 class="text-xl font-semibold">üìÖ Consultations</h3>
          <button type="button"
                  class="bg-figurella text-white px-4 py-2 rounded"
                  onclick="DC.addRow('consultations')">
            + Add Consultation
          </button>
        </div>
        <div id="consultations-section"></div>
      </div>

      <!-- Opportunities Section -->
      <div class="bg-white rounded-2xl shadow p-6">
        <div class="flex items-center justify-between mb-4">
          <h3 class="text-xl font-semibold">üí° Opportunities</h3>
          <button type="button"
                  class="bg-figurella text-white px-4 py-2 rounded"
                  onclick="DC.addRow('opportunities')">
            + Add Opportunity
          </button>
        </div>
        <div id="opportunities-section"></div>
      </div>

      <!-- Attendances Section -->
      <div class="bg-white rounded-2xl shadow p-6">
        <div class="flex items-center justify-between mb-4">
          <h3 class="text-xl font-semibold">üßç Attendances</h3>
          <button type="button"
                  class="bg-figurella text-white px-4 py-2 rounded"
                  onclick="DC.addRow('attendances')">
            + Add Attendance
          </button>
        </div>
        <div id="attendances-section"></div>
      </div>

      <!-- Extra bottom padding so last inputs can scroll above footer -->
      <div class="h-24"></div>
    </form>
  </div>

  <!-- Sticky Submit Bar -->
  <div class="sticky bottom-0 bg-white shadow-inner p-4 flex justify-end z-10">
    <button type="submit"
            form="daily-form"
            class="bg-figurella text-white px-6 py-2 rounded-full shadow hover:bg-pink-700 transition">
      Submit Report
    </button>
  </div>
</div>

<!-- Toast -->
<div id="dc-toast"
     class="fixed bottom-20 right-4 hidden bg-green-600 text-white px-4 py-2 rounded-lg shadow">
  ‚úÖ Report submitted
</div>

<script>
/**
 * Daily Check-in draft persistence + submit handler
 * - Keeps edits in localStorage while you navigate away.
 * - Sends to server ONLY on Submit.
 * - Clears draft ONLY after a successful submit.
 */
(function () {
  const DRAFT_KEY = 'daily_checkin_draft_v3';

  // Field definitions per section
  const FIELDS = {
    sales:         ['client_name','package_sold','revenue'],
    leads:         ['lead_name','lead_date','lead_source'],
    consultations: ['consult_client','consult_outcome','consult_source'],
    opportunities: ['opp_name','opp_provider','opp_description'],
    attendances:   ['att_attended','att_no_show']
  };

  // Section containers
  const SECTIONS = {
    sales:         document.getElementById('sales-section'),
    leads:         document.getElementById('leads-section'),
    consultations: document.getElementById('consultations-section'),
    opportunities: document.getElementById('opportunities-section'),
    attendances:   document.getElementById('attendances-section')
  };

  // Helpers
  const $form = document.getElementById('daily-form');
  const $toast = document.getElementById('dc-toast');

  function showToast() {
    $toast.classList.remove('hidden');
    setTimeout(() => $toast.classList.add('hidden'), 1800);
  }

  // Build a row DOM node
  function buildRow(section, values = {}) {
    const fields = FIELDS[section];
    const row = document.createElement('div');
    row.className = 'dc-row grid gap-2 mb-2';
    // Tailwind's dynamic grid-cols can get purged; ensure inline template columns
    row.style.gridTemplateColumns = `repeat(${fields.length}, minmax(0, 1fr))`;

    fields.forEach((f) => {
      const input = document.createElement('input');
      input.name = `${f}[]`;
      input.className = 'border p-2 rounded w-full';
      input.placeholder = f.replace(/_/g, ' ');
      if (values && values[f] != null) input.value = values[f];
      input.addEventListener('input', saveDraftDebounced);
      row.appendChild(input);
    });

    return row;
  }

  // Save current DOM ‚Üí draft
  function collectDraft() {
    const draft = {};
    Object.keys(SECTIONS).forEach((section) => {
      const container = SECTIONS[section];
      const fields = FIELDS[section];
      const rows = Array.from(container.querySelectorAll('.dc-row'));
      draft[section] = rows.map((row) => {
        const obj = {};
        fields.forEach((f) => {
          const el = row.querySelector(`input[name="${f}[]"]`);
          obj[f] = el ? el.value : '';
        });
        return obj;
      });
    });
    draft._ts = Date.now();
    return draft;
  }

  function saveDraft() {
    const data = collectDraft();
    localStorage.setItem(DRAFT_KEY, JSON.stringify(data));
  }

  let saveTimer = null;
  function saveDraftDebounced() {
    if (saveTimer) clearTimeout(saveTimer);
    saveTimer = setTimeout(saveDraft, 200);
  }

  // Render draft (or one empty row per section)
  function renderFromDraft(draft) {
    Object.keys(SECTIONS).forEach((section) => {
      const container = SECTIONS[section];
      container.innerHTML = '';
      const rows = (draft && draft[section] && draft[section].length)
        ? draft[section]
        : [ {} ]; // at least one blank row
      rows.forEach((r) => container.appendChild(buildRow(section, r)));
    });
  }

  // Public API for Add buttons
  window.DC = {
    addRow(section) {
      if (!SECTIONS[section]) return;
      SECTIONS[section].appendChild(buildRow(section, {}));
      saveDraft();
    }
  };

  // Attempt AJAX submit; fallback to normal form post on failure
  async function handleSubmit(e) {
    e.preventDefault();

    const formData = new FormData($form);
    // include a hint for the backend (non-breaking)
    formData.append('ajax', '1');

    try {
      const res = await fetch($form.action, {
        method: 'POST',
        body: formData,
        headers: { 'Accept': 'application/json' } // backend may still reply HTML; ok if 200
      });

      if (!res.ok) throw new Error('Non-200 response');

      // Success ‚Üí clear draft + reset UI
      localStorage.removeItem(DRAFT_KEY);
      renderFromDraft(null);
      showToast();
    } catch (err) {
      // If fetch fails (network/JSON), fall back to normal form submission
      // The draft stays, so user won't lose data.
      $form.submit();
    }
  }

  // Init
  (function init() {
    // Load saved draft (if any)
    let draft = null;
    try { draft = JSON.parse(localStorage.getItem(DRAFT_KEY) || 'null'); } catch(_) {}
    renderFromDraft(draft);

    // Any input change saves
    $form.addEventListener('input', saveDraftDebounced);
    // Submit handler
    $form.addEventListener('submit', handleSubmit);
  })();
})();
</script>
{% endblock %}
