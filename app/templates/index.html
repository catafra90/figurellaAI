{% extends "base.html" %}

{% block content %}
<div class="container mx-auto p-6">

  {# fallbacks if the view didn‚Äôt pass them #}
  {% set reports_ep = reports_ep|default(None) %}
  {% set checkin_ep = checkin_ep|default(None) %}

  <!-- Quick Actions -->
  <section aria-label="Quick actions" class="mb-8">
    <div class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-5 gap-4">
      <!-- Charts -->
      <a href="{{ url_for('charts.view_charts') }}"
         class="group bg-white rounded-xl shadow hover:shadow-lg border transition p-5 flex flex-col items-center justify-center text-center">
        <i class="bi bi-bar-chart-line text-3xl mb-2 text-figurella group-hover:scale-110 transition"></i>
        <div class="font-semibold">Clients Mgmt</div>
        <div class="text-xs text-gray-500 mt-1">Open client charts</div>
      </a>

      <!-- Clients -->
      <a href="{{ url_for('clients.clients') }}"
         class="group bg-white rounded-xl shadow hover:shadow-lg border transition p-5 flex flex-col items-center justify-center text-center">
        <i class="bi bi-people text-3xl mb-2 text-figurella group-hover:scale-110 transition"></i>
        <div class="font-semibold">Contacts</div>
        <div class="text-xs text-gray-500 mt-1">View all contacts</div>
      </a>

      <!-- Calendar -->
      <a href="{{ url_for('calendar.view_calendar') }}"
         class="group bg-white rounded-xl shadow hover:shadow-lg border transition p-5 flex flex-col items-center justify-center text-center">
        <i class="bi bi-calendar-event text-3xl mb-2 text-figurella group-hover:scale-110 transition"></i>
        <div class="font-semibold">Calendar</div>
        <div class="text-xs text-gray-500 mt-1">Appointments &amp; tasks</div>
      </a>

      <!-- Daily Checks -->
      {% if checkin_ep %}
      <a href="{{ url_for(checkin_ep) }}"
         class="group bg-white rounded-xl shadow hover:shadow-lg border transition p-5 flex flex-col items-center justify-center text-center">
        <i class="bi bi-clipboard-check text-3xl mb-2 text-figurella group-hover:scale-110 transition"></i>
        <div class="font-semibold">Daily Checks</div>
        <div class="text-xs text-gray-500 mt-1">Record today‚Äôs check-ins</div>
      </a>
      {% else %}
      <div class="bg-white rounded-xl shadow border p-5 flex flex-col items-center justify-center text-center opacity-60 pointer-events-none"
           title="Daily Check-In route not found">
        <i class="bi bi-clipboard-check text-3xl mb-2 text-gray-400"></i>
        <div class="font-semibold text-gray-600">Daily Checks</div>
        <div class="text-xs text-gray-400 mt-1">Not available</div>
      </div>
      {% endif %}

      <!-- Reports -->
      {% if reports_ep %}
      <a href="{{ url_for(reports_ep) }}"
         class="group bg-white rounded-xl shadow hover:shadow-lg border transition p-5 flex flex-col items-center justify-center text-center">
        <i class="bi bi-file-earmark-text text-3xl mb-2 text-figurella group-hover:scale-110 transition"></i>
        <div class="font-semibold">Reports</div>
        <div class="text-xs text-gray-500 mt-1">Daily &amp; monthly reports</div>
      </a>
      {% else %}
      <div class="bg-white rounded-xl shadow border p-5 flex flex-col items-center justify-center text-center opacity-60 pointer-events-none"
           title="Reports module not installed">
        <i class="bi bi-file-earmark-text text-3xl mb-2 text-gray-400"></i>
        <div class="font-semibold text-gray-600">Reports</div>
        <div class="text-xs text-gray-400 mt-1">Module not installed</div>
      </div>
      {% endif %}
    </div>
  </section>

  <!-- Notifications (Today) -->
  <div id="home-notifications" class="mt-8">
    <div class="flex items-center justify-between">
      <h2 class="text-lg font-semibold">Notifications</h2>
      <div id="notif-subtitle" class="text-xs text-gray-500">Today</div>
    </div>
    <ul id="notif-list" class="divide-y rounded-xl border bg-white mt-2"></ul>
  </div>
</div>

<!-- Toast root -->
<div id="toast-root" class="fixed right-4 bottom-4 space-y-2 z-50 pointer-events-none"></div>

<script>
(function() {
  const list = document.getElementById('notif-list');
  const subtitle = document.getElementById('notif-subtitle');
  const toastRoot = document.getElementById('toast-root');

  const DONE_STORE_KEY = 'fc_done_occurrences_v1';
  function loadDoneSet() {
    try { return new Set(JSON.parse(localStorage.getItem(DONE_STORE_KEY) || '')) }
    catch { return new Set(); }
  }
  function saveDoneSet(set) {
    try { localStorage.setItem(DONE_STORE_KEY, JSON.stringify([...set])); } catch {}
  }
  const doneSet = loadDoneSet();
  const doneKey = (id, token) => `${String(id)}|${token}`;

  function todayRangeISO() {
    const start = new Date(); start.setHours(0,0,0,0);
    const end = new Date();   end.setHours(23,59,59,999);
    return { start: start.toISOString(), end: end.toISOString(), label: start.toLocaleDateString() };
  }
  function ensureEmptyState() {
    if (list.childElementCount === 0) {
      const li = document.createElement('li');
      li.className = 'p-4 text-sm text-gray-500';
      li.textContent = 'No tasks scheduled for today.';
      list.appendChild(li);
    }
  }
  function timeRangeText(ev) {
    if (ev.allDay) return 'All day';
    const s = new Date(ev.start);
    const e = ev.end ? new Date(ev.end) : null;
    const fmt = (d) => d.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
    return e ? `${fmt(s)} ‚Äì ${fmt(e)}` : fmt(s);
  }
  function toast(title, body) {
    const el = document.createElement('div');
    el.className = 'pointer-events-auto bg-gray-900 text-white rounded-xl shadow px-4 py-3 max-w-sm';
    el.innerHTML = `<div class="font-semibold">‚è∞ ${title}</div>
                    <div class="text-sm opacity-80">${body || ''}</div>`;
    toastRoot.appendChild(el);
    setTimeout(() => el.remove(), 6000);
  }

  async function apiMarkDone(id, occurrenceStart) {
    try {
      const url = occurrenceStart
        ? `/calendar/api/events/${id}:${encodeURIComponent(occurrenceStart)}`
        : `/calendar/api/events/${id}`;
      const res = await fetch(url, {
        method: 'PATCH',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ completed: true, occurrenceStart: occurrenceStart || null })
      });
      if (res.ok) return true;

      const res2 = await fetch(`/calendar/api/events/${id}/complete`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ completed: true, occurrenceStart: occurrenceStart || null })
      });
      return res2.ok;
    } catch (_e) { return false; }
  }

  function renderTask(ev) {
    const li = document.createElement('li');
    li.className = 'p-3 flex items-start gap-3';
    li.dataset.eventId = ev.id;

    const whenText = timeRangeText(ev);
    li.innerHTML = `
      <div class="shrink-0 mt-1">üìÖ</div>
      <div class="grow">
        <div class="font-medium">${ev.title || '(Untitled)'}</div>
        <div class="text-sm text-gray-600">${whenText}</div>
        ${ev.extendedProps?.location ? `<div class="text-xs text-gray-500">Location: ${ev.extendedProps.location}</div>` : ''}
        ${ev.extendedProps?.assignee ? `<div class="text-xs text-gray-500">Assignee: ${ev.extendedProps.assignee}</div>` : ''}
      </div>
      <button class="ml-auto inline-flex items-center gap-1 px-2 py-1 rounded-md border text-gray-500 hover:text-green-600 hover:border-green-300 transition" title="Mark complete">
        <svg class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
          <path fill-rule="evenodd" d="M10 18a8 8 0 1 0 0-16 8 8 0 0 0 0 16Zm3.707-9.707a1 1 0 0 0-1.414-1.414L9 10.172 7.707 8.879a1 1 0 0 0-1.414 1.414l2 2a1 1 0 0 0 1.414 0l4-4Z" clip-rule="evenodd"/>
        </svg>
        <span class="text-xs">Done</span>
      </button>
    `;

    li.querySelector('button').addEventListener('click', async () => {
      const rawStart = ev.occurrenceStart || ev.start;
      const iso = new Date(rawStart).toISOString();
      const day = iso.slice(0,10);

      doneSet.add(doneKey(ev.id, iso));
      doneSet.add(doneKey(ev.id, day));
      saveDoneSet(doneSet);

      await apiMarkDone(ev.id, rawStart);

      li.remove();
      ensureEmptyState();

      if (window.markCalendarEventDone) window.markCalendarEventDone(ev.id, rawStart);
      if (window.dispatchEvent) window.dispatchEvent(new Event('calendar:refresh'));
    });

    list.appendChild(li);
  }

  async function loadToday() {
    const { start, end, label } = todayRangeISO();
    subtitle.textContent = `Today ‚Ä¢ ${label}`;

    try {
      const qs = new URLSearchParams({ start, end });
      const res = await fetch(`/calendar/api/events?${qs.toString()}`);
      const data = await res.json();

      const tasks = (data || []).filter(ev => {
        const ep = ev.extendedProps || {};
        const raw = ev.occurrenceStart || ev.start;
        const iso = new Date(raw).toISOString();
        const day = iso.slice(0,10);

        const serverList = Array.isArray(ep.completedOn) ? ep.completedOn
                         : Array.isArray(ep.completed_on) ? ep.completed_on
                         : [];
        const serverDone = !!ep.completed
                        || serverList.includes(iso)
                        || serverList.some(s => typeof s === 'string' && s.slice(0,10) === day);

        const localDone  = doneSet.has(doneKey(ev.id, iso)) || doneSet.has(doneKey(ev.id, day));

        return !(serverDone || localDone);
      });

      tasks.sort((a,b) => new Date(a.start) - new Date(b.start));
      list.innerHTML = '';
      tasks.forEach(renderTask);
      ensureEmptyState();
    } catch (e) {
      console.error('Failed to load today tasks', e);
      list.innerHTML = '';
      ensureEmptyState();
    }
  }

  async function pollToasts() {
    try {
      const res = await fetch('/calendar/api/alarms?within=60&grace=5&include_events=1&fallback_events=0&limit=25');
      const items = await res.json();
      (items || []).forEach(item => {
        const when = new Date(item.when).toLocaleString();
        toast(item.title, `${item.kind === 'reminder' ? 'Reminder' : 'Starts soon'} ‚Ä¢ ${when}`);
      });
    } catch (e) { /* no-op */ }
  }

  loadToday();
  setInterval(loadToday, 60000);
  setInterval(pollToasts, 30000);
})();
</script>

{% endblock %}
