{% extends "base.html" %}

{% block content %}
<div class="container mx-auto p-6">
  <!-- Quick Actions (unchanged)... -->

  <!-- Notifications (Today) -->
  <div id="home-notifications" class="mt-8">
    <div class="flex items-center justify-between">
      <h2 class="text-lg font-semibold">Notifications</h2>
      <div id="notif-subtitle" class="text-xs text-gray-500">Today</div>
    </div>
    <ul id="notif-list" class="divide-y rounded-xl border bg-white mt-2"></ul>
  </div>
</div>

<!-- Toast root -->
<div id="toast-root" class="fixed right-4 bottom-4 space-y-2 z-50 pointer-events-none"></div>

<script>
(function() {
  const list = document.getElementById('notif-list');
  const subtitle = document.getElementById('notif-subtitle');
  const toastRoot = document.getElementById('toast-root');

  // ===== Local "Done" persistence =====
  const DONE_STORE_KEY = 'fc_done_occurrences_v1';
  function loadDoneSet() {
    try { return new Set(JSON.parse(localStorage.getItem(DONE_STORE_KEY) || '')) }
    catch { return new Set(); }
  }
  function saveDoneSet(set) {
    try { localStorage.setItem(DONE_STORE_KEY, JSON.stringify([...set])); } catch {}
  }
  const doneSet = loadDoneSet();
  const doneKey = (id, token) => `${String(id)}|${token}`; // token = ISO or YYYY-MM-DD

  // ===== Helpers =====
  function todayRangeISO() {
    const start = new Date(); start.setHours(0,0,0,0);
    const end = new Date();   end.setHours(23,59,59,999);
    return { start: start.toISOString(), end: end.toISOString(), label: start.toLocaleDateString() };
  }
  function ensureEmptyState() {
    if (list.childElementCount === 0) {
      const li = document.createElement('li');
      li.className = 'p-4 text-sm text-gray-500';
      li.textContent = 'No tasks scheduled for today.';
      list.appendChild(li);
    }
  }
  function timeRangeText(ev) {
    if (ev.allDay) return 'All day';
    const s = new Date(ev.start);
    const e = ev.end ? new Date(ev.end) : null;
    const fmt = (d) => d.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
    return e ? `${fmt(s)} ‚Äì ${fmt(e)}` : fmt(s);
  }
  function toast(title, body) {
    const el = document.createElement('div');
    el.className = 'pointer-events-auto bg-gray-900 text-white rounded-xl shadow px-4 py-3 max-w-sm';
    el.innerHTML = `<div class="font-semibold">‚è∞ ${title}</div>
                    <div class="text-sm opacity-80">${body || ''}</div>`;
    toastRoot.appendChild(el);
    setTimeout(() => el.remove(), 6000);
  }

  // ===== API helper: mark done on server if available =====
  async function apiMarkDone(id, occurrenceStart) {
    try {
      const url = occurrenceStart
        ? `/calendar/api/events/${id}:${encodeURIComponent(occurrenceStart)}`
        : `/calendar/api/events/${id}`;
      const res = await fetch(url, {
        method: 'PATCH',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ completed: true, occurrenceStart: occurrenceStart || null })
      });
      if (res.ok) return true;

      const res2 = await fetch(`/calendar/api/events/${id}/complete`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ completed: true, occurrenceStart: occurrenceStart || null })
      });
      return res2.ok;
    } catch (_e) { return false; }
  }

  // ===== Render one notification row =====
  function renderTask(ev) {
    const li = document.createElement('li');
    li.className = 'p-3 flex items-start gap-3';
    li.dataset.eventId = ev.id;

    const whenText = timeRangeText(ev);
    li.innerHTML = `
      <div class="shrink-0 mt-1">üìÖ</div>
      <div class="grow">
        <div class="font-medium">${ev.title || '(Untitled)'}</div>
        <div class="text-sm text-gray-600">${whenText}</div>
        ${ev.extendedProps?.location ? `<div class="text-xs text-gray-500">Location: ${ev.extendedProps.location}</div>` : ''}
        ${ev.extendedProps?.assignee ? `<div class="text-xs text-gray-500">Assignee: ${ev.extendedProps.assignee}</div>` : ''}
      </div>
      <button class="ml-auto inline-flex items-center gap-1 px-2 py-1 rounded-md border text-gray-500 hover:text-green-600 hover:border-green-300 transition"
              title="Mark complete">
        <svg class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
          <path fill-rule="evenodd" d="M10 18a8 8 0 1 0 0-16 8 8 0 0 0 0 16Zm3.707-9.707a1 1 0 0 0-1.414-1.414L9 10.172 7.707 8.879a1 1 0 0 0-1.414 1.414l2 2a1 1 0 0 0 1.414 0l4-4Z" clip-rule="evenodd"/>
        </svg>
        <span class="text-xs">Done</span>
      </button>
    `;

    li.querySelector('button').addEventListener('click', async () => {
      // Normalize to ISO + also save day token (YYYY-MM-DD)
      const rawStart = ev.occurrenceStart || ev.start;
      const iso = new Date(rawStart).toISOString();
      const day = iso.slice(0,10);

      // 1) persist locally (both keys so Calendar can always match)
      doneSet.add(doneKey(ev.id, iso));
      doneSet.add(doneKey(ev.id, day));
      saveDoneSet(doneSet);

      // 2) best-effort server persist
      await apiMarkDone(ev.id, rawStart);

      // 3) update UI
      li.remove();
      ensureEmptyState();

      // 4) tell Calendar (if open) to flip to green now
      if (window.markCalendarEventDone) window.markCalendarEventDone(ev.id, rawStart);
      if (window.dispatchEvent) window.dispatchEvent(new Event('calendar:refresh'));
    });

    list.appendChild(li);
  }

  // ===== Load today's notifications =====
  async function loadToday() {
    const { start, end, label } = todayRangeISO();
    subtitle.textContent = `Today ‚Ä¢ ${label}`;

    try {
      const qs = new URLSearchParams({ start, end });
      const res = await fetch(`/calendar/api/events?${qs.toString()}`);
      const data = await res.json();

      const tasks = (data || []).filter(ev => {
        const ep = ev.extendedProps || {};
        const raw = ev.occurrenceStart || ev.start;
        const iso = new Date(raw).toISOString();
        const day = iso.slice(0,10);

        // server flags
        const serverList = Array.isArray(ep.completedOn) ? ep.completedOn
                         : Array.isArray(ep.completed_on) ? ep.completed_on
                         : [];
        const serverDone = !!ep.completed
                        || serverList.includes(iso)
                        || serverList.some(s => typeof s === 'string' && s.slice(0,10) === day);

        // local flags (exact or day)
        const localDone  = doneSet.has(doneKey(ev.id, iso)) || doneSet.has(doneKey(ev.id, day));

        return !(serverDone || localDone);
      });

      tasks.sort((a,b) => new Date(a.start) - new Date(b.start));
      list.innerHTML = '';
      tasks.forEach(renderTask);
      ensureEmptyState();
    } catch (e) {
      console.error('Failed to load today tasks', e);
      list.innerHTML = '';
      ensureEmptyState();
    }
  }

  // Optional: upcoming toasts
  async function pollToasts() {
    try {
      const res = await fetch('/calendar/api/alarms?within=60&grace=5&include_events=1&fallback_events=0&limit=25');
      const items = await res.json();
      (items || []).forEach(item => {
        const when = new Date(item.when).toLocaleString();
        toast(item.title, `${item.kind === 'reminder' ? 'Reminder' : 'Starts soon'} ‚Ä¢ ${when}`);
      });
    } catch (e) { /* no-op */ }
  }

  loadToday();
  setInterval(loadToday, 60000);
  setInterval(pollToasts, 30000);
})();
</script>

{% endblock %}
