{# ‚îÄ‚îÄ‚îÄ templates/charts/_header_table.html (revised) ‚îÄ‚îÄ‚îÄ #}

{# Safe access #}
{% set prof = sheets.get('profile') or {'data': []} %}
{% set data = prof.data or [] %}
{% set pdata = data %}

{# Pull the first four rows for goals/weights (same as before) #}
{% set row0 = data[0] if data|length > 0 else {} %}
{% set row1 = data[1] if data|length > 1 else {} %}
{% set row2 = data[2] if data|length > 2 else {} %}
{% set row3 = data[3] if data|length > 3 else {} %}

{% set goals         = row0.get('Value','') %}
{% set init_date     = row1.get('Date','') %}
{% set init_weight   = row1.get('Weight','') %}
{% set lowest_date   = row2.get('Date','') %}
{% set lowest_weight = row2.get('Weight','') %}
{% set target_date   = row3.get('Date','') %}
{% set target_weight = row3.get('Weight','') %}

{# Normalize month keys: first item = canonical key stored in DB (no dot),
   second item = label that may appear in old data/render ("Jan." etc). #}
{% set months = [
  ('Jan','Jan.'), ('Feb','Feb.'), ('Mar','Mar.'), ('Apr','Apr.'),
  ('May','May'), ('June','June'), ('July','July'),
  ('Aug','Aug.'), ('Sept','Sept.'), ('Oct','Oct.'), ('Nov','Nov.'), ('Dec','Dec.')
] %}

{# Frequency row is whatever row has Field == 'Frequency' #}
{% set freq_row = (data | selectattr('Field','equalto','Frequency') | list | first) or {} %}

{# Session details with fallback label for First Session #}
{% set exp_row = (data | selectattr('Field','equalto','Expiration / Remaining') | list | first) or {} %}
{% set expiration = exp_row.get('Value','') %}

{# Accept either legacy "First Session Date (Current Package)" or new "First Session Date" #}
{% set ls_row =
  (data | selectattr('Field','equalto','First Session Date') | list | first)
  or
  (data | selectattr('Field','equalto','First Session Date (Current Package)') | list | first)
  or {}
%}
{% set last_session = ls_row.get('Value','') %}

{# ‚îÄ‚îÄ‚îÄ Read existing Nutrition/Focus flags ‚îÄ‚îÄ‚îÄ #}
{% set qf_nutrition = (pdata | selectattr('Field','equalto','Nutrition Flag') | list | first) or {} %}
{% set qf_focus     = (pdata | selectattr('Field','equalto','Focus Case Flag') | list | first) or {} %}
{% set nutri_on     = (qf_nutrition.get('Flag', False) and qf_nutrition.get('Flag') != 'No') %}
{% set focus_on     = (qf_focus.get('Flag', False) and qf_focus.get('Flag') != 'No') %}

<style>
  details summary { list-style: none; cursor: pointer; }
  details summary::-webkit-details-marker, details summary::marker { display: none; }

  /* Tiny flair for the quick-flag buttons */
  .flag-btn { transition: transform .05s ease, box-shadow .2s ease; }
  .flag-btn:hover { transform: translateY(-1px); }
  .flag-btn.on { box-shadow: 0 6px 18px rgba(236,72,153,.35); }
</style>

<div class="space-y-6">
  <details open class="bg-white rounded-lg shadow transition-colors duration-200">
    <summary class="px-6 py-4 text-lg font-semibold bg-pink-100 hover:bg-pink-200">
      Client Profile
    </summary>

    <div class="px-6 pb-6 space-y-6 border-t border-gray-200">

      {# ‚îÄ‚îÄ‚îÄ NEW: Quick Flags row (small icons) ‚îÄ‚îÄ‚îÄ #}
      <div class="mt-2">
        <div class="flex items-center gap-3 flex-wrap">

          <!-- Nutrition Flag -->
          <div class="flag-group inline-flex items-center gap-2">
            <button
              type="button"
              class="flag-btn inline-flex items-center gap-2 px-3 py-1 rounded-full border text-sm
                     {% if nutri_on %} bg-pink-600 border-pink-700 text-white on {% else %}
                     bg-gray-100 border-gray-300 text-gray-800 hover:bg-gray-200 {% endif %}">
              <span class="text-base leading-none">üçé</span>
              <span class="font-medium">Nutrition</span>
            </button>
            <input type="checkbox" name="flag_nutrition" class="sr-only" {% if nutri_on %}checked{% endif %}/>
          </div>

          <!-- Focus Case Flag -->
          <div class="flag-group inline-flex items-center gap-2">
            <button
              type="button"
              class="flag-btn inline-flex items-center gap-2 px-3 py-1 rounded-full border text-sm
                     {% if focus_on %} bg-pink-600 border-pink-700 text-white on {% else %}
                     bg-gray-100 border-gray-300 text-gray-800 hover:bg-gray-200 {% endif %}">
              <span class="text-base leading-none">üéØ</span>
              <span class="font-medium">Focus Case</span>
            </button>
            <input type="checkbox" name="flag_focus_case" class="sr-only" {% if focus_on %}checked{% endif %}/>
          </div>

        </div>
      </div>
      {# ‚îÄ‚îÄ‚îÄ END Quick Flags ‚îÄ‚îÄ‚îÄ #}

      {# ‚îÄ‚îÄ‚îÄ Goals ‚îÄ‚îÄ‚îÄ #}
      <div class="flex items-center space-x-4 mt-2">
        <span class="font-medium w-1/4">Goals:</span>
        <textarea name="goals" class="w-80 h-16 border border-gray-300 rounded px-2 py-4 resize-none">{{ goals }}</textarea>
      </div>

      {# ‚îÄ‚îÄ‚îÄ Weights (Initial / Lowest / Target) ‚îÄ‚îÄ‚îÄ #}
      <div class="space-y-4">
        <div class="flex items-center space-x-4">
          <span class="font-medium w-1/4">Initial Weight</span>
          <input type="date" name="init_date"    value="{{ init_date }}"   class="w-48 border rounded px-2 py-1"/>
          <input type="text" name="init_weight"  value="{{ init_weight }}" class="w-32 border rounded px-2 py-1" placeholder="Weight"/>
        </div>
        <div class="flex items-center space-x-4">
          <span class="font-medium w-1/4">Lowest Weight</span>
          <input type="date" name="lowest_date"  value="{{ lowest_date }}" class="w-48 border rounded px-2 py-1"/>
          <input type="text" name="lowest_weight" value="{{ lowest_weight }}" class="w-32 border rounded px-2 py-1" placeholder="Weight"/>
        </div>
        <div class="flex items-center space-x-4">
          <span class="font-medium w-1/4">Target Weight</span>
          <input type="date" name="target_date"  value="{{ target_date }}" class="w-48 border rounded px-2 py-1"/>
          <input type="text" name="target_weight" value="{{ target_weight }}" class="w-32 border rounded px-2 py-1" placeholder="Weight"/>
        </div>
      </div>

      {# ‚îÄ‚îÄ‚îÄ Frequency Table (labels with dots; keys without dots) ‚îÄ‚îÄ‚îÄ #}
      <div class="overflow-x-auto">
        <table id="frequency-table" class="min-w-full border-collapse text-sm text-center">
          <caption class="text-lg font-semibold mb-2">Frequency</caption>
          <thead class="bg-gray-100 font-semibold">
            <tr>
              {% for short,label in months %}
                <th class="border px-2 py-1">{{ label }}</th>
              {% endfor %}
            </tr>
          </thead>
          <tbody>
            <tr>
              {% for short,label in months %}
                {# read back either normalized ('Sept') or legacy dotted ('Sept.') #}
                {% set cell_val = freq_row.get(short) or freq_row.get(label) or '' %}
                <td class="border px-2 py-2"
                    data-month="{{ short }}"
                    contenteditable="true">{{ cell_val }}</td>
              {% endfor %}
            </tr>
          </tbody>
        </table>
      </div>

      {# Session Details #}
      <div class="space-y-4">
        <div class="flex items-center space-x-4">
          <span class="font-medium w-1/4">Expiration / Remaining</span>
          <input
            type="text"
            name="expiration"
            value="{{ expiration }}"
            class="w-48 border border-gray-300 rounded px-2 py-1"
          />
        </div>
        <div class="flex items-center space-x-4">
          <span class="font-medium w-1/4">First Session Date</span>
          <input
            type="date"
            name="last_session"
            value="{{ last_session }}"
            class="w-48 border border-gray-300 rounded px-2 py-1"
          />
        </div>
      </div>

    </div>
  </details>
</div>


{# ‚îÄ‚îÄ‚îÄ Health / Injuries ‚îÄ‚îÄ‚îÄ #}
{% set row_diabetes        = (pdata | selectattr('Field','equalto','Diabetes') | list | first) or {} %}
{% set row_bp              = (pdata | selectattr('Field','equalto','Blood Pressure Issues') | list | first) or {} %}
{% set row_vertigo         = (pdata | selectattr('Field','equalto','Dizziness / Vertigo') | list | first) or {} %}
{% set row_thyroid         = (pdata | selectattr('Field','equalto','Thyroid Imbalances') | list | first) or {} %}
{% set row_heart           = (pdata | selectattr('Field','equalto','Heart Disease') | list | first) or {} %}
{% set row_spine           = (pdata | selectattr('Field','equalto','Back / Neck Issues') | list | first) or {} %}
{% set row_hips            = (pdata | selectattr('Field','equalto','Hips Issues') | list | first) or {} %}
{% set row_legs            = (pdata | selectattr('Field','equalto','Legs Issues') | list | first) or {} %}
{% set row_arms            = (pdata | selectattr('Field','equalto','Arms Issues') | list | first) or {} %}
{% set row_vascular        = (pdata | selectattr('Field','equalto','Vascular Pathologies') | list | first) or {} %}
{% set row_irregular       = (pdata | selectattr('Field','equalto','Irregular Menstrual Period / Hormonal Issues') | list | first) or {} %}
{% set row_menopause       = (pdata | selectattr('Field','equalto','Menopause ‚Äì # of Years') | list | first) or {} %}
{% set row_blood_work      = (pdata | selectattr('Field','equalto','Blood Work Alterations') | list | first) or {} %}

{% set comment_diabetes    = row_diabetes.get('Comment','') %}
{% set flag_diabetes       = row_diabetes.get('Flag', False) %}

{% set flag_bp             = row_bp.get('Flag', False) %}
{% set flag_vertigo        = row_vertigo.get('Flag', False) %}
{% set flag_thyroid        = row_thyroid.get('Flag', False) %}

{% set comment_heart       = row_heart.get('Comment','') %}
{% set flag_heart          = row_heart.get('Flag', False) %}

{% set comment_spine       = row_spine.get('Comment','') %}
{% set flag_spine          = row_spine.get('Flag', False) %}

{% set comment_hips        = row_hips.get('Comment','') %}
{% set flag_hips           = row_hips.get('Flag', False) %}

{% set comment_legs        = row_legs.get('Comment','') %}
{% set flag_legs           = row_legs.get('Flag', False) %}

{% set comment_arms        = row_arms.get('Comment','') %}
{% set flag_arms           = row_arms.get('Flag', False) %}

{% set comment_vascular    = row_vascular.get('Comment','') %}
{% set flag_vascular       = row_vascular.get('Flag', False) %}

{% set flag_irregular_period    = row_irregular.get('Flag', False) %}

{% set comment_menopause_years  = row_menopause.get('Comment','') %}
{% set flag_menopause_years     = row_menopause.get('Flag', False) %}

{% set flag_blood_work     = row_blood_work.get('Flag', False) %}

<details open class="bg-white rounded-lg shadow transition-colors duration-200">
  <summary class="px-6 py-4 text-lg font-semibold bg-pink-100 hover:bg-pink-200">
    Health / Injuries
  </summary>
  <div class="px-6 pt-4 pb-8 border-t border-pink-200 min-h-[300px]">
    <p class="text-sm text-gray-600 mb-4">
      Figurella has no contradictions; we ask about your medical values to improve your experience.
    </p>

    <div class="grid grid-cols-2 gap-8">
      <!-- Left column -->
      <ul class="list-none space-y-2">
        <!-- Diabetes -->
        <li class="flex items-center space-x-2">
          <input
            type="text"
            name="comment_diabetes"
            value="{{ comment_diabetes }}"
            placeholder="Comment"
            class="w-24 border border-gray-300 rounded px-2 py-1"
          />
          <label class="inline-flex items-center">
            <input
              type="checkbox"
              name="flag_diabetes"
              class="form-checkbox h-5 w-5 text-pink-600"
              {% if flag_diabetes and flag_diabetes != 'No' %}checked{% endif %}
            />
            <span class="ml-2">Diabetes</span>
          </label>
        </li>

        <!-- Blood Pressure Issues -->
        <li class="flex items-center space-x-2">
          <span class="w-24"></span>
          <label class="inline-flex items-center">
            <input
              type="checkbox"
              name="flag_bp"
              class="form-checkbox h-5 w-5 text-pink-600"
              {% if flag_bp and flag_bp != 'No' %}checked{% endif %}
            />
            <span class="ml-2">Blood Pressure Issues</span>
          </label>
        </li>

        <!-- Dizziness / Vertigo -->
        <li class="flex items-center space-x-2">
          <span class="w-24"></span>
          <label class="inline-flex items-center">
            <input
              type="checkbox"
              name="flag_vertigo"
              class="form-checkbox h-5 w-5 text-pink-600"
              {% if flag_vertigo and flag_vertigo != 'No' %}checked{% endif %}
            />
            <span class="ml-2">Dizziness / Vertigo</span>
          </label>
        </li>

        <!-- Thyroid Imbalances -->
        <li class="flex items-center space-x-2">
          <span class="w-24"></span>
          <label class="inline-flex items-center">
            <input
              type="checkbox"
              name="flag_thyroid"
              class="form-checkbox h-5 w-5 text-pink-600"
              {% if flag_thyroid and flag_thyroid != 'No' %}checked{% endif %}
            />
            <span class="ml-2">Thyroid Imbalances</span>
          </label>
        </li>

        <!-- Heart Disease -->
        <li class="flex items-center space-x-2">
          <input
            type="text"
            name="comment_heart"
            value="{{ comment_heart }}"
            placeholder="Comment"
            class="w-24 border border-gray-300 rounded px-2 py-1"
          />
          <label class="inline-flex items-center">
            <input
              type="checkbox"
              name="flag_heart"
              class="form-checkbox h-5 w-5 text-pink-600"
              {% if flag_heart and flag_heart != 'No' %}checked{% endif %}
            />
            <span class="ml-2">Heart Disease</span>
          </label>
        </li>

        <!-- Back / Neck Issues -->
        <li class="flex items-center space-x-2">
          <input
            type="text"
            name="comment_spine"
            value="{{ comment_spine }}"
            placeholder="Comment"
            class="w-24 border border-gray-300 rounded px-2 py-1"
          />
          <label class="inline-flex items-center">
            <input
              type="checkbox"
              name="flag_spine"
              class="form-checkbox h-5 w-5 text-pink-600"
              {% if flag_spine and flag_spine != 'No' %}checked{% endif %}
            />
            <span class="ml-2">Back / Neck Issues</span>
          </label>
        </li>

        <!-- Hips Issues -->
        <li class="flex items-center space-x-2">
          <input
            type="text"
            name="comment_hips"
            value="{{ comment_hips }}"
            placeholder="Comment"
            class="w-24 border border-gray-300 rounded px-2 py-1"
          />
          <label class="inline-flex items-center">
            <input
              type="checkbox"
              name="flag_hips"
              class="form-checkbox h-5 w-5 text-pink-600"
              {% if flag_hips and flag_hips != 'No' %}checked{% endif %}
            />
            <span class="ml-2">Hips Issues</span>
          </label>
        </li>

        <!-- Legs Issues -->
        <li class="flex items-center space-x-2">
          <input
            type="text"
            name="comment_legs"
            value="{{ comment_legs }}"
            placeholder="Comment"
            class="w-24 border border-gray-300 rounded px-2 py-1"
          />
          <label class="inline-flex items-center">
            <input
              type="checkbox"
              name="flag_legs"
              class="form-checkbox h-5 w-5 text-pink-600"
              {% if flag_legs and flag_legs != 'No' %}checked{% endif %}
            />
            <span class="ml-2">Legs Issues</span>
          </label>
        </li>

        <!-- Arms Issues -->
        <li class="flex items-center space-x-2">
          <input
            type="text"
            name="comment_arms"
            value="{{ comment_arms }}"
            placeholder="Comment"
            class="w-24 border border-gray-300 rounded px-2 py-1"
          />
          <label class="inline-flex items-center">
            <input
              type="checkbox"
              name="flag_arms"
              class="form-checkbox h-5 w-5 text-pink-600"
              {% if flag_arms and flag_arms != 'No' %}checked{% endif %}
            />
            <span class="ml-2">Arms Issues</span>
          </label>
        </li>
      </ul>

      <!-- Right column -->
      <ul class="list-none space-y-2">
        <!-- Vascular Pathologies -->
        <li class="flex items-center space-x-2">
          <input
            type="text"
            name="comment_vascular"
            value="{{ comment_vascular }}"
            placeholder="Comment"
            class="w-24 border border-gray-300 rounded px-2 py-1"
          />
          <label class="inline-flex items-center">
            <input
              type="checkbox"
              name="flag_vascular"
              class="form-checkbox h-5 w-5 text-pink-600"
              {% if flag_vascular and flag_vascular != 'No' %}checked{% endif %}
            />
            <span class="ml-2">Vascular Pathologies</span>
          </label>
        </li>

        <!-- Irregular Menstrual Period / Hormonal Issues -->
        <li class="flex items-center space-x-2">
          <span class="w-24"></span>
          <label class="inline-flex items-center">
            <input
              type="checkbox"
              name="flag_irregular_period"
              class="form-checkbox h-5 w-5 text-pink-600"
              {% if flag_irregular_period and flag_irregular_period != 'No' %}checked{% endif %}
            />
            <span class="ml-2">Irregular Menstrual Period / Hormonal Issues</span>
          </label>
        </li>

        <!-- Menopause ‚Äì # of Years -->
        <li class="flex items-center space-x-2">
          <input
            type="text"
            name="comment_menopause_years"
            value="{{ comment_menopause_years }}"
            placeholder="Comment"
            class="w-24 border border-gray-300 rounded px-2 py-1"
          />
          <label class="inline-flex items-center">
            <input
              type="checkbox"
              name="flag_menopause_years"
              class="form-checkbox h-5 w-5 text-pink-600"
              {% if flag_menopause_years and flag_menopause_years != 'No' %}checked{% endif %}
            />
            <span class="ml-2">Menopause ‚Äì # of Years</span>
          </label>
        </li>

        <!-- Blood Work Alterations -->
        <li class="flex items-center space-x-2">
          <span class="w-24"></span>
          <label class="inline-flex items-center">
            <input
              type="checkbox"
              name="flag_blood_work"
              class="form-checkbox h-5 w-5 text-pink-600"
              {% if flag_blood_work and flag_blood_work != 'No' %}checked{% endif %}
            />
            <span class="ml-2">Blood Work Alterations</span>
          </label>
        </li>
      </ul>
    </div>
  </div>
</details>


{# ‚îÄ‚îÄ‚îÄ Rewards / Deals ‚îÄ‚îÄ‚îÄ #}

{# Only the actual rows (Field == 'Reward / Deal') render here; we ignore the header row 'Rewards / Deals' #}
{% set reward_rows  = pdata | selectattr('Field','equalto','Reward / Deal') | list %}

<script>
function addRewardRow() {
  const tbody  = document.querySelector('#rewards-table tbody');
  const newRow = document.createElement('tr');
  const idx    = tbody.rows.length;
  if ((idx + 1) % 2 === 0) newRow.classList.add('bg-gray-50');
  newRow.innerHTML = `
    <td class="border px-2 py-1 text-center">
      <input type="checkbox" name="used[]" class="form-checkbox h-4 w-4 accent-pink-600"/>
    </td>
    <td class="border px-2 py-1" contenteditable="true">&nbsp;</td>
    <td class="border px-2 py-1" contenteditable="true">&nbsp;</td>
  `;
  tbody.appendChild(newRow);
  newRow.scrollIntoView({ block: 'nearest' });
}
</script>

<style>
  #rewards-table tbody tr:nth-child(even) {
    background-color: rgba(243, 244, 246, 1); /* bg-gray-50 */
  }
</style>

<template id="reward-row-template">
  <tr>
    <td class="border px-2 py-1 text-center">
      <input type="checkbox" name="used[]" class="form-checkbox h-4 w-4 accent-pink-600"/>
    </td>
    <td class="border px-2 py-1" contenteditable="true">&nbsp;</td>
    <td class="border px-2 py-1" contenteditable="true">&nbsp;</td>
  </tr>
</template>

<details open class="bg-white rounded-lg shadow transition-colors duration-200">
  <summary class="px-6 py-4 text-lg font-semibold bg-pink-100 hover:bg-pink-200">
    Rewards / Deals
  </summary>
  <div class="px-6 pb-6 border-t border-gray-200">
    <table id="rewards-table" class="table-auto w-full border-collapse text-sm">
      <colgroup>
        <col style="width:1%; white-space:nowrap;" />
        <col />
        <col />
      </colgroup>
      <thead class="bg-gray-100 font-semibold text-gray-700">
        <tr>
          <th class="border px-2 py-1 text-center">Used</th>
          <th class="border px-2 py-1">Reward / Deal</th>
          <th class="border px-2 py-1">Notes</th>
        </tr>
      </thead>
      <tbody>
        {% if reward_rows %}
          {% for row in reward_rows %}
            <tr class="{% if loop.index0 is even %}bg-gray-50{% endif %}">
              <td class="border px-2 py-1 text-center">
                <input
                  type="checkbox"
                  name="used[]"
                  class="form-checkbox h-4 w-4 accent-pink-600"
                  {% if row.get('Used') and row.get('Used') != 'No' %}checked{% endif %}
                />
              </td>
              <td class="border px-2 py-1" contenteditable="true">{{ row.get('RewardDeal','') }}</td>
              <td class="border px-2 py-1" contenteditable="true">{{ row.get('RewardNotes','') }}</td>
            </tr>
          {% endfor %}
        {% else %}
          {% for i in range(4) %}
            <tr class="{% if i is even %}bg-gray-50{% endif %}">
              <td class="border px-2 py-1 text-center">
                <input type="checkbox" name="used[]" class="form-checkbox h-4 w-4 accent-pink-600"/>
              </td>
              <td class="border px-2 py-1" contenteditable="true">&nbsp;</td>
              <td class="border px-2 py-1" contenteditable="true">&nbsp;</td>
            </tr>
          {% endfor %}
        {% endif %}
      </tbody>
    </table>

    <button
      type="button"
      onclick="addRewardRow()"
      class="mt-3 px-4 py-1 bg-pink-600 text-white rounded hover:bg-pink-700 transition"
    >
      + Add Row
    </button>
  </div>
</details>


{# ‚îÄ‚îÄ‚îÄ Friends ‚îÄ‚îÄ‚îÄ #}
{% set friend_rows  = pdata | selectattr('Field','equalto','Friend') | list %}

<script>
function addFriendRow() {
  const table    = document.getElementById('friends-table');
  const tbody    = table.querySelector('tbody');
  const rowCount = tbody.rows.length;
  const newRow   = document.createElement('tr');
  if ((rowCount + 1) % 2 === 0) newRow.classList.add('bg-gray-50');
  newRow.innerHTML = `
    <td class="border px-2 py-1 text-center">
      <input type="checkbox" name="friend-selected[]" class="form-checkbox h-4 w-4 accent-pink-600"/>
    </td>
    <td class="border px-2 py-1" contenteditable="true">&nbsp;</td>
    <td class="border px-2 py-1" contenteditable="true">&nbsp;</td>
  `;
  tbody.appendChild(newRow);
  newRow.scrollIntoView({ block: 'nearest' });
}
</script>

<style>
  #friends-table tbody tr:nth-child(even) {
    background-color: rgba(243, 244, 246, 1); /* bg-gray-50 */
  }
</style>

<template id="friend-row-template">
  <tr>
    <td class="border px-2 py-1 text-center">
      <input type="checkbox" name="friend-selected[]" class="form-checkbox h-4 w-4 accent-pink-600"/>
    </td>
    <td class="border px-2 py-1" contenteditable="true">&nbsp;</td>
    <td class="border px-2 py-1" contenteditable="true">&nbsp;</td>
  </tr>
</template>

<details open class="bg-white rounded-lg shadow transition-colors duration-200">
  <summary class="px-6 py-4 text-lg font-semibold bg-pink-100 hover:bg-pink-200">
    Friends
  </summary>
  <div class="px-6 pb-6 border-t border-gray-200">
    <table id="friends-table" class="table-auto w-full border-collapse text-sm">
      <colgroup>
        <col style="width:1%; white-space:nowrap;" />
        <col />
        <col />
      </colgroup>
      <thead class="bg-gray-100 font-semibold text-gray-700">
        <tr>
          <th class="border px-2 py-1 text-center">Select</th>
          <th class="border px-2 py-1">Name</th>
          <th class="border px-2 py-1">Notes</th>
        </tr>
      </thead>
      <tbody>
        {% if friend_rows %}
          {% for row in friend_rows %}
            <tr class="{% if loop.index0 is even %}bg-gray-50{% endif %}">
              <td class="border px-2 py-1 text-center">
                <input
                  type="checkbox"
                  name="friend-selected[]"
                  class="form-checkbox h-4 w-4 accent-pink-600"
                  {% if row.get('Select') and row.get('Select') != 'No' %}checked{% endif %}
                />
              </td>
              <td class="border px-2 py-1" contenteditable="true">{{ row.get('FriendName','') }}</td>
              <td class="border px-2 py-1" contenteditable="true">{{ row.get('FriendNotes','') }}</td>
            </tr>
          {% endfor %}
        {% else %}
          {% for i in range(4) %}
            <tr class="{% if i is even %}bg-gray-50{% endif %}">
              <td class="border px-2 py-1 text-center">
                <input type="checkbox" name="friend-selected[]" class="form-checkbox h-4 w-4 accent-pink-600"/>
              </td>
              <td class="border px-2 py-1" contenteditable="true">&nbsp;</td>
              <td class="border px-2 py-1" contenteditable="true">&nbsp;</td>
            </tr>
          {% endfor %}
        {% endif %}
      </tbody>
    </table>

    <button
      type="button"
      onclick="addFriendRow()"
      class="mt-3 px-4 py-1 bg-pink-600 text-white rounded hover:bg-pink-700 transition"
    >
      + Add Row
    </button>
  </div>
</details>

<script>
/* ------------------------------------------------------------------
   Quick Flag buttons ‚Üî checkboxes (scoped, minimal, autosave-friendly)
------------------------------------------------------------------- */
(function () {
  const scope = document.currentScript.closest('.space-y-6') || document;
  scope.querySelectorAll('.flag-group').forEach(group=>{
    const btn = group.querySelector('.flag-btn');
    const cb  = group.querySelector('input[type="checkbox"]');
    if (!btn || !cb) return;

    function sync(){
      btn.classList.toggle('on', cb.checked);
      btn.classList.toggle('bg-pink-600', cb.checked);
      btn.classList.toggle('border-pink-700', cb.checked);
      btn.classList.toggle('text-white', cb.checked);
      btn.classList.toggle('bg-gray-100', !cb.checked);
      btn.classList.toggle('border-gray-300', !cb.checked);
      btn.classList.toggle('text-gray-800', !cb.checked);
    }
    sync();

    btn.addEventListener('click', ()=>{
      cb.checked = !cb.checked;
      sync();
      // notify any outside listeners and autosave
      cb.dispatchEvent(new Event('change', { bubbles:true }));
      btn.closest('.chart-card')?.__saveDebounced?.();
    });
  });
})();

/* ------------------------------------------------------------------
   Collector for the Profile sheet (kept for compatibility)
   Adds Nutrition/Focus flags so other callers (if any) persist them.
------------------------------------------------------------------- */
(function () {
  function txt(el) {
    const v = (el && (el.value ?? el.textContent)) || '';
    return String(v).replace(/\u00a0/g, ' ').trim();
  }
  function yesNo(checked) { return checked ? 'Yes' : 'No'; }

  window.collectProfile = function collectProfile() {
    const rows = [];

    // Goals
    const goals = txt(document.querySelector('textarea[name="goals"]'));
    rows.push({ Field: 'Goals', Value: goals });

    // Weights
    rows.push({
      Field:  'Initial Weight',
      Date:   txt(document.querySelector('input[name="init_date"]')),
      Weight: txt(document.querySelector('input[name="init_weight"]'))
    });
    rows.push({
      Field:  'Lowest Weight',
      Date:   txt(document.querySelector('input[name="lowest_date"]')),
      Weight: txt(document.querySelector('input[name="lowest_weight"]'))
    });
    rows.push({
      Field:  'Target Weight',
      Date:   txt(document.querySelector('input[name="target_date"]')),
      Weight: txt(document.querySelector('input[name="target_weight"]'))
    });

    // NEW: Quick Flags
    rows.push({ Field: 'Nutrition Flag',  Flag: yesNo(!!document.querySelector('input[name="flag_nutrition"]')?.checked) });
    rows.push({ Field: 'Focus Case Flag', Flag: yesNo(!!document.querySelector('input[name="flag_focus_case"]')?.checked) });

    // Frequency (normalized month keys)
    const freq = { Field: 'Frequency' };
    document.querySelectorAll('#frequency-table td[data-month]')
      .forEach(td => { freq[td.dataset.month] = txt(td); });
    rows.push(freq);

    // Session details
    rows.push({ Field: 'Expiration / Remaining', Value: txt(document.querySelector('input[name="expiration"]')) });
    rows.push({ Field: 'First Session Date',     Value: txt(document.querySelector('input[name="last_session"]')) });

    // Health / Injuries
    function pushHealth(field, flagName, commentName) {
      const flagEl = document.querySelector(`input[name="${flagName}"]`);
      const comEl  = commentName ? document.querySelector(`input[name="${commentName}"]`) : null;
      const Flag   = yesNo(!!(flagEl && flagEl.checked));
      const Comment = comEl ? txt(comEl) : '';
      if (Flag === 'Yes' || Comment) rows.push({ Field: field, Flag, Comment });
      else rows.push({ Field: field, Flag });
    }

    pushHealth('Diabetes', 'flag_diabetes', 'comment_diabetes');
    pushHealth('Blood Pressure Issues', 'flag_bp');
    pushHealth('Dizziness / Vertigo', 'flag_vertigo');
    pushHealth('Thyroid Imbalances', 'flag_thyroid');
    pushHealth('Heart Disease', 'flag_heart', 'comment_heart');
    pushHealth('Back / Neck Issues', 'flag_spine', 'comment_spine');
    pushHealth('Hips Issues', 'flag_hips', 'comment_hips');
    pushHealth('Legs Issues', 'flag_legs', 'comment_legs');
    pushHealth('Arms Issues', 'flag_arms', 'comment_arms');
    pushHealth('Vascular Pathologies', 'flag_vascular', 'comment_vascular');
    pushHealth('Irregular Menstrual Period / Hormonal Issues', 'flag_irregular_period');
    pushHealth('Menopause ‚Äì # of Years', 'flag_menopause_years', 'comment_menopause_years');
    pushHealth('Blood Work Alterations', 'flag_blood_work');

    // Rewards / Deals
    const rrows = [];
    document.querySelectorAll('#rewards-table tbody tr').forEach(tr => {
      const used   = yesNo(!!tr.querySelector('input[type="checkbox"]')?.checked);
      const cells  = tr.querySelectorAll('td');
      const reward = txt(cells[1]);
      const notes  = txt(cells[2]);
      if (used === 'Yes' || reward || notes) {
        rrows.push({ Field: 'Reward / Deal', Used: used, RewardDeal: reward, RewardNotes: notes });
      }
    });
    rows.push(...rrows);

    // Friends
    const frows = [];
    document.querySelectorAll('#friends-table tbody tr').forEach(tr => {
      const sel   = yesNo(!!tr.querySelector('input[type="checkbox"]')?.checked);
      const cells = tr.querySelectorAll('td');
      const name  = txt(cells[1]);
      const notes = txt(cells[2]);
      if (sel === 'Yes' || name || notes) {
        frows.push({ Field: 'Friend', Select: sel, FriendName: name, FriendNotes: notes });
      }
    });
    rows.push(...frows);

    return rows;
  };
})();
</script>
