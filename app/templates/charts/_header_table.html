{# ─── templates/charts/_header_table.html ─── #}

{# 1️⃣ Load the “profile” sheet and its data rows #}
{% set prof      = sheets['profile'] %}
{% set data      = prof.data %}

{# 2️⃣ Safely pick the first four rows for Goals & Weights #}
{% set row0      = data[0] if data|length > 0 else {} %}
{% set row1      = data[1] if data|length > 1 else {} %}
{% set row2      = data[2] if data|length > 2 else {} %}
{% set row3      = data[3] if data|length > 3 else {} %}

{# 3️⃣ Map those rows into template vars #}
{#    – row0: Goals          (stored under column “Value”)      #}
{% set goals         = row0.get('Value', '')        %}

{#    – row1: Initial Weight (Date & Weight columns)             #}
{% set init_date     = row1.get('Date', '')         %}
{% set init_weight   = row1.get('Weight', '')       %}

{#    – row2: Lowest Weight (Date & Weight columns)              #}
{% set lowest_date   = row2.get('Date', '')         %}
{% set lowest_weight = row2.get('Weight', '')       %}

{#    – row3: Target Weight (Date & Weight columns)              #}
{% set target_date   = row3.get('Date', '')         %}
{% set target_weight = row3.get('Weight', '')       %}

{# 4️⃣ Build the Frequency array from the row whose Field == “Frequency” #}
{% set freq_row = (data | selectattr('Field','equalto','Frequency') | list | first) or {} %}
{% set freq     = [
  freq_row.get('Jan.', ''), freq_row.get('Feb.', ''), freq_row.get('Mar.', ''),
  freq_row.get('Apr.', ''),  freq_row.get('May', ''),   freq_row.get('June', ''),
  freq_row.get('July', ''),  freq_row.get('Aug.', ''),  freq_row.get('Sept.', ''),
  freq_row.get('Oct.', ''),   freq_row.get('Nov.', ''),  freq_row.get('Dec.', '')
] %}

{# 5️⃣ Pull in Session Details rows: Expiration & Last Session #}
{% set exp_row       = (data | selectattr('Field','equalto','Expiration / Remaining') | list | first) or {} %}
{% set expiration    = exp_row.get('Value', '') %}

{% set ls_row        = (data | selectattr('Field','equalto','First Session Date (Current Package)') | list | first) or {} %}
{% set last_session  = ls_row.get('Value', '') %}

{# ─── Custom CSS to hide default <details> marker ─── #}
<style>
  details summary                { list-style: none; cursor: pointer; }
  details summary::-webkit-details-marker { display: none; }
  details summary::marker        { display: none; }
</style>

{# ─── Markup begins ─── #}
<div class="space-y-6">
  <details open class="bg-white rounded-lg shadow transition-colors duration-200">
    <summary class="px-6 py-4 text-lg font-semibold bg-pink-100 hover:bg-pink-200">
      Client Profile
    </summary>
    <div class="px-6 pb-6 space-y-6 border-t border-gray-200">

      {# ─── Goals ─── #}
      <div class="flex items-center space-x-4 mt-4">
        <span class="font-medium w-1/4">Goals:</span>
        <textarea
          name="goals"
          class="w-80 h-16 border border-gray-300 rounded px-2 py-4 resize-none"
        >{{ goals }}</textarea>
      </div>

      {# ─── Weights (Initial / Lowest / Target) ─── #}
      <div class="space-y-4">
        <div class="flex items-center space-x-4">
          <span class="font-medium w-1/4">Initial Weight</span>
          <input type="date" name="init_date"  value="{{ init_date }}"  class="w-48 border rounded px-2 py-1"/>
          <input type="text" name="init_weight" value="{{ init_weight }}" class="w-32 border rounded px-2 py-1" placeholder="Weight"/>
        </div>
        <div class="flex items-center space-x-4">
          <span class="font-medium w-1/4">Lowest Weight</span>
          <input type="date" name="lowest_date" value="{{ lowest_date }}" class="w-48 border rounded px-2 py-1"/>
          <input type="text" name="lowest_weight" value="{{ lowest_weight }}" class="w-32 border rounded px-2 py-1" placeholder="Weight"/>
        </div>
        <div class="flex items-center space-x-4">
          <span class="font-medium w-1/4">Target Weight</span>
          <input type="date" name="target_date" value="{{ target_date }}" class="w-48 border rounded px-2 py-1"/>
          <input type="text" name="target_weight" value="{{ target_weight }}" class="w-32 border rounded px-2 py-1" placeholder="Weight"/>
        </div>
      </div>

      {# ─── Frequency Table ─── #}
      <div class="overflow-x-auto">
        <table class="min-w-full border-collapse text-sm text-center">
          <caption class="text-lg font-semibold mb-2">Frequency</caption>
          <thead class="bg-gray-100 font-semibold">
            <tr>
              {% for mon in ['Jan.','Feb.','Mar.','Apr.','May','June','July','Aug.','Sept.','Oct.','Nov.','Dec.'] %}
                <th class="border px-2 py-1">{{ mon }}</th>
              {% endfor %}
            </tr>
          </thead>
          <tbody>
            <tr>
              {% for v in freq %}
                <td class="border px-2 py-2" contenteditable="true">{{ v }}</td>
              {% endfor %}
            </tr>
          </tbody>
        </table>
      </div>

      {# ─── Session Details ─── #}
      <div class="space-y-4">
        <div class="flex items-center space-x-4">
          <span class="font-medium w-1/4">Expiration / Remaining</span>
          <input
            type="text"
            name="expiration"
            value="{{ expiration }}"
            class="w-48 border border-gray-300 rounded px-2 py-1"
          />
        </div>
        <div class="flex items-center space-x-4">
          <span class="font-medium w-1/4">First Session Date</span>
          <input
            type="date"
            name="last_session"
            value="{{ last_session }}"
            class="w-48 border border-gray-300 rounded px-2 py-1"
          />
        </div>
      </div>

    </div>
  </details>
</div>



{# ─── Health / Injuries Sub‑section (within Profile tab) ─── #}

{# 1️⃣ Load your “Profile” sheet data #}
{% set prof   = sheets['profile'] %}
{% set pdata  = prof.data %}

{# 2️⃣ For each health field, grab its row dict or fallback to {} #}
{% set row_diabetes        = (pdata | selectattr('Field','equalto','Diabetes') | list | first) or {} %}
{% set row_bp              = (pdata | selectattr('Field','equalto','Blood Pressure Issues') | list | first) or {} %}
{% set row_vertigo         = (pdata | selectattr('Field','equalto','Dizziness / Vertigo') | list | first) or {} %}
{% set row_thyroid         = (pdata | selectattr('Field','equalto','Thyroid Imbalances') | list | first) or {} %}
{% set row_heart           = (pdata | selectattr('Field','equalto','Heart Disease') | list | first) or {} %}
{% set row_spine           = (pdata | selectattr('Field','equalto','Back / Neck Issues') | list | first) or {} %}
{% set row_hips            = (pdata | selectattr('Field','equalto','Hips Issues') | list | first) or {} %}
{% set row_legs            = (pdata | selectattr('Field','equalto','Legs Issues') | list | first) or {} %}
{% set row_arms            = (pdata | selectattr('Field','equalto','Arms Issues') | list | first) or {} %}
{% set row_vascular        = (pdata | selectattr('Field','equalto','Vascular Pathologies') | list | first) or {} %}
{% set row_irregular       = (pdata | selectattr('Field','equalto','Irregular Menstrual Period / Hormonal Issues') | list | first) or {} %}
{% set row_menopause       = (pdata | selectattr('Field','equalto','Menopause – # of Years') | list | first) or {} %}
{% set row_blood_work      = (pdata | selectattr('Field','equalto','Blood Work Alterations') | list | first) or {} %}

{# 3️⃣ Extract Comment & Flag for each #}
{% set comment_diabetes    = row_diabetes.get('Comment','') %}
{% set flag_diabetes       = row_diabetes.get('Flag', False) %}

{% set flag_bp             = row_bp.get('Flag', False) %}
{% set flag_vertigo        = row_vertigo.get('Flag', False) %}
{% set flag_thyroid        = row_thyroid.get('Flag', False) %}

{% set comment_heart       = row_heart.get('Comment','') %}
{% set flag_heart          = row_heart.get('Flag', False) %}

{% set comment_spine       = row_spine.get('Comment','') %}
{% set flag_spine          = row_spine.get('Flag', False) %}

{% set comment_hips        = row_hips.get('Comment','') %}
{% set flag_hips           = row_hips.get('Flag', False) %}

{% set comment_legs        = row_legs.get('Comment','') %}
{% set flag_legs           = row_legs.get('Flag', False) %}

{% set comment_arms        = row_arms.get('Comment','') %}
{% set flag_arms           = row_arms.get('Flag', False) %}

{% set comment_vascular    = row_vascular.get('Comment','') %}
{% set flag_vascular       = row_vascular.get('Flag', False) %}

{% set flag_irregular_period    = row_irregular.get('Flag', False) %}

{% set comment_menopause_years  = row_menopause.get('Comment','') %}
{% set flag_menopause_years     = row_menopause.get('Flag', False) %}

{% set flag_blood_work     = row_blood_work.get('Flag', False) %}

<details open class="bg-white rounded-lg shadow transition-colors duration-200">
  <summary class="px-6 py-4 text-lg font-semibold bg-pink-100 hover:bg-pink-200">
    Health / Injuries
  </summary>
  <div class="px-6 pt-4 pb-8 border-t border-pink-200 min-h-[300px]">
    <p class="text-sm text-gray-600 mb-4">
      Figurella has no contradictions; we ask about your medical values to improve your experience.
    </p>

    <div class="grid grid-cols-2 gap-8">
      <!-- Left column -->
      <ul class="list-none space-y-2">
        <!-- Diabetes -->
        <li class="flex items-center space-x-2">
          <input
            type="text"
            name="comment_diabetes"
            value="{{ comment_diabetes }}"
            placeholder="Comment"
            class="w-24 border border-gray-300 rounded px-2 py-1"
          />
          <label class="inline-flex items-center">
            <input
              type="checkbox"
              name="flag_diabetes"
              class="form-checkbox h-5 w-5 text-pink-600"
              {% if flag_diabetes and flag_diabetes != 'No' %}checked{% endif %}
            />
            <span class="ml-2">Diabetes</span>
          </label>
        </li>

        <!-- Blood Pressure Issues -->
        <li class="flex items-center space-x-2">
          <span class="w-24"></span>
          <label class="inline-flex items-center">
            <input
              type="checkbox"
              name="flag_bp"
              class="form-checkbox h-5 w-5 text-pink-600"
              {% if flag_bp and flag_bp != 'No' %}checked{% endif %}
            />
            <span class="ml-2">Blood Pressure Issues</span>
          </label>
        </li>

        <!-- Dizziness / Vertigo -->
        <li class="flex items-center space-x-2">
          <span class="w-24"></span>
          <label class="inline-flex items-center">
            <input
              type="checkbox"
              name="flag_vertigo"
              class="form-checkbox h-5 w-5 text-pink-600"
              {% if flag_vertigo and flag_vertigo != 'No' %}checked{% endif %}
            />
            <span class="ml-2">Dizziness / Vertigo</span>
          </label>
        </li>

        <!-- Thyroid Imbalances -->
        <li class="flex items-center space-x-2">
          <span class="w-24"></span>
          <label class="inline-flex items-center">
            <input
              type="checkbox"
              name="flag_thyroid"
              class="form-checkbox h-5 w-5 text-pink-600"
              {% if flag_thyroid and flag_thyroid != 'No' %}checked{% endif %}
            />
            <span class="ml-2">Thyroid Imbalances</span>
          </label>
        </li>

        <!-- Heart Disease -->
        <li class="flex items-center space-x-2">
          <input
            type="text"
            name="comment_heart"
            value="{{ comment_heart }}"
            placeholder="Comment"
            class="w-24 border border-gray-300 rounded px-2 py-1"
          />
          <label class="inline-flex items-center">
            <input
              type="checkbox"
              name="flag_heart"
              class="form-checkbox h-5 w-5 text-pink-600"
              {% if flag_heart and flag_heart != 'No' %}checked{% endif %}
            />
            <span class="ml-2">Heart Disease</span>
          </label>
        </li>

        <!-- Back / Neck Issues -->
        <li class="flex items-center space-x-2">
          <input
            type="text"
            name="comment_spine"
            value="{{ comment_spine }}"
            placeholder="Comment"
            class="w-24 border border-gray-300 rounded px-2 py-1"
          />
          <label class="inline-flex items-center">
            <input
              type="checkbox"
              name="flag_spine"
              class="form-checkbox h-5 w-5 text-pink-600"
              {% if flag_spine and flag_spine != 'No' %}checked{% endif %}
            />
            <span class="ml-2">Back / Neck Issues</span>
          </label>
        </li>

        <!-- Hips Issues -->
        <li class="flex items-center space-x-2">
          <input
            type="text"
            name="comment_hips"
            value="{{ comment_hips }}"
            placeholder="Comment"
            class="w-24 border border-gray-300 rounded px-2 py-1"
          />
          <label class="inline-flex items-center">
            <input
              type="checkbox"
              name="flag_hips"
              class="form-checkbox h-5 w-5 text-pink-600"
              {% if flag_hips and flag_hips != 'No' %}checked{% endif %}
            />
            <span class="ml-2">Hips Issues</span>
          </label>
        </li>

        <!-- Legs Issues -->
        <li class="flex items-center space-x-2">
          <input
            type="text"
            name="comment_legs"
            value="{{ comment_legs }}"
            placeholder="Comment"
            class="w-24 border border-gray-300 rounded px-2 py-1"
          />
          <label class="inline-flex items-center">
            <input
              type="checkbox"
              name="flag_legs"
              class="form-checkbox h-5 w-5 text-pink-600"
              {% if flag_legs and flag_legs != 'No' %}checked{% endif %}
            />
            <span class="ml-2">Legs Issues</span>
          </label>
        </li>

        <!-- Arms Issues -->
        <li class="flex items-center space-x-2">
          <input
            type="text"
            name="comment_arms"
            value="{{ comment_arms }}"
            placeholder="Comment"
            class="w-24 border border-gray-300 rounded px-2 py-1"
          />
          <label class="inline-flex items-center">
            <input
              type="checkbox"
              name="flag_arms"
              class="form-checkbox h-5 w-5 text-pink-600"
              {% if flag_arms and flag_arms != 'No' %}checked{% endif %}
            />
            <span class="ml-2">Arms Issues</span>
          </label>
        </li>
      </ul>

      <!-- Right column -->
      <ul class="list-none space-y-2">
        <!-- Vascular Pathologies -->
        <li class="flex items-center space-x-2">
          <input
            type="text"
            name="comment_vascular"
            value="{{ comment_vascular }}"
            placeholder="Comment"
            class="w-24 border border-gray-300 rounded px-2 py-1"
          />
          <label class="inline-flex items-center">
            <input
              type="checkbox"
              name="flag_vascular"
              class="form-checkbox h-5 w-5 text-pink-600"
              {% if flag_vascular and flag_vascular != 'No' %}checked{% endif %}
            />
            <span class="ml-2">Vascular Pathologies</span>
          </label>
        </li>

        <!-- Irregular Menstrual Period / Hormonal Issues -->
        <li class="flex items-center space-x-2">
          <span class="w-24"></span>
          <label class="inline-flex items-center">
            <input
              type="checkbox"
              name="flag_irregular_period"
              class="form-checkbox h-5 w-5 text-pink-600"
              {% if flag_irregular_period and flag_irregular_period != 'No' %}checked{% endif %}
            />
            <span class="ml-2">Irregular Menstrual Period / Hormonal Issues</span>
          </label>
        </li>

        <!-- Menopause – # of Years -->
        <li class="flex items-center space-x-2">
          <input
            type="text"
            name="comment_menopause_years"
            value="{{ comment_menopause_years }}"
            placeholder="Comment"
            class="w-24 border border-gray-300 rounded px-2 py-1"
          />
          <label class="inline-flex items-center">
            <input
              type="checkbox"
              name="flag_menopause_years"
              class="form-checkbox h-5 w-5 text-pink-600"
              {% if flag_menopause_years and flag_menopause_years != 'No' %}checked{% endif %}
            />
            <span class="ml-2">Menopause – # of Years</span>
          </label>
        </li>

        <!-- Blood Work Alterations -->
        <li class="flex items-center space-x-2">
          <span class="w-24"></span>
          <label class="inline-flex items-center">
            <input
              type="checkbox"
              name="flag_blood_work"
              class="form-checkbox h-5 w-5 text-pink-600"
              {% if flag_blood_work and flag_blood_work != 'No' %}checked{% endif %}
            />
            <span class="ml-2">Blood Work Alterations</span>
          </label>
        </li>
      </ul>
    </div>
  </div>
</details>


{# ─── Rewards / Deals (within Profile tab) ─── #}

{# 1️⃣ Grab your “profile” sheet and its data rows #}
{% set prof         = sheets['profile'] %}
{% set pdata        = prof.data %}
{# 2️⃣ Filter out just the Reward rows #}
{% set reward_rows  = pdata | selectattr('Field','equalto','Reward / Deal') | list %}

<script>
// global function to append a blank reward row
function addRewardRow() {
  const tbody  = document.querySelector('#rewards-table tbody');
  const newRow = document.createElement('tr');
  const idx    = tbody.rows.length;

  // zebra stripe even rows
  if ((idx + 1) % 2 === 0) newRow.classList.add('bg-gray-50');

  newRow.innerHTML = `
    <td class="border px-2 py-1 text-center">
      <input type="checkbox" name="used[]" class="form-checkbox h-4 w-4 accent-pink-600"/>
    </td>
    <td class="border px-2 py-1" contenteditable="true">&nbsp;</td>
    <td class="border px-2 py-1" contenteditable="true">&nbsp;</td>
  `;
  tbody.appendChild(newRow);
  newRow.scrollIntoView({ block: 'nearest' });
}
</script>

<style>
  /* zebra striping for reward rows */
  #rewards-table tbody tr:nth-child(even) {
    background-color: rgba(243, 244, 246, 1);
  }
</style>

<template id="reward-row-template">
  <tr>
    <td class="border px-2 py-1 text-center">
      <input type="checkbox" name="used[]" class="form-checkbox h-4 w-4 accent-pink-600"/>
    </td>
    <td class="border px-2 py-1" contenteditable="true">&nbsp;</td>
    <td class="border px-2 py-1" contenteditable="true">&nbsp;</td>
  </tr>
</template>

<details open class="bg-white rounded-lg shadow transition-colors duration-200">
  <summary class="px-6 py-4 text-lg font-semibold bg-pink-100 hover:bg-pink-200">
    Rewards / Deals
  </summary>
  <div class="px-6 pb-6 border-t border-gray-200">
    <table id="rewards-table" class="table-auto w-full border-collapse text-sm">
      <colgroup>
        <col style="width:1%; white-space:nowrap;" />
        <col />
        <col />
      </colgroup>
      <thead class="bg-gray-100 font-semibold text-gray-700">
        <tr>
          <th class="border px-2 py-1 text-center">Used</th>
          <th class="border px-2 py-1">Reward / Deal</th>
          <th class="border px-2 py-1">Notes</th>
        </tr>
      </thead>
      <tbody>
        {% if reward_rows %}
          {% for row in reward_rows %}
            <tr class="{% if loop.index0 is even %}bg-gray-50{% endif %}">
              <td class="border px-2 py-1 text-center">
                <input
                  type="checkbox"
                  name="used[]"
                  class="form-checkbox h-4 w-4 accent-pink-600"
                  {% if row.get('Used') and row.get('Used') != 'No' %}checked{% endif %}
                />
              </td>
              <td class="border px-2 py-1" contenteditable="true">
                {{ row.get('RewardDeal','') }}
              </td>
              <td class="border px-2 py-1" contenteditable="true">
                {{ row.get('RewardNotes','') }}
              </td>
            </tr>
          {% endfor %}
        {% else %}
          {# fallback to 4 blank rows #}
          {% for i in range(4) %}
            <tr class="{% if i is even %}bg-gray-50{% endif %}">
              <td class="border px-2 py-1 text-center">
                <input type="checkbox" name="used[]" class="form-checkbox h-4 w-4 accent-pink-600"/>
              </td>
              <td class="border px-2 py-1" contenteditable="true">&nbsp;</td>
              <td class="border px-2 py-1" contenteditable="true">&nbsp;</td>
            </tr>
          {% endfor %}
        {% endif %}
      </tbody>
    </table>

    <button
      type="button"
      onclick="addRewardRow()"
      class="mt-3 px-4 py-1 bg-pink-600 text-white rounded hover:bg-pink-700 transition"
    >
      + Add Row
    </button>
  </div>
</details>




{# ─── Friends Sub‑section (in your Profile tab) ─── #}

{# 1️⃣ Load your “profile” sheet rows #}
{% set prof         = sheets['profile'] %}
{% set pdata        = prof.data %}

{# 2️⃣ Filter only the rows where Field == "Friend" #}
{% set friend_rows  = pdata | selectattr('Field','equalto','Friend') | list %}

<script>
// global function available immediately
function addFriendRow() {
  const table    = document.getElementById('friends-table');
  const tbody    = table.querySelector('tbody');
  const rowCount = tbody.rows.length;
  const newRow   = document.createElement('tr');

  // zebra‑striping
  if ((rowCount + 1) % 2 === 0) {
    newRow.classList.add('bg-gray-50');
  }

  // build cells via innerHTML
  newRow.innerHTML = `
    <td class="border px-2 py-1 text-center">
      <input
        type="checkbox"
        name="friend-selected[]"
        class="form-checkbox h-4 w-4 accent-pink-600"
      />
    </td>
    <td class="border px-2 py-1" contenteditable="true">&nbsp;</td>
    <td class="border px-2 py-1" contenteditable="true">&nbsp;</td>
  `;

  tbody.appendChild(newRow);
  newRow.scrollIntoView({ block: 'nearest' });
}
</script>

<style>
  /* Zebra striping */
  #friends-table tbody tr:nth-child(even) {
    background-color: rgba(243, 244, 246, 1); /* bg-gray-50 */
  }
</style>

<template id="friend-row-template">
  <tr>
    <td class="border px-2 py-1 text-center">
      <input
        type="checkbox"
        name="friend-selected[]"
        class="form-checkbox h-4 w-4 accent-pink-600"
      />
    </td>
    <td class="border px-2 py-1" contenteditable="true">&nbsp;</td>
    <td class="border px-2 py-1" contenteditable="true">&nbsp;</td>
  </tr>
</template>

<details open class="bg-white rounded-lg shadow transition-colors duration-200">
  <summary class="px-6 py-4 text-lg font-semibold bg-pink-100 hover:bg-pink-200">
    Friends
  </summary>
  <div class="px-6 pb-6 border-t border-gray-200">
    <table
      id="friends-table"
      class="table-auto w-full border-collapse text-sm"
    >
      <colgroup>
        <col style="width:1%; white-space:nowrap;" />
        <col />
        <col />
      </colgroup>
      <thead class="bg-gray-100 font-semibold text-gray-700">
        <tr>
          <th class="border px-2 py-1 text-center">Select</th>
          <th class="border px-2 py-1">Name</th>
          <th class="border px-2 py-1">Notes</th>
        </tr>
      </thead>
      <tbody>
        {# 3️⃣ If you have saved friends in Excel, render them #}
        {% if friend_rows %}
          {% for row in friend_rows %}
            <tr class="{% if loop.index0 is even %}bg-gray-50{% endif %}">
              <td class="border px-2 py-1 text-center">
                <input
                  type="checkbox"
                  name="friend-selected[]"
                  class="form-checkbox h-4 w-4 accent-pink-600"
                  {% if row.get('Select') and row.get('Select') != 'No' %}checked{% endif %}
                />
              </td>
              <td class="border px-2 py-1" contenteditable="true">
                {{ row.get('FriendName','') }}
              </td>
              <td class="border px-2 py-1" contenteditable="true">
                {{ row.get('FriendNotes','') }}
              </td>
            </tr>
          {% endfor %}
        {% else %}
          {# 4️⃣ Fallback: show 4 empty rows #}
          {% for i in range(4) %}
            <tr class="{% if i is even %}bg-gray-50{% endif %}">
              <td class="border px-2 py-1 text-center">
                <input
                  type="checkbox"
                  name="friend-selected[]"
                  class="form-checkbox h-4 w-4 accent-pink-600"
                />
              </td>
              <td class="border px-2 py-1" contenteditable="true">&nbsp;</td>
              <td class="border px-2 py-1" contenteditable="true">&nbsp;</td>
            </tr>
          {% endfor %}
        {% endif %}
      </tbody>
    </table>

    <button
      type="button"
      onclick="addFriendRow()"
      class="mt-3 px-4 py-1 bg-pink-600 text-white rounded hover:bg-pink-700 transition"
    >
      + Add Row
    </button>
  </div>
</details>
