{% extends "base.html" %}

{% block extra_head %}
<style>
  html, body { margin:0; padding:0; height:100%; overflow:hidden; }
  #charts-main {
    position:absolute; top:64px; bottom:44px; left:0; right:0;
    display:flex; overflow:hidden;
  }
  #charts-wrapper { position:relative; width:100%; height:100%; overflow:hidden; }

  .panel {
    background:white; border-radius:0.75rem;
    box-shadow:0 0 16px 4px rgba(0,0,0,.15);
    padding:1rem; height:100%; overflow:auto; box-sizing:border-box;
  }
  #chart-panel.panel { padding:0; }

  /* Sidebar */
  #client-panel{
    position:absolute; top:0; bottom:0; left:0; width:200px;
    display:flex; flex-direction:column; background:white; z-index:1000;
    transition:width .2s, background .2s;
  }
  #client-panel.collapsed{ width:60px; background:#f3f4f6; }
  #client-panel .mb-2, #client-panel .px-4, #client-panel input, #client-panel .filter-row, #client-panel table {
    transition:opacity .2s;
  }
  #client-panel.collapsed .mb-2,
  #client-panel.collapsed .px-4,
  #client-panel.collapsed input,
  #client-panel.collapsed .filter-row,
  #client-panel.collapsed table { opacity:0; pointer-events:none; }

  #client-panel table { width:100%; border-collapse:collapse; margin:0; }
  #client-panel td { white-space:nowrap; padding:.5rem; cursor:pointer; }
  #client-panel thead { display:none; }

  /* Hide Date Created (2), Email (4), Phone (5) */
  #client-panel th:nth-child(2), #client-panel td:nth-child(2),
  #client-panel th:nth-child(4), #client-panel td:nth-child(4),
  #client-panel th:nth-child(5), #client-panel td:nth-child(5) { display:none; }

  /* Divider */
  .sidebar-divider{
    position:absolute; top:0; bottom:0; left:200px; width:8px; cursor:ew-resize;
    display:flex; align-items:center; justify-content:center; z-index:1001; background:transparent; transition:left .2s;
  }
  #client-panel.collapsed ~ .sidebar-divider{ left:60px !important; }
  .sidebar-divider i{ transform:rotate(90deg); font-size:1.25rem; color:rgba(0,0,0,.2); }

  /* Chart area */
  #chart-panel{
    position:absolute; top:0; bottom:0; left:200px; right:0;
    display:flex; align-items:flex-start; overflow:hidden; box-sizing:border-box; transition:left .2s;
  }
  #client-panel.collapsed ~ #chart-panel{ left:60px !important; }

  .card-divider{ flex:0 0 8px; cursor:col-resize; display:flex; align-items:center; justify-content:center; z-index:500; }
  .card-divider i{ font-size:1.25rem; color:rgba(0,0,0,.2); }

  .chart-card{
    position:relative; flex:1 1 0; min-width:0; display:flex; flex-direction:column;
    background:white; border-radius:.75rem; box-shadow:0 0 8px rgba(0,0,0,.1); overflow:hidden; box-sizing:border-box;
  }
  .scale-target{ transform-origin:top left; width:100%; height:100%; }
  .scale-content{ display:flex; flex-direction:column; width:100%; height:100%; }
  .chart-header{ background:#1f2937; color:#fff; display:flex; justify-content:space-between; align-items:center; padding:.5rem 1rem; flex-shrink:0; }
  .chart-close{ background:none; border:none; color:#fff; font-size:1.25rem; cursor:pointer; }
  .chart-body{ flex:1; display:flex; flex-direction:column; overflow:auto; }
  .chart-card.editing .chart-body{ outline:2px dashed #ec4899; outline-offset:-4px; }

  @keyframes headerFlash { 0%{background:#f59e0b;} 100%{background:#1f2937;} }
  .chart-header.flash { animation: headerFlash .8s ease; }

  .client-flags { margin-left:.25rem; }
  .client-flags > span { margin-left:.1rem; }

  .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
  .hide-scrollbar::-webkit-scrollbar { display: none; }

  .flag-group .flag-btn.btn-on { background:#ec4899 !important; color:#ffffff !important; box-shadow:0 6px 16px rgba(236,72,153,.35) !important; }
  .flag-group .flag-btn.btn-off { background:#e5e7eb !important; color:#111827 !important; box-shadow:none !important; }

  /* ---------------- Sticky toolbar under tabs (Rev1) ---------------- */
  /* JS wraps the first two control rows in .rev1-toolbar-wrap */
  #workout-rev1 .rev1-toolbar-wrap{
    position: sticky; top: 0; z-index: 25;
    display:flex; align-items:center; justify-content:space-between; gap:1rem; flex-wrap:wrap;
    background:#fff; padding:.25rem 0; border-bottom:1px solid #eee;
  }
  /* Make the table header stick below the toolbar height */
  #workout-rev1 .sticky-header thead th{ position:sticky; top: var(--wr1-stick-top, 0px); background:#f9fafb; z-index:10; }

  /* ---------------- Drag handles & fluent drag visuals ---------------- */
  /* We set first TD to relative via JS; keep grip invisible */
  .row-grip{ position:absolute; inset:0; opacity:0; cursor:grab; user-select:none; }
  .row-grip:active{ cursor:grabbing; }

  /* Lift effect on the dragged row */
  #workout-rev1 table tbody tr,
  #gk-rev1-section table tbody tr{
    transition: transform .08s ease, box-shadow .12s ease;
    will-change: transform;
  }
  #workout-rev1 table tbody tr.dragging,
  #gk-rev1-section table tbody tr.dragging{
    position: relative; z-index: 50;
    transform: scale(1.01);
    box-shadow: 0 12px 24px rgba(0,0,0,.16);
    background:#fff;
  }
  #workout-rev1 table tbody tr.dragging td,
  #gk-rev1-section table tbody tr.dragging td{ background:#fff !important; }

  /* Drop hint lines */
  #workout-rev1 table tbody tr.drag-over-top,
  #gk-rev1-section table tbody tr.drag-over-top{ box-shadow: inset 0 2px 0 #cc0066; }
  #workout-rev1 table tbody tr.drag-over-bottom,
  #gk-rev1-section table tbody tr.drag-over-bottom{ box-shadow: inset 0 -2px 0 #cc0066; }
</style>
{% endblock %}

{% block content %}
<main id="charts-main">
  <div id="charts-wrapper">

    <!-- Sidebar -->
    <div id="client-panel" class="panel">
      <div class="flex items-center mb-2">
        <i class="bi bi-bar-chart-fill text-2xl text-figurella"></i>
        <h1 class="text-2xl font-bold text-figurella ml-2">Clients Mgmt</h1>
      </div>

      <div class="px-4 pb-2">
        <input id="clientSearch" placeholder="Filter‚Ä¶" class="w-full h-6 text-xs placeholder-gray-400 border border-gray-300 rounded px-2 focus:outline-none focus:ring-1 focus:ring-figurella" autocomplete="off">
      </div>

      <div class="filter-row px-4 pb-2">
        <label class="text-xs flex items-center select-none">
          <input id="onlyCurrent" type="checkbox" checked class="mr-2"> Only ‚ÄúCurrent client‚Äù
        </label>
      </div>

      <div class="overflow-y-auto" style="flex:1">
        <table>
          <thead>
            <tr>
              {% for col in columns %}<th>{{ col }}</th>{% endfor %}
            </tr>
          </thead>
          <tbody>
            {% for row in data|sort(attribute=columns[0]) %}
              {% set nutri_flag = row.get('Nutrition Flag') or row.get('NutritionFlag') or row.get('nutrition_flag') %}
              {% set focus_flag = row.get('Focus Case Flag') or row.get('FocusFlag') or row.get('focus_flag') %}

              <tr data-status="{{ row['Status']|lower }}">
                {% for col in columns %}
                  {% if loop.first %}
                    <td class="client-name text-figurella truncate" data-name="{{ row[col] }}">
                      <span class="client-name-text">{{ row[col] }}</span>
                      <span class="client-flags">
                        {% if nutri_flag and nutri_flag != 'No' %}<span title="Nutrition">üçé</span>{% endif %}
                        {% if focus_flag and focus_flag != 'No' %}<span title="Focus Case">üéØ</span>{% endif %}
                      </span>
                    </td>
                  {% else %}
                    <td>{{ row[col] }}</td>
                  {% endif %}
                {% endfor %}
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>

    <div class="sidebar-divider"><i class="bi bi-grip-horizontal"></i></div>

    <!-- Cards -->
    <div id="chart-panel" class="panel"></div>
  </div>
</main>
{% endblock %}

{% block scripts %}
<script>
window.GK_DEFAULTS = {
  TO1: [
    {Workout: "1/2 KICK BACK",         Rings: "I",   Notes: ""},
    {Workout: "KICK BACK",             Rings: "-",   Notes: ""},
    {Workout: "SIDE DIAG KICKS",       Rings: "I",   Notes: ""}
  ],
  TO2: [
    {Workout: "1/2 KICKS ON BENCH",    Rings: "I",   Notes: ""},
    {Workout: "BALLERINA",             Rings: "-",   Notes: ""},
    {Workout: "INNER FORWARD",         Rings: "I",   Notes: ""}
  ],
    TO3: [
    {Workout: "1/2 KICKS ON BENCH",    Rings: "I",   Notes: ""},
    {Workout: "BALLERINA",             Rings: "-",   Notes: ""},
    {Workout: "INNER FORWARD",         Rings: "I",   Notes: ""}
  ],
    TO4: [
    {Workout: "1/2 KICKS ON BENCH",    Rings: "I",   Notes: ""},
    {Workout: "BALLERINA",             Rings: "-",   Notes: ""},
    {Workout: "INNER FORWARD",         Rings: "I",   Notes: ""}
  ],
    TO5: [
    {Workout: "1/2 KICKS ON BENCH",    Rings: "I",   Notes: ""},
    {Workout: "BALLERINA",             Rings: "-",   Notes: ""},
    {Workout: "INNER FORWARD",         Rings: "I",   Notes: ""}
  ],
  B1: [
    {Workout: "BICEPS",    Rings: "I",   Notes: ""},
    {Workout: "TRICEPS BACK",      Rings: "L",   Notes: ""},
    {Workout: "CLAP", Rings: "L",   Notes: ""},
    {Workout: "ROW", Rings: "L",   Notes: ""},
    {Workout: "BATMAN", Rings: "S",   Notes: ""},
    {Workout: "SHOULDER ELBOW", Rings: "I",   Notes: ""},
    {Workout: "KNEES TO CHEST B", Rings: "-",   Notes: ""},
    {Workout: "KICK BACK", Rings: "I",   Notes: ""},
    {Workout: "¬Ω KICK BACK", Rings: "I",   Notes: ""},
    {Workout: "SIDE DIAG KICK", Rings: "I",   Notes: ""},
    {Workout: "BOUNCE", Rings: "I",   Notes: ""},

  ],
  B2: [
    {Workout: "1/2 OPEN CLOSE (B)",    Rings: "I",   Notes: ""},
    {Workout: "ALTERNATE SQUATS",      Rings: "-",   Notes: ""},
    {Workout: "SIDE DIAGONAL KICKS B", Rings: "I",   Notes: ""}
  ],
  B3: [
    {Workout: "1/2 OPEN CLOSE (B)",    Rings: "I",   Notes: ""},
    {Workout: "ALTERNATE SQUATS",      Rings: "-",   Notes: ""},
    {Workout: "SIDE DIAGONAL KICKS B", Rings: "I",   Notes: ""}
  ],
    B4: [
    {Workout: "1/2 OPEN CLOSE (B)",    Rings: "I",   Notes: ""},
    {Workout: "ALTERNATE SQUATS",      Rings: "-",   Notes: ""},
    {Workout: "SIDE DIAGONAL KICKS B", Rings: "I",   Notes: ""}
  ],
    B5: [
    {Workout: "1/2 OPEN CLOSE (B)",    Rings: "I",   Notes: ""},
    {Workout: "ALTERNATE SQUATS",      Rings: "-",   Notes: ""},
    {Workout: "SIDE DIAGONAL KICKS B", Rings: "I",   Notes: ""}
  ],
    B6: [
    {Workout: "1/2 OPEN CLOSE (B)",    Rings: "I",   Notes: ""},
    {Workout: "ALTERNATE SQUATS",      Rings: "-",   Notes: ""},
    {Workout: "SIDE DIAGONAL KICKS B", Rings: "I",   Notes: ""}
  ],
    B7: [
    {Workout: "1/2 OPEN CLOSE (B)",    Rings: "I",   Notes: ""},
    {Workout: "ALTERNATE SQUATS",      Rings: "-",   Notes: ""},
    {Workout: "SIDE DIAGONAL KICKS B", Rings: "I",   Notes: ""}
  ],
    B8: [
    {Workout: "1/2 OPEN CLOSE (B)",    Rings: "I",   Notes: ""},
    {Workout: "ALTERNATE SQUATS",      Rings: "-",   Notes: ""},
    {Workout: "SIDE DIAGONAL KICKS B", Rings: "I",   Notes: ""}
  ],
    B9: [
    {Workout: "1/2 OPEN CLOSE (B)",    Rings: "I",   Notes: ""},
    {Workout: "ALTERNATE SQUATS",      Rings: "-",   Notes: ""},
    {Workout: "SIDE DIAGONAL KICKS B", Rings: "I",   Notes: ""}
  ],
    B10: [
    {Workout: "1/2 OPEN CLOSE (B)",    Rings: "I",   Notes: ""},
    {Workout: "ALTERNATE SQUATS",      Rings: "-",   Notes: ""},
    {Workout: "SIDE DIAGONAL KICKS B", Rings: "I",   Notes: ""}
  ],
    B11: [
    {Workout: "1/2 OPEN CLOSE (B)",    Rings: "I",   Notes: ""},
    {Workout: "ALTERNATE SQUATS",      Rings: "-",   Notes: ""},
    {Workout: "SIDE DIAGONAL KICKS B", Rings: "I",   Notes: ""}
  ],
    B12: [
    {Workout: "1/2 OPEN CLOSE (B)",    Rings: "I",   Notes: ""},
    {Workout: "ALTERNATE SQUATS",      Rings: "-",   Notes: ""},
    {Workout: "SIDE DIAGONAL KICKS B", Rings: "I",   Notes: ""}
  ],
    B13: [
    {Workout: "1/2 OPEN CLOSE (B)",    Rings: "I",   Notes: ""},
    {Workout: "ALTERNATE SQUATS",      Rings: "-",   Notes: ""},
    {Workout: "SIDE DIAGONAL KICKS B", Rings: "I",   Notes: ""}
  ],
    B14: [
    {Workout: "1/2 OPEN CLOSE (B)",    Rings: "I",   Notes: ""},
    {Workout: "ALTERNATE SQUATS",      Rings: "-",   Notes: ""},
    {Workout: "SIDE DIAGONAL KICKS B", Rings: "I",   Notes: ""}
  ],
      B15: [
    {Workout: "1/2 OPEN CLOSE (B)",    Rings: "I",   Notes: ""},
    {Workout: "ALTERNATE SQUATS",      Rings: "-",   Notes: ""},
    {Workout: "SIDE DIAGONAL KICKS B", Rings: "I",   Notes: ""}
  ],
};



// Global flag: when true, autosave is suppressed (used by Clear)
window.__rev1SuppressAutosave = false;


// Safe text converter for GK items (prevents ‚Äú[object Object]‚Äù)
window.__toGKText = function(v){
  if (v == null) return '';
  if (typeof v === 'string' || typeof v === 'number') return String(v);
  if (Array.isArray(v)) return v.map(window.__toGKText).join(' ');
  if (typeof v === 'object') {
    if (v.Workout != null) return String(v.Workout);
    if (v.workout != null) return String(v.workout);
    if (v.name    != null) return String(v.name);
    if (v.title   != null) return String(v.title);
    if (v.text    != null) return String(v.text);
  }
  return '';
};




// --- existing vars below ---
var chartPanel  = document.getElementById('chart-panel');
var clientPanel = document.getElementById('client-panel');
var divider     = document.querySelector('.sidebar-divider');
var searchInput = document.getElementById('clientSearch');
var onlyCurrent = document.getElementById('onlyCurrent');
var COLLAPSE_THRESHOLD = 60;

var openCards = new Map();
var normKey   = function(s){ return (s || '').trim().toLowerCase(); };

  /* --- Persistence (open charts + active tab) --- */
  var STORAGE_KEY = 'fig:charts:open-v1';
  function saveOpenState() {
    try {
      var cards = chartPanel.querySelectorAll('.chart-card');
      var state = [];
      cards.forEach(function(card){
        var name = card.dataset.client || '';
        var tabs = card.querySelectorAll('.tab-btn');
        var active = 0;
        tabs.forEach(function(b,i){ if (b.classList.contains('active')) active = i; });
        state.push({ name: name, activeTab: active });
      });
      localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
    } catch(e) {}
  }
  async function restoreOpenState() {
    var state = [];
    try { state = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]') || []; } catch(e) {}
    for (var i=0;i<state.length;i++){
      try { await addCard(state[i].name, { initialTab: state[i].activeTab }); } catch(e) {}
    }
  }
  window.addEventListener('pagehide', saveOpenState);
  window.addEventListener('beforeunload', saveOpenState);




// ---- flush any pending autosaves before leaving the page ----
function flushAllCards(){
  document.querySelectorAll('.chart-card').forEach(function(card){
    if (card.__saveDebounced) {
      try { card.__saveDebounced.flush(); } catch(_) {}
    }
  });
}

window.addEventListener('pagehide',     flushAllCards);
window.addEventListener('beforeunload', flushAllCards);
document.addEventListener('visibilitychange', function(){
  if (document.visibilityState === 'hidden') flushAllCards();
});



  
  /* Sidebar filter */
  function applyFilters() {
    var q    = (searchInput.value || '').toLowerCase();
    var only = !!(onlyCurrent && onlyCurrent.checked);
    document.querySelectorAll('#client-panel tbody tr').forEach(function(tr){
      var nameCell = tr.querySelector('td.client-name');
      var nameText = ((nameCell && nameCell.dataset.name) || '').toLowerCase();
      var status   = (tr.dataset.status || '').toLowerCase();
      var show = true;
      if (q)    show = nameText.indexOf(q) !== -1;
      if (only) show = show && (status === 'current client');
      tr.style.display = show ? '' : 'none';
    });
  }
  searchInput.addEventListener('input', applyFilters);
  onlyCurrent && onlyCurrent.addEventListener('change', applyFilters);
  applyFilters();

  /* Sidebar resize/collapse */
  function startDrag(e){
    e.preventDefault(); document.body.style.cursor = 'ew-resize';
    var startX = e.touches ? e.touches[0].clientX : e.clientX;
    var startW = clientPanel.getBoundingClientRect().width;
    function onMove(ev){
      var x = ev.touches ? ev.touches[0].clientX : ev.clientX;
      var newW = Math.max(0, startW + (x - startX));
      clientPanel.style.width = newW + 'px';
      var offset;
      if (newW < COLLAPSE_THRESHOLD){
        clientPanel.classList.add('collapsed');
        offset = COLLAPSE_THRESHOLD;
      } else {
        clientPanel.classList.remove('collapsed');
        offset = newW;
      }
      divider.style.left    = offset + 'px';
      document.getElementById('chart-panel').style.left = offset + 'px';
    }
    function onUp(){
      document.body.style.cursor = '';
      if (clientPanel.classList.contains('collapsed')){
        clientPanel.style.width = COLLAPSE_THRESHOLD + 'px';
        divider.style.left      = COLLAPSE_THRESHOLD + 'px';
        document.getElementById('chart-panel').style.left = COLLAPSE_THRESHOLD + 'px';
      }
      window.removeEventListener('mousemove', onMove);
      window.removeEventListener('touchmove', onMove);
      window.removeEventListener('mouseup', onUp);
      window.removeEventListener('touchend', onUp);
    }
    window.addEventListener('mousemove', onMove);
    window.addEventListener('touchmove',  onMove);
    window.addEventListener('mouseup',    onUp);
    window.addEventListener('touchend',   onUp);
  }
  divider.addEventListener('mousedown', startDrag);
  divider.addEventListener('touchstart', startDrag);

  /* Card splitters */
  function makeDraggable(div, leftEl, rightEl){
    function startColDrag(e){
      e.preventDefault(); document.body.style.cursor = 'col-resize';
      var startX = e.touches ? e.touches[0].clientX : e.clientX;
      var leftW  = leftEl.getBoundingClientRect().width;
      var rightW = rightEl.getBoundingClientRect().width;
      function onMove(ev){
        var x = ev.touches ? ev.touches[0].clientX : ev.clientX;
        var dx = x - startX;
        var newL = leftW + dx, newR = rightW - dx;
        if (newL < 100 || newR < 100) return;
        leftEl.style.flex  = '0 0 ' + newL + 'px';
        rightEl.style.flex = '0 0 ' + newR + 'px';
      }
      function onUp(){
        document.body.style.cursor = '';
        window.removeEventListener('mousemove', onMove);
        window.removeEventListener('touchmove', onMove);
        window.removeEventListener('mouseup', onUp);
        window.removeEventListener('touchend', onUp);
      }
      window.addEventListener('mousemove', onMove);
      window.addEventListener('touchmove',  onMove);
      window.addEventListener('mouseup',    onUp);
      window.addEventListener('touchend',   onUp);
    }
    div.addEventListener('mousedown', startColDrag);
    div.addEventListener('touchstart', startColDrag);
  }
  function updateCardWidths(){
    var cards = chartPanel.querySelectorAll('.chart-card');
    if (!cards.length) return;
    var gap = 1;
    cards.forEach(function(c){
      c.style.flex = '0 0 calc((100% - ' + (gap*(cards.length-1)) + 'rem)/' + cards.length + ')';
    });
  }
  function rebuildCards(){
    chartPanel.querySelectorAll('.card-divider').forEach(function(d){ d.remove(); });
    var cards = Array.from(chartPanel.querySelectorAll('.chart-card'));
    for (var i=0;i<cards.length-1;i++){
      var div = document.createElement('div');
      div.className = 'card-divider';
      div.innerHTML = '<i class="bi bi-grip-vertical"></i>';
      cards[i].after(div);
      makeDraggable(div, cards[i], cards[i+1]);
    }
    updateCardWidths();
  }

  /* Debounce helper */
  function debounceSmart(fn, ms){
    var t=null, last=null, inFlight=null;
    function run(){
      inFlight = Promise.resolve().then(function(){ return fn.apply(null, last || []); }).finally(function(){ inFlight=null; });
      last = null; return inFlight;
    }
    var w = function(){ last = Array.prototype.slice.call(arguments); clearTimeout(t); t=setTimeout(run, ms); };
    w.flush  = function(){ clearTimeout(t); t=null; return inFlight || (last ? run() : Promise.resolve()); };
    w.cancel = function(){ clearTimeout(t); t=null; last=null; };
    return w;
  }

  /* Helpers for collectors */
  function text(el){ return (el && el.textContent || '').trim(); }

  /* ------- Collectors (scoped to the card) ------- */
  function collectMeasuresFromCard(card){
    var out=[]; var tables=Array.from(card.querySelectorAll('#measures table')); if(!tables.length) return out;

    // 1) 1‚Äì20 grid
    var grid=tables[0];
    grid.querySelectorAll('tbody tr').forEach(function(tr){
      var th = tr.querySelector('th');
      var field = (th && th.textContent || '').trim(); if(!field) return;
      var tds=Array.from(tr.querySelectorAll('td')); var row={Field:field};
      if(field==='Notes'){ row['1']=(tds[0] && tds[0].textContent || '').trim(); for(var i=2;i<=20;i++) row[String(i)]=''; }
      else { for(var j=1;j<=20;j++) row[String(j)]=(tds[j-1] && tds[j-1].textContent || '').trim(); }
      out.push(row);
    });

    // 2) Lower measure tables (M0, M2, M3) ‚Äî **scoped to this card**
    card.querySelectorAll('#measures table[data-meas]').forEach(function(tbl){
      var key  = tbl.dataset.meas;
      var rows = Array.from(tbl.querySelectorAll('tbody tr')); if (!rows.length) return;

      var hdr = rows[0];
      if (key === 'M0') {
        out.push({
          Field: key + ':__hdr__',
          L1:   text(hdr.querySelector('[data-col="L1"]')),
          L2:   text(hdr.querySelector('[data-col="L2"]')),
          DATE: text(hdr.querySelector('[data-col="DATE"]')),
          LB:   text(hdr.querySelector('[data-col="LB"]')),
          H1:   text(hdr.querySelector('[data-col="H1"]')),
          H2:   text(hdr.querySelector('[data-col="H2"]')),
          TAG:  text(hdr.querySelector('[data-col="TAG"]'))
        });
      } else {
        out.push({
          Field: key + ':__hdr__',
          DATE: text(hdr.querySelector('[data-col="DATE"]')),
          LB:   text(hdr.querySelector('[data-col="LB"]')),
          TAG:  text(hdr.querySelector('[data-col="TAG"]'))
        });
      }

      rows.slice(1).forEach(function(tr){
        var fa = tr.dataset.fa || text(tr.querySelector('td.no-edit')) || '';
        if (!fa) return;

        if (key === 'M0') {
          out.push({
            Field: key + ':' + fa,
            L1:   text(tr.querySelector('[data-col="L1"]')),
            L2:   text(tr.querySelector('[data-col="L2"]')),
            DATE: text(tr.querySelector('[data-col="DATE"]')),
            LB:   text(tr.querySelector('[data-col="LB"]')),
            H1:   text(tr.querySelector('[data-col="H1"]')),
            H2:   text(tr.querySelector('[data-col="H2"]')),
            TAG:  text(tr.querySelector('[data-col="TAG"]'))
          });
        } else {
          out.push({
            Field: key + ':' + fa,
            DATE: text(tr.querySelector('[data-col="DATE"]')),
            LB:   text(tr.querySelector('[data-col="LB"]')),
            TAG:  text(tr.querySelector('[data-col="TAG"]'))
          });
        }
      });
    });

    return out;
  }

  function collectWorkoutFromCard(card){
    var pane=card.querySelector('#workout'); if(!pane) return [];
    var KG=pane.querySelector('#workout-kg') && pane.querySelector('#workout-kg').value.trim() || '';
    var Tools=pane.querySelector('#workout-tools') && pane.querySelector('#workout-tools').value.trim() || '';
    var Stretching=pane.querySelector('#stretching') && pane.querySelector('#stretching').value.trim() || '';

    var workouts = Array.from(pane.querySelectorAll('.workout-workout')).map(function(i){ return i.value.trim(); });
    var rings    = Array.from(pane.querySelectorAll('.workout-rings')).map(function(i){ return i.value.trim(); });
    var notes    = Array.from(pane.querySelectorAll('.workout-notes')).map(function(i){ return i.value.trim(); });
    var gk       = Array.from(pane.querySelectorAll('.workout-gk')).map(function(i){ return i.value.trim(); });

    var data=[{KG:KG,Tools:Tools,Stretching:Stretching}];
    var n=Math.max(workouts.length,rings.length,notes.length,17);
    for(var i=0;i<n;i++){
      data.push({ Workout: workouts[i]||'', Rings: rings[i]||'', Notes: notes[i]||'' });
    }
    for(var j=0;j<Math.max(4,gk.length);j++){
      data.push({ Goldorack:'GK', Value:gk[j]||'' });
    }
    return data;
  }

  function collectWorkoutRev1FromCard(card){
    var pane=card.querySelector('#workout-rev1'); if(!pane) return [];
    var KG    = pane.querySelector('#workout-rev1-kg') && pane.querySelector('#workout-rev1-kg').value.trim() || '';
    var Tools = pane.querySelector('#workout-rev1-tools') && pane.querySelector('#workout-rev1-tools').value.trim() || '';
    var ProgramType = pane.querySelector('#workout-rev1-type') && pane.querySelector('#workout-rev1-type').value || '';

    var workouts = Array.from(pane.querySelectorAll('.rev1-workout')).map(function(i){ return i.value.trim(); });
    var rings    = Array.from(pane.querySelectorAll('.rev1-rings')).map(function(i){ return i.value.trim(); });
    var notes    = Array.from(pane.querySelectorAll('.rev1-notes')).map(function(i){ return i.value.trim(); });

    var data = [];
    data.push({ KG:KG, Tools:Tools, ProgramType:ProgramType, Stretching:'' });

    var n = Math.max(16, workouts.length, rings.length, notes.length);
    for (var i=0;i<n;i++){
      data.push({ Workout: workouts[i] || '', Rings: rings[i] || '', Notes: notes[i] || '' });
    }

    var gkRows = Array.from(pane.querySelectorAll('#gk-rev1-section tbody tr'));
    gkRows.forEach(function(tr){
      var inputs = tr.querySelectorAll('input');
      if (!inputs || inputs.length < 3) return;
      var gw = (inputs[0].value || '').trim();
      var gr = (inputs[1].value || '').trim();
      var gn = (inputs[2].value || '').trim();
      if (gw || gr || gn){
        data.push({ Workout: gw, Rings: gr, Notes: gn, GK: true });
      }
    });

    return data;
  }

  function collectNutritionFromCard(card){
    var rows=[]; card.querySelectorAll('#nutrition-rows .nutrition-row').forEach(function(el){
      var Date = el.querySelector('.nutrition-date') && el.querySelector('.nutrition-date').value.trim() || '';
      var Type = el.querySelector('.nutrition-type') && el.querySelector('.nutrition-type').value.trim() || '';
      var Notes= el.querySelector('.nutrition-notes') && el.querySelector('.nutrition-notes').value.trim() || '';
      if(Date||Type||Notes) rows.push({Date:Date,Type:Type,Notes:Notes});
    }); return rows;
  }

  function collectCommunicationFromCard(card){
    var rows=[]; card.querySelectorAll('#comm-rows .comm-row').forEach(function(el){
      var Date = el.querySelector('.comm-date') && el.querySelector('.comm-date').value.trim() || '';
      var Type = el.querySelector('.comm-type') && el.querySelector('.comm-type').value.trim() || '';
      var Notes= el.querySelector('.comm-notes') && el.querySelector('.comm-notes').value.trim() || '';
      if(Date||Type||Notes) rows.push({Date:Date,Type:Type,Notes:Notes});
    }); return rows;
  }

  function collectProfileFromCard(card){
    var pane=card.querySelector('#profile'); if(!pane) return {columns:[],data:[]};
    var months=['Jan','Feb','Mar','Apr','May','June','July','Aug','Sept','Oct','Nov','Dec'];
    var goals=pane.querySelector('textarea[name="goals"]') && pane.querySelector('textarea[name="goals"]').value.trim() || '';
    var initDate=pane.querySelector('input[name="init_date"]') && pane.querySelector('input[name="init_date"]').value.trim() || '';
    var initWeight=pane.querySelector('input[name="init_weight"]') && pane.querySelector('input[name="init_weight"]').value.trim() || '';
    var lowestDate=pane.querySelector('input[name="lowest_date"]') && pane.querySelector('input[name="lowest_date"]').value.trim() || '';
    var lowestWeight=pane.querySelector('input[name="lowest_weight"]') && pane.querySelector('input[name="lowest_weight"]').value.trim() || '';
    var targetDate=pane.querySelector('input[name="target_date"]') && pane.querySelector('input[name="target_date"]').value.trim() || '';
    var targetWeight=pane.querySelector('input[name="target_weight"]') && pane.querySelector('input[name="target_weight"]').value.trim() || '';

    var nutriFlag = pane.querySelector('input[name="flag_nutrition"]') && pane.querySelector('input[name="flag_nutrition"]').checked ? 'Yes' : 'No';
    var focusFlag = pane.querySelector('input[name="flag_focus_case"]') && pane.querySelector('input[name="flag_focus_case"]').checked ? 'Yes' : 'No';

    var freq={}; var freqRow=pane.querySelector('caption + thead ~ tbody tr');
    if(freqRow){
      var tds=Array.from(freqRow.querySelectorAll('td'));
      months.forEach(function(m,i){ freq[m]=(tds[i] && tds[i].textContent || '').trim(); });
    }
    var expiration=pane.querySelector('input[name="expiration"]') && pane.querySelector('input[name="expiration"]').value.trim() || '';
    var firstSession=pane.querySelector('input[name="last_session"]') && pane.querySelector('input[name="last_session"]').value.trim() || '';

    var profileRows=[
      {Field:'Goals',Value:goals},
      {Field:'Initial Weight',Date:initDate,Weight:initWeight},
      {Field:'Lowest Weight',Date:lowestDate,Weight:lowestWeight},
      {Field:'Target Weight',Date:targetDate,Weight:targetWeight},
      {Field:'Nutrition Flag', Flag:nutriFlag},
      {Field:'Focus Case Flag', Flag:focusFlag},
      {Field:'Expiration / Remaining',Value:expiration},
      {Field:'First Session Date',Value:firstSession}
    ];

    var blanks=Array(Math.max(0, 9-(1+profileRows.length+1))).fill({});
    var monthHdr=months.reduce(function(o,m){ o[m]=m; return o; },{Field:''});
    var freqRowObj=(function(){ var o={Field:'Frequency'}; for(var k in freq){ o[k]=freq[k]; } return o; })();

    var healthFields=[
      {key:'diabetes',label:'Diabetes'},
      {key:'bp',label:'Blood Pressure Issues'},
      {key:'vertigo',label:'Dizziness / Vertigo'},
      {key:'thyroid',label:'Thyroid Imbalances'},
      {key:'heart',label:'Heart Disease'},
      {key:'spine',label:'Back / Neck Issues'},
      {key:'hips',label:'Hips Issues'},
      {key:'legs',label:'Legs Issues'},
      {key:'arms',label:'Arms Issues'},
      {key:'vascular',label:'Vascular Pathologies'},
      {key:'irregular_period',label:'Irregular Menstrual Period / Hormonal Issues'},
      {key:'menopause_years',label:'Menopause ‚Äì # of Years'},
      {key:'blood_work',label:'Blood Work Alterations'}
    ];
    var healthRows = healthFields.map(function(f){
      var flagEl = pane.querySelector('input[name="flag_'+f.key+'"]');
      var commentEl = pane.querySelector('input[name="comment_'+f.key+'"]');
      return {
        Field:f.label,
        Flag: flagEl && flagEl.checked ? 'Yes':'No',
        Comment: commentEl && commentEl.value ? commentEl.value.trim() : ''
      };
    });
    var rewardRows=Array.from(pane.querySelectorAll('#rewards-table tbody tr')).map(function(tr){
      var used=(tr.querySelector('input[name="used[]"]') && tr.querySelector('input[name="used[]"]').checked) ? 'Yes':'No';
      var tds=Array.from(tr.querySelectorAll('td'));
      return {Field:'Reward / Deal',Used:used,RewardDeal:(tds[1] && tds[1].textContent || '').trim(),RewardNotes:(tds[2] && tds[2].textContent || '').trim()};
    });
    var friendRows=Array.from(pane.querySelectorAll('#friends-table tbody tr')).map(function(tr){
      var sel=(tr.querySelector('input[name="friend-selected[]"]') && tr.querySelector('input[name="friend-selected[]"]').checked) ? 'Yes':'No';
      var tds=Array.from(tr.querySelectorAll('td'));
      return {Field:'Friend',Select:sel,FriendName:(tds[1] && tds[1].textContent || '').trim(),FriendNotes:(tds[2] && tds[2].textContent || '').trim()};
    });
    var columns=['Field','Value','Flag','Comment','Date','Weight'].concat(months).concat(['Used','RewardDeal','RewardNotes','Select','FriendName','FriendNotes']);
    return {columns:columns, data:[].concat(profileRows, blanks, monthHdr, freqRowObj, healthRows, {}, {Field:'Rewards / Deals'}, rewardRows, {}, {Field:'Friends'}, friendRows)};
  }

  /* Autosave wiring */
function wireAutosaveForCard(card, clientName){
  // --- helper to push current flag state to the sidebar row ---
  function updateSidebarFlags(name, nutriOn, focusOn){
    var rows = document.querySelectorAll('#client-panel tbody tr');
    rows.forEach(function(tr){
      var td = tr.querySelector('td.client-name');
      if (!td) return;
      if ((td.dataset.name || '').trim() !== (name || '').trim()) return;

      var flags = td.querySelector('.client-flags');
      if (!flags) {
        flags = document.createElement('span');
        flags.className = 'client-flags';
        td.appendChild(flags);
      }
      flags.innerHTML = '';
      if (nutriOn) flags.innerHTML += '<span title="Nutrition">üçé</span>';
      if (focusOn)  flags.innerHTML += '<span title="Focus Case">üéØ</span>';
    });
  }


var DEBUG = !!window.DEBUG; // or: var DEBUG = false;


  async function saveCore(){
    var sheets = {
      profile:       collectProfileFromCard(card) || {columns:[],data:[]},
      measures:      { data: collectMeasuresFromCard(card) || [] },
      workout:       { data: collectWorkoutFromCard(card)  || [] },
      workout_rev1:  { data: collectWorkoutRev1FromCard(card) || [] },
      nutrition:     { columns:['Date','Type','Notes'], data: collectNutritionFromCard(card) || [] },
      communication: { columns:['Date','Type','Notes'], data: collectCommunicationFromCard(card) || [] }
    };
    if (DEBUG) console.debug('[save ‚ñ∂]', clientName, sheets);
    var res = await fetch('/charts/client/'+encodeURIComponent(clientName)+'/save', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({ sheets:sheets })
    });
    var j = await res.json().catch(function(){ return {}; });
    if (!res.ok || j.status!=='success') throw new Error(j.message||('HTTP '+res.status));
    if (DEBUG) console.debug('[save ‚úì]', clientName);
  }

var deb = debounceSmart(saveCore, 700);
card.__saveDebounced = deb;
var maybeSave = function(){
  if (window.__rev1SuppressAutosave) return;
  deb();
};


  // Delegate input/change/blur to trigger autosave and sync flags
  var delegatedHandler = function(e){
    var el = e.target;
    if (!(el instanceof HTMLElement)) return;

    // When the hidden checkboxes change, immediately reflect that in the sidebar
    if (el.name === 'flag_nutrition' || el.name === 'flag_focus_case') {
      var nutriOn = !!(card.querySelector('input[name="flag_nutrition"]') && card.querySelector('input[name="flag_nutrition"]').checked);
      var focusOn = !!(card.querySelector('input[name="flag_focus_case"]') && card.querySelector('input[name="flag_focus_case"]').checked);
      updateSidebarFlags(clientName, nutriOn, focusOn);
    }

    if (el.matches('input, textarea, [contenteditable="true"], select')) {
      maybeSave();
    }
  };
  card.addEventListener('input',  delegatedHandler, true);
  card.addEventListener('change', delegatedHandler, true);
  card.addEventListener('blur',   delegatedHandler, true);
  card.__delegatedHandler = delegatedHandler;




  // Flush pending save on close
  card.addEventListener('card:close', function(){ deb.flush().catch(function(){}); });
}


  /* Tabs + scaling */
  function initTabs(card, initialIndex){
    if (typeof initialIndex !== 'number') initialIndex = 0;
    var tabs = card.querySelectorAll('.tab-btn');
    var panes = card.querySelectorAll('.tab-content');
    var underline = card.querySelector('#tabUnderline');
    if (!tabs.length || !underline) return;

    function activate(i){
      tabs.forEach(function(b,j){ b.classList.toggle('active', j===i); });
      panes.forEach(function(p,j){ p.classList.toggle('hidden', j!==i); });
      var r = tabs[i].getBoundingClientRect();
      var pr = tabs[i].parentElement.getBoundingClientRect();
      underline.style.width = r.width + 'px';
      underline.style.left  = (r.left - pr.left) + 'px';
      saveOpenState();
    }

    tabs.forEach(function(btn,i){
      btn.addEventListener('click', function(){
        activate(i);
        var cardEl = btn.closest('.chart-card');
        cardEl && cardEl.__saveDebounced && cardEl.__saveDebounced();
        requestAnimationFrame(function(){ scaleChart(cardEl); });
      });
    });
    activate(Math.max(0, Math.min(initialIndex, tabs.length-1)));
  }

  function scaleChart(card){
    var tgt = card.querySelector('.scale-target');
    var cnt = card.querySelector('.scale-content');
    if (!tgt || !cnt) return;

    cnt.style.overflow = 'auto';
    cnt.classList.add('hide-scrollbar');
    cnt.style.width  = '100%';
    cnt.style.height = '100%';
    cnt.style.webkitOverflowScrolling = 'touch';

    tgt.style.transformOrigin = 'top left';
    var sX = card.clientWidth  / cnt.scrollWidth;
    var sY = card.clientHeight / cnt.scrollHeight;
    var s  = Math.min(sX, sY, 1);
    tgt.style.transform = 'scale('+s+')';
  }

  function setupScaling(card){
    requestAnimationFrame(function(){ scaleChart(card); });
    var ro = new ResizeObserver(function(){ requestAnimationFrame(function(){ scaleChart(card); }); });
    ro.observe(card);
    var cnt = card.querySelector('.scale-content');
    if (cnt) ro.observe(cnt);
    card.querySelectorAll('img').forEach(function(img){ img.addEventListener('load', function(){ scaleChart(card); }, {once:true}); });
    card.__ro = ro;
  }

  /* ---------- Row reordering (grip + lift + hints + RAF throttle + autoscroll) ---------- */
  function injectRowGrips(tbody, opts){
    if (!tbody) return;
    opts = opts || {};
    var numbered = !!opts.numbered;

    Array.from(tbody.querySelectorAll('tr')).forEach(function(tr, idx){
      var firstTd = tr.querySelector('td');
      if (!firstTd) return;
      if (getComputedStyle(firstTd).position === 'static') firstTd.style.position = 'relative';

      if (numbered){
        if (!firstTd.querySelector('.row-index')){
          var currentNum = (firstTd.textContent || '').trim();
          firstTd.textContent = '';
          var idxSpan = document.createElement('span');
          idxSpan.className = 'row-index';
          idxSpan.textContent = currentNum || (idx+1);
          firstTd.appendChild(idxSpan);
        }
      }

      if (!firstTd.querySelector('.row-grip')){
        var grip = document.createElement('span');
        grip.className = 'row-grip'; grip.title = 'Drag to reorder';
        grip.textContent = ''; grip.setAttribute('draggable','true');
        grip.setAttribute('aria-label','Drag to reorder');
        firstTd.insertBefore(grip, firstTd.firstChild);
      }
    });
  }

  function renumberIfNeeded(tbody){
    if (!tbody) return;
    var th = tbody.closest('table') && tbody.closest('table').querySelector('thead th:first-child');
    var numbered = th && (th.textContent || '').trim() === '#';
    if (!numbered) return;
    Array.from(tbody.querySelectorAll('tr')).forEach(function(tr, i){
      var span = tr.querySelector('td .row-index');
      if (span) span.textContent = String(i+1);
    });
  }

  function makeTableRowsSortable(tbody, onDrop){
    if (!tbody) return;

    var draggingRow = null;
    var hoverRow = null;
    var endHintRow = null;
    var rafPending = false;
    var lastY = 0;

    function clearHints(){
      if (hoverRow){ hoverRow.classList.remove('drag-over-top','drag-over-bottom'); hoverRow = null; }
      if (endHintRow){ endHintRow.classList.remove('drag-over-bottom'); endHintRow = null; }
    }

    function findTarget(y){
      var rows = Array.from(tbody.querySelectorAll('tr:not(.dragging)'));
      var closest = { offset: Number.NEGATIVE_INFINITY, element: null };
      for (var i=0;i<rows.length;i++){
        var box = rows[i].getBoundingClientRect();
        var offset = y - box.top - box.height/2;
        if (offset < 0 && offset > closest.offset){
          closest = { offset: offset, element: rows[i] };
        }
      }
      return closest.element;
    }

    function autoScroll(y){
      var scroller = tbody.closest('.chart-body');
      if (!scroller) return;
      var rect = scroller.getBoundingClientRect();
      var margin = 40;
      var speed  = 12;

      if (y < rect.top + margin){ scroller.scrollTop -= speed; }
      else if (y > rect.bottom - margin){ scroller.scrollTop += speed; }
    }

    function processDrag(){
      rafPending = false;
      if (!draggingRow) return;

      var eY = lastY;
      autoScroll(eY);

      var target = findTarget(eY);
      clearHints();

      if (target) {
        hoverRow = target;
        hoverRow.classList.add('drag-over-top');
        if (hoverRow !== draggingRow) tbody.insertBefore(draggingRow, hoverRow);
      } else {
        var rows = Array.from(tbody.querySelectorAll('tr:not(.dragging)'));
        var lastRow = rows[rows.length-1];
        if (lastRow){
          endHintRow = lastRow;
          endHintRow.classList.add('drag-over-bottom');
          if (draggingRow.nextSibling !== null) tbody.appendChild(draggingRow);
        }
      }
    }

    tbody.addEventListener('dragstart', function(e){
      var grip = e.target.closest('.row-grip');
      if (!grip) { e.preventDefault(); return; }
      draggingRow = grip.closest('tr');
      if (!draggingRow) { e.preventDefault(); return; }
      draggingRow.classList.add('dragging');
      try { e.dataTransfer.setData('text/plain',''); } catch(_) {}
      e.dataTransfer.effectAllowed = 'move';

      var rect = draggingRow.getBoundingClientRect();
      var ghost = document.createElement('div');
      ghost.style.cssText = `
        width:${rect.width}px;height:${rect.height}px;
        box-shadow:0 12px 24px rgba(0,0,0,.16);
        border-radius:8px;background:#fff;opacity:.95;
        display:flex;align-items:center;padding:0 12px;font-weight:600;
      `;
      var firstInput = draggingRow.querySelector('input');
      ghost.textContent = (firstInput && firstInput.value) ? firstInput.value : 'Moving row';
      document.body.appendChild(ghost);
      e.dataTransfer.setDragImage(ghost, rect.width/2, rect.height/2);
      setTimeout(function(){ ghost.remove(); }, 0);
    });

    tbody.addEventListener('dragend', function(){
      if (draggingRow) draggingRow.classList.remove('dragging');
      draggingRow = null;
      clearHints();
    });

    tbody.addEventListener('dragover', function(e){
      if (!draggingRow) return;
      e.preventDefault();
      e.dataTransfer.dropEffect = 'move';
      lastY = e.clientY;
      if (!rafPending){
        rafPending = true;
        requestAnimationFrame(processDrag);
      }
    });

    tbody.addEventListener('drop', function(e){
      e.preventDefault();
      clearHints();
      renumberIfNeeded(tbody);
      if (typeof onDrop === 'function') onDrop();
    });
  }

  function enableRowReorder(card){
    var wrBody = card.querySelector('#workout-rev1 table tbody');
    injectRowGrips(wrBody, { numbered: true });
    makeTableRowsSortable(wrBody, function(){ card.__saveDebounced && card.__saveDebounced(); });

    var gkBody = card.querySelector('#gk-rev1-section table tbody');
    injectRowGrips(gkBody, { numbered: false });
    makeTableRowsSortable(gkBody, function(){ card.__saveDebounced && card.__saveDebounced(); });
  }

/* ---- Workout Rev1: sticky toolbar + Apply/Clear + blocks (ES5/Promise) ---- */
var initWorkoutRev1 = function (card) {
  return new Promise(function (resolve) {
    var base = card.querySelector('#workout-rev1');
    if (!base) { resolve(); return; }

    // 1) Sticky toolbar (no :scope usage)
    (function ensureStickyToolbar() {
      var all  = Array.prototype.slice.call(base.querySelectorAll('.flex.items-center'));
      var rows = all.filter(function (el) { return el && el.parentElement === base; });
      if (!rows.length) return;
      var first = rows[0];
      var second = rows[1] || null;
      if (first && !first.parentElement.classList.contains('rev1-toolbar-wrap')) {
        var wrap = document.createElement('div');
        wrap.className = 'rev1-toolbar-wrap';
        base.insertBefore(wrap, first);
        wrap.appendChild(first);
        if (second) wrap.appendChild(second);
      }
      function measure() {
        var wrap = base.querySelector('.rev1-toolbar-wrap');
        var h = wrap ? Math.ceil(wrap.getBoundingClientRect().height) : 0;
        base.style.setProperty('--wr1-stick-top', h + 'px');
      }
      measure();
      window.addEventListener('resize', measure);
      setTimeout(measure, 50);
    })();

    var clientName = card.dataset.client || '';
    var LS_KEY = 'fig:wr1:type:' + clientName;

    function getBlocksFromTemplate() {
      var t = card.querySelector('template#workout-blocks-json');
      if (!t) return null;
      try {
        var raw = (t.textContent || '').trim();
        return raw ? JSON.parse(raw) : null;
      } catch (e) {
        console.error('Failed to parse blocks template JSON', e);
        return null;
      }
    }
    function getBlocksFallback() {
      if (window.__WR1_BLOCK_CACHE__) return Promise.resolve(window.__WR1_BLOCK_CACHE__);
      return fetch('/charts/blocks.json', { cache: 'no-store' })
        .then(function (r) { return r.json(); })
        .then(function (j) {
          window.__WR1_BLOCK_CACHE__ = j.blocks || {};
          return window.__WR1_BLOCK_CACHE__;
        })
        .catch(function (e) {
          console.error('Failed to fetch /charts/blocks.json', e);
          return {};
        });
    }

    var gkBox   = base.querySelector('#gk-rev1-section');
    var sel     = base.querySelector('#workout-rev1-type');
    var msgEl   = base.querySelector('#workout-rev1-msg');
    var kgEl    = base.querySelector('#workout-rev1-kg');
    var toolsEl = base.querySelector('#workout-rev1-tools');
    function setMsg(t) { if (msgEl) msgEl.textContent = t || ''; }

function __readMainRows() {
  var out = [];
  var wrk = base.querySelectorAll('.rev1-workout');
  var rng = base.querySelectorAll('.rev1-rings');
  var nts = base.querySelectorAll('.rev1-notes');
  var n = Math.max(wrk.length, rng.length, nts.length, 16);
  for (var i = 0; i < n; i++) {
    out.push({
      Workout: (wrk[i] && wrk[i].value ? wrk[i].value.trim() : ''),
      Rings:   (rng[i] && rng[i].value ? rng[i].value.trim() : ''),
      Notes:   (nts[i] && nts[i].value ? nts[i].value.trim() : '')
    });
  }
  return out;
}


// === MAIN ROWS PERSIST START (per client) ===
// (must be inside initWorkoutRev1 ‚Üí afterBlocks so `card` and `base` exist)
var ROWS_KEY        = 'fig:wr1:rows:' + (card.dataset.client || '');
var JUSTCLEARED_KEY = 'fig:wr1:justcleared:' + (card.dataset.client || '');

function __tableHasAnyValue() {
  var wrk = base.querySelectorAll('.rev1-workout');
  var rng = base.querySelectorAll('.rev1-rings');
  var nts = base.querySelectorAll('.rev1-notes');
  var n = Math.max(wrk.length, rng.length, nts.length, 16);
  for (var i = 0; i < n; i++) {
    if ((wrk[i] && wrk[i].value && wrk[i].value.trim()) ||
        (rng[i] && rng[i].value && rng[i].value.trim()) ||
        (nts[i] && nts[i].value && nts[i].value.trim())) {
      return true;
    }
  }
  return false;
}

function __writeMainRows(rows) {
  var wrk = base.querySelectorAll('.rev1-workout');
  var rng = base.querySelectorAll('.rev1-rings');
  var nts = base.querySelectorAll('.rev1-notes');
  var n = Math.max(wrk.length, rng.length, nts.length, rows ? rows.length : 0);
  for (var i = 0; i < n; i++) {
    var src = (rows && rows[i]) || { Workout: '', Rings: '', Notes: '' };
    // Only fill if currently empty to avoid overwriting server-rendered values
    if (wrk[i] && !wrk[i].value.trim()) wrk[i].value = src.Workout || '';
    if (rng[i] && !rng[i].value.trim()) rng[i].value = src.Rings   || '';
    if (nts[i] && !nts[i].value.trim()) nts[i].value = src.Notes   || '';
  }
}

function __saveRowsToLocal() {
  try { localStorage.setItem(ROWS_KEY, JSON.stringify(__readMainRows())); } catch(_) {}
  card.__saveDebounced && card.__saveDebounced();
}

function __loadRowsFromLocal() {
  // If we *just* cleared, skip rehydration once
  var jc = null;
  try { jc = localStorage.getItem(JUSTCLEARED_KEY); } catch(_) {}
  if (jc) {
    try { localStorage.removeItem(JUSTCLEARED_KEY); } catch(_) {}
    return;
  }

  // If server already rendered values (e.g., Notes), don't overwrite
  if (__tableHasAnyValue()) return;

  var raw = null;
  try { raw = localStorage.getItem(ROWS_KEY); } catch(_) {}
  if (!raw) return;

  var rows = [];
  try { rows = JSON.parse(raw) || []; } catch(_) { rows = []; }
  if (rows && rows.length) __writeMainRows(rows);
}


function __clearRowsLocal() { try { localStorage.removeItem(ROWS_KEY); } catch(_) {} }

// Save when user types in main 16-row table
base.addEventListener('input', function(ev){
  var t = ev.target;
  if (!(t instanceof HTMLElement)) return;
  if (t.classList && (t.classList.contains('rev1-workout') ||
                      t.classList.contains('rev1-rings')   ||
                      t.classList.contains('rev1-notes'))) {
    __saveRowsToLocal();
  }
}, true);

base.addEventListener('change', function(ev){
  var t = ev.target;
  if (!(t instanceof HTMLElement)) return;
  if (t.classList && (t.classList.contains('rev1-workout') ||
                      t.classList.contains('rev1-rings')   ||
                      t.classList.contains('rev1-notes'))) {
    __saveRowsToLocal();
  }
}, true);
// === MAIN ROWS PERSIST END ===









// ---- GK local persistence (per client) ----
var GK_KEY = 'fig:wr1:gk:' + (card.dataset.client || '');

function __readGKRows() {
  var out = [];
  var rows = base.querySelectorAll('#gk-rev1-section tbody tr');
  rows.forEach(function(tr){
    var ins = tr.querySelectorAll('input');
    if (!ins || ins.length < 3) return;
    out.push({
      Workout: (ins[0].value || '').trim(),
      Rings:   (ins[1].value || '').trim(),
      Notes:   (ins[2].value || '').trim()
    });
  });
  return out;
}

function __writeGKRows(rows) {
  var rowsDom = base.querySelectorAll('#gk-rev1-section tbody tr');
  rowsDom.forEach(function(tr, i){
    var src = rows[i] || {Workout:'',Rings:'',Notes:''};
    var ins = tr.querySelectorAll('input');
    if (!ins || ins.length < 3) return;
    // Only set if empty to avoid overwriting freshly loaded server data
    if (!ins[0].value.trim()) ins[0].value = src.Workout || '';
    if (!ins[1].value.trim()) ins[1].value = src.Rings   || '';
    if (!ins[2].value.trim()) ins[2].value = src.Notes   || '';
  });
}

function __saveGKToLocal() {
  try { localStorage.setItem(GK_KEY, JSON.stringify(__readGKRows())); } catch(_) {}
  // also trigger your autosave
  card.__saveDebounced && card.__saveDebounced();
}

function __loadGKFromLocal() {
  var raw = null;
  try { raw = localStorage.getItem(GK_KEY); } catch(_) {}
  if (!raw) return;
  var rows = [];
  try { rows = JSON.parse(raw) || []; } catch(_) { rows = []; }
  if (rows && rows.length) __writeGKRows(rows);
}

function __clearGKLocal() {
  try { localStorage.removeItem(GK_KEY); } catch(_) {}
}

// Save on any GK input
if (gkBox) {
  gkBox.addEventListener('input', __saveGKToLocal, true);
  gkBox.addEventListener('change', __saveGKToLocal, true);
}




    // Per-program KG/Tools memoization
    var KT_KEY = 'fig:wr1:kgtools:' + clientName;
    function ktRead()  { try { return JSON.parse(localStorage.getItem(KT_KEY) || '{}') || {}; } catch (_) { return {}; } }
    function ktWrite(m){ try { localStorage.setItem(KT_KEY, JSON.stringify(m || {})); } catch (_) {} }
    function ktGet(type){ var m = ktRead(); return m[type] || { kg: '', tools: '' }; }
    function ktSet(type, kg, tools) { var m = ktRead(); m[type] = { kg: kg || '', tools: tools || '' }; ktWrite(m); }
    function currentTypeKey(){ return (sel && sel.value ? sel.value : '').toUpperCase().replace(/\s+/g, ''); }

    function afterBlocks(BLOCKS) {
      // Populate select with keys from blocks
      (function populateProgramOptions() {
        if (!sel) return;
        var have = {};
        Array.prototype.slice.call(sel.options).forEach(function (o) { have[o.value] = true; });
        var allKeys = Object.keys(BLOCKS || {});
        allKeys.sort(function (a, b) {
          function pref(k) { return k.indexOf('C') === 0 ? 0 : (k.indexOf('V') === 0 ? 1 : (k.indexOf('TO') === 0 ? 2 : 3)); }
          var ai = pref(a), bi = pref(b);
          if (ai !== bi) return ai - bi;
          var na = parseInt(a.replace(/\D/g, ''), 10) || 0;
          var nb = parseInt(b.replace(/\D/g, ''), 10) || 0;
          if (a.indexOf('TO') === 0 && b.indexOf('TO') === 0) return na - nb;
          if (a[0] === b[0]) return na - nb;
          return a.localeCompare(b);
        });
        allKeys.forEach(function (k) {
          if (!have[k]) {
            var opt = document.createElement('option');
            opt.value = k; opt.textContent = k;
            sel.appendChild(opt);
          }
        });
      })();

if (sel) {
  sel.addEventListener('change', function () {
    // remember selection for this client
    try { localStorage.setItem(LS_KEY, sel.value || ''); } catch (_) {}

    // fill table & GK defaults (only into *empty* inputs)
    fill(sel.value || '');

    // persist per-program KG/Tools memo now that we may have meta defaults
    var key = currentTypeKey();
    if (key) ktSet(key, kgEl ? kgEl.value : '', toolsEl ? toolsEl.value : '');

    // save the 16 rows + GK to local drafts (so reopening restores Notes, etc.)
    try { __saveRowsToLocal(); } catch(_) {}
    try { __saveGKToLocal(); } catch(_) {}

    // kick the debounced server save
    card.__saveDebounced && card.__saveDebounced();
  });
}

      function saveKTForCurrent() {
        var key = currentTypeKey(); if (!key) return;
        ktSet(key, kgEl ? kgEl.value : '', toolsEl ? toolsEl.value : '');
      }
      if (kgEl)    { kgEl.addEventListener('input', saveKTForCurrent);  kgEl.addEventListener('change', saveKTForCurrent); }
      if (toolsEl) { toolsEl.addEventListener('input', saveKTForCurrent); toolsEl.addEventListener('change', saveKTForCurrent); }

      function fill(code) {
        var key = (code || '').toUpperCase().replace(/\s+/g, '');
        var block = (BLOCKS || {})[key];
        if (!block) { setMsg('‚Äú' + code + '‚Äù not found.'); return; }
        setMsg('');

        // Per-program KG/Tools (block meta > memo)
        var metaKG =
          (block && (block.KG || (block.meta && block.meta.KG))) ||
          (block && block.rows && block.rows[0] && block.rows[0].KG) || '';
        var metaTools =
          (block && (block.Tools || (block.meta && block.meta.Tools))) ||
          (block && block.rows && block.rows[0] && block.rows[0].Tools) || '';

        var memo = ktGet(key);
        if (kgEl)    kgEl.value    = (metaKG !== '' && metaKG != null) ? String(metaKG) : (memo.kg || '');
        if (toolsEl) toolsEl.value = (metaTools !== '' && metaTools != null) ? String(metaTools) : (memo.tools || '');
        ktSet(key, kgEl ? kgEl.value : '', toolsEl ? toolsEl.value : '');

        // Main 16 rows (fill empties only)
        var wrk = Array.prototype.slice.call(base.querySelectorAll('.rev1-workout'));
        var rng = Array.prototype.slice.call(base.querySelectorAll('.rev1-rings'));
        var nts = Array.prototype.slice.call(base.querySelectorAll('.rev1-notes'));
        for (var i = 0; i < 16; i++) {
          var row = (block.rows && block.rows[i]) || { Workout: '', Rings: '', Notes: '' };
          if (wrk[i] && !wrk[i].value.trim()) wrk[i].value = row.Workout || '';
          if (rng[i] && !rng[i].value.trim()) rng[i].value = row.Rings   || '';
          if (nts[i] && !nts[i].value.trim()) nts[i].value = row.Notes   || '';
        }

        // GK
        var showGK = /^TO\d+$/i.test(key);
        if (gkBox) gkBox.classList.toggle('hidden', !showGK);

        var gkRows  = Array.prototype.slice.call(base.querySelectorAll('#gk-rev1-section tbody tr'));
        var gkBlock = (block && (block.GK != null ? block.GK : block.gk));
        var gks;
        if (Object.prototype.toString.call(gkBlock) === '[object Array]') {
          gks = gkBlock;
        } else if (gkBlock && Object.prototype.toString.call(gkBlock.rows) === '[object Array]') {
          gks = gkBlock.rows;
        } else {
          gks = [];
        }

        var gkData = [];
        for (var jj = 0; jj < gks.length; jj++) {
          var it = gks[jj];
          if (typeof it === 'string') {
            gkData.push({ Workout: it, Rings: '', Notes: '' });
          } else {
            gkData.push({
              Workout: __toGKText(it),
              Rings:   (it && it.Rings) || '',
              Notes:   (it && it.Notes) || ''
            });
          }
        }
        if (!gkData.length && showGK && window.GK_DEFAULTS && window.GK_DEFAULTS[key]) {
          gkData = window.GK_DEFAULTS[key].map(function (it) {
            return { Workout: __toGKText(it), Rings: (it && it.Rings) || 'I', Notes: (it && it.Notes) || '' };
          });
        }

        gkRows.forEach(function (tr, idx) {
          var inputs = tr.querySelectorAll('input');
          if (!inputs || inputs.length < 3) return;
          var src = gkData[idx] || { Workout: '', Rings: '', Notes: '' };
          if (!inputs[0].value.trim()) inputs[0].value = src.Workout || '';
          if (!inputs[1].value.trim()) inputs[1].value = src.Rings   || '';
          if (!inputs[2].value.trim()) inputs[2].value = src.Notes   || '';
        });
      }

function clearAll() {
  setMsg('');

  // 1) Suppress autosave & cancel any pending run
  window.__rev1SuppressAutosave = true;
  if (card.__saveDebounced && card.__saveDebounced.cancel) {
    card.__saveDebounced.cancel();
  }

  // 2) Visually clear inputs
  Array.prototype.slice.call(base.querySelectorAll('input.rev1-workout, input.rev1-rings, input.rev1-notes'))
    .forEach(function (i) { i.value = ''; });
  Array.prototype.slice.call(base.querySelectorAll('#gk-rev1-section tbody tr input'))
    .forEach(function (i) { i.value = ''; });
  if (gkBox) gkBox.classList.add('hidden');

  // 3) Reset KG/Tools and per-program memo
  var key = currentTypeKey();
  if (key) ktSet(key, '', '');
  if (kgEl) kgEl.value = '';
  if (toolsEl) toolsEl.value = '';

  // 4) Nuke local drafts
  __clearRowsLocal();
  __clearGKLocal();

  // 5) Persist clear on the server and mark ‚Äújust cleared‚Äù so drafts won‚Äôt rehydrate on reload
  (async function persistClear(){
    try {
      const res = await fetch('/charts/client/' + encodeURIComponent(card.dataset.client || '') + '/workout-rev1/clear', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' }
      });
      if (!res.ok) throw new Error('HTTP ' + res.status);
      try { localStorage.setItem(JUSTCLEARED_KEY, '1'); } catch(_) {}
    } catch (err) {
      console.error('Clear failed:', err);
    } finally {
      // 6) Re-enable autosave after the UI is stable
      setTimeout(function(){ window.__rev1SuppressAutosave = false; }, 250);
    }
  })();
}




      card.addEventListener('click', function (e) {
        var t = e.target;
        if (!(t instanceof HTMLElement)) return;

if (t.id === 'rev1-apply' || t.id === 'workout-rev1-apply') {
  e.preventDefault();
  var v = (sel && sel.value) || '';
  try { localStorage.setItem(LS_KEY, v); } catch (_) {}
  fill(v); // fills main 16 rows and GK defaults for TO*

  // Persist both main rows and GK immediately after Apply
  try { __saveRowsToLocal(); } catch(_) {}
  try { __saveGKToLocal(); } catch(_) {}

  var key = currentTypeKey();
  if (key) ktSet(key, kgEl ? kgEl.value : '', toolsEl ? toolsEl.value : '');
  card.__saveDebounced && card.__saveDebounced();
}



      });

      if (sel) sel.addEventListener('keydown', function (e) {
        if (e.key === 'Enter') {
          e.preventDefault();
          var v = sel.value || '';
          try { localStorage.setItem(LS_KEY, v); } catch (_) {}
          fill(v);
          var key = currentTypeKey();
          if (key) ktSet(key, kgEl ? kgEl.value : '', toolsEl ? toolsEl.value : '');
          card.__saveDebounced && card.__saveDebounced();
        }
      });

      // Restore last-used Type (do NOT overwrite table inputs)
      try {
        var last = localStorage.getItem(LS_KEY);
        if (last && sel) {
          sel.value = last;
          var gkSec = base.querySelector('#gk-rev1-section');
          if (gkSec) gkSec.classList.toggle('hidden', !/^TO\d$/i.test(last));
          var memo = ktGet(last.toUpperCase().replace(/\s+/g, ''));
          if (kgEl && typeof memo.kg === 'string') kgEl.value = memo.kg;
          if (toolsEl && typeof memo.tools === 'string') toolsEl.value = memo.tools;
        }
      } catch (_) {}

__loadGKFromLocal();
__loadRowsFromLocal(); // restore 16-row table (Workout/Rings/Notes), doesn't overwrite non-empty inputs


      // initial GK visibility
      if (sel && sel.value && sel.value.toUpperCase().indexOf('TO') === 0) {
        if (gkBox) gkBox.classList.remove('hidden');
      } else {
        if (gkBox) gkBox.classList.add('hidden');
      }
    } // end afterBlocks

    var BLOCKS = getBlocksFromTemplate();
    if (!BLOCKS || !Object.keys(BLOCKS).length) {
      getBlocksFallback().then(
        function (b) { afterBlocks(b || {}); resolve(); },
        function ()  { afterBlocks({});     resolve(); }
      );
    } else {
      afterBlocks(BLOCKS);
      resolve();
    }
  }); // closes new Promise
};   // closes var initWorkoutRev1 = function




/* Load a card‚Äôs HTML (strip scripts) ‚Äî Promise, no await */
function loadCardContent(card, name, initialTab){
  if (typeof initialTab !== 'number') initialTab = 0;
  var controller = new AbortController();
  card.__abortController = controller;

  return fetch('/charts/client/'+encodeURIComponent(name), { signal: controller.signal, cache:'no-store' })
    .then(function(res){
      if (!res.ok) throw new Error('HTTP '+res.status);
      return res.text();
    })
    .then(function(html){
      if (!chartPanel.contains(card)) return;
      var body = card.querySelector('.chart-body');
      var wrapper = document.createElement('div');
      wrapper.innerHTML = html;
      Array.prototype.slice.call(wrapper.querySelectorAll('script')).forEach(function(s){ s.remove(); });

body.innerHTML = '';
Array.prototype.slice.call(wrapper.childNodes).forEach(function(n){ body.appendChild(n); });

initTabs(card, initialTab);
setupScaling(card);
wireAutosaveForCard(card, name);

// ‚úÖ wire row dragging now that DOM is in place
enableRowReorder(card);

return initWorkoutRev1(card);

    })
    .then(function(){ saveOpenState(); })
    .catch(function(err){
      if (!controller.signal.aborted){
        var body2 = card.querySelector('.chart-body');
        body2.innerHTML = '<div style="padding:1rem;color:#b91c1c">Failed to load. Click to retry.</div>';
        body2.addEventListener('click', function(){ loadCardContent(card, name, initialTab); }, { once:true });
        console.error('Load error:', err);
      }
    })
    .finally(function(){ delete card.__abortController; });
}

/* Add a card ‚Äî Promise, no await */
function addCard(name, opts){
  if (!opts) opts = {};
  var key = normKey(name);
  if (!key) return Promise.resolve();

  if (openCards.has(key)){
    var existing = openCards.get(key);
    existing.scrollIntoView({behavior:'smooth', block:'nearest', inline:'nearest'});
    var hdr = existing.querySelector('.chart-header');
    if (hdr){ hdr.classList.add('flash'); setTimeout(function(){ hdr.classList.remove('flash'); },800); }
    return Promise.resolve();
  }
  if (chartPanel.querySelectorAll('.chart-card').length >= 4) return Promise.resolve();

  var card = document.createElement('div');
  card.className = 'chart-card panel';
  card.dataset.client = name;
  card.innerHTML = ''
    + '<div class="scale-target">'
    + '  <div class="scale-content">'
    + '    <div class="chart-header">'
    + '      <span class="truncate">'+name+'</span>'
    + '      <span>'
    + '        <button class="chart-edit" title="Highlight Edit Mode">‚úé</button>'
    + '        <button class="chart-close" title="Close">√ó</button>'
    + '      </span>'
    + '    </div>'
    + '    <div class="chart-body">Loading...</div>'
    + '  </div>'
    + '</div>';
  chartPanel.appendChild(card);
  openCards.set(key, card);
  rebuildCards();

  card.querySelector('.chart-edit').addEventListener('click', function(){ card.classList.toggle('editing'); });
  card.querySelector('.chart-close').addEventListener('click', function(){
    var flushP = (card.__saveDebounced && card.__saveDebounced.flush) ? card.__saveDebounced.flush() : Promise.resolve();
    flushP.finally(function(){
      card.dispatchEvent(new CustomEvent('card:close'));
      if (card.__delegatedHandler){
        card.removeEventListener('input',  card.__delegatedHandler, true);
        card.removeEventListener('change', card.__delegatedHandler, true);
        card.removeEventListener('blur',   card.__delegatedHandler, true);
      }
      if (card.__ro) { try{ card.__ro.disconnect(); }catch(_){} }
      if (card.__abortController) { try{ card.__abortController.abort(); }catch(_){} }
      openCards.delete(key);
      card.remove();
      rebuildCards();
      saveOpenState();
    });
  });

  var tabIdx = (Number.isInteger && Number.isInteger(opts.initialTab)) ? opts.initialTab : 0;
  return loadCardContent(card, name, tabIdx);
}

/* Open from sidebar + resize + restore (unchanged) */
document.getElementById('client-panel').addEventListener('click', function(e){
  var td = e.target.closest('td.client-name'); if (!td) return;
  addCard(td.dataset.name).then(saveOpenState);
});

window.addEventListener('resize', function(){
  updateCardWidths();
  Array.prototype.slice.call(chartPanel.querySelectorAll('.chart-card'))
    .forEach(function(c){ scaleChart(c); });
});

restoreOpenState();

;
</script>
{% endblock %}
