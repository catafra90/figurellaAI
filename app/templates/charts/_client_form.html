{# app/templates/charts/_client_form.html #}
<div class="space-y-6" id="client-chart-root"
     data-client="{{ client }}"
     data-workout-blocks='{{ workout_blocks_json | tojson }}'>

  <style>
    /* ===== Design tokens ===== */
    :root{
      --fig-pink:#CC0066;
      --fig-pink-600:#AA0055;
      --ink:#0f172a;
      --muted:#6b7280;
      --line:#e5e7eb;       /* gray-200 */
      --panel:#ffffff;      /* card bg */
      --zebra:#f3f4f6;      /* very light row */
      --hover:#eef2f7;
      --ring:#d1d5db;       /* control border */
      --head:#f9fafb;
    }

    /* ===== Tabs ===== */
    .tabs-list{display:flex;gap:1rem;list-style:none;margin:0;padding:0;overflow-x:auto;white-space:nowrap}
    .tabs-list::-webkit-scrollbar{display:none}
    .tabs-list{-ms-overflow-style:none;scrollbar-width:none}
    .tab-btn{background:none;border:none;cursor:pointer;font-weight:600;transition:color .2s,border-color .2s}
    .tab-btn.active{color:var(--fig-pink);border-color:var(--fig-pink)}
    .tab-btn:hover{color:var(--fig-pink-600);border-color:var(--fig-pink-600)}
    .tab-btn:focus{outline:2px solid var(--fig-pink);outline-offset:2px}
    .tabs-wrapper{position:relative}
    #tabUnderline{position:absolute;bottom:0;height:2px;background:var(--fig-pink);transition:left .3s,width .3s}

    /* ===== Neutral zebra ===== */
    .zebra-pink tbody tr:nth-child(even){background-color:var(--zebra)!important}
    .zebra-pink tbody tr:nth-child(even)>th,
    .zebra-pink tbody tr:nth-child(even)>td{background-color:var(--zebra)!important}
    .zebra-pink tbody tr:hover>td,
    .zebra-pink tbody tr:hover>th{background-color:var(--hover)}

    /* ===== Sticky headers / scroll ===== */
    .sticky-header thead th{position:sticky;top:0;background:var(--head);z-index:10}
    .scrollable-table{max-height:300px;overflow-y:auto}

    /* ===== Cards / tables / controls ===== */
    .card{background:var(--panel);border:1px solid var(--line);border-radius:.75rem;box-shadow:0 1px 2px rgba(0,0,0,.04)}
    .card-pad{padding:1rem}
    table.clean{width:100%;border-collapse:separate;border-spacing:0}
    table.clean thead th{font-weight:600;color:#374151;border-bottom:1px solid var(--line);padding:.6rem;background:var(--head)}
    table.clean td{border-bottom:1px solid var(--line);padding:.55rem}
    table.clean.compact th,table.clean.compact td{padding:.35rem .45rem}

    .field{border:1px solid var(--ring);border-radius:.375rem;padding:.35rem .55rem;background:#fff}
    .select{border:1px solid var(--ring);border-radius:.5rem;padding:.35rem .65rem;background:#fff;appearance:none;background-image:linear-gradient(45deg,transparent 50%,#999 50%),linear-gradient(135deg,#999 50%,transparent 50%),linear-gradient(to right,transparent,transparent);background-position:calc(100% - 18px) calc(50% + 1px),calc(100% - 12px) calc(50% + 1px),100% 0;background-size:6px 6px,6px 6px,2.5rem 100%;background-repeat:no-repeat}
    .btn{border:1px solid var(--ring);background:#fff;border-radius:.5rem;padding:.45rem .8rem;font-weight:600}
    .btn:hover{border-color:var(--fig-pink)}
    .btn-primary{background:var(--fig-pink);color:#fff;border-color:var(--fig-pink)}
    .btn-primary:hover{background:var(--fig-pink-600);border-color:var(--fig-pink-600)}

    /* ===== Rev1 toolbar ===== */
    .rev1-toolbar{position:sticky;top:64px;z-index:20;background:rgba(255,255,255,.9);backdrop-filter:saturate(180%) blur(6px);border-bottom:1px solid var(--line)}
    .toolbar-row{display:flex;align-items:center;gap:.5rem;padding:.65rem .75rem}
    .toolbar-sp{margin-left:auto;display:flex;align-items:center;gap:.5rem}
    .toggle{width:36px;height:20px;appearance:none;outline:none;border:1px solid var(--ring);border-radius:999px;position:relative;background:#fff;cursor:pointer}
    .toggle:checked{background:var(--fig-pink);border-color:var(--fig-pink)}
    .toggle:before{content:"";position:absolute;top:2px;left:2px;width:16px;height:16px;background:#fff;border-radius:999px;transition:left .15s}
    .toggle:checked:before{left:18px}

    /* ===== Rev1 layout widths (Workout narrower, Notes wider) ===== */
    :root{
      --rev1-num: 56px;                           /* "#" column */
      --rev1-rings: 132px;                        /* Rings column (slimmer / close) */
      /* Make Workout about half its previous size; Notes takes the gain */
      --rev1-workout: clamp(240px, 22vw, 420px);  /* narrower workout */
      --rev1-notes:   clamp(560px, 58vw, 1100px); /* much wider notes */
    }
    #rev1-table{ table-layout: fixed; }
    #rev1-table col.num     { width: var(--rev1-num); }
    #rev1-table col.workout { width: var(--rev1-workout); }
    #rev1-table col.rings   { width: var(--rev1-rings); }
    #rev1-table col.notes   { width: var(--rev1-notes); }
    #rev1-table td, #rev1-table th{ padding:.40rem .40rem; }
    #rev1-table .field{ padding:.30rem .45rem; }
  </style>

  <div class="border-b mb-4 tabs-wrapper">
    <ul class="tabs-list">
      <li><button class="tab-btn px-4 py-2 border-b-2 border-figurella active" data-tab="profile">Profile</button></li>
      <li><button class="tab-btn px-4 py-2 border-b-2 border-transparent" data-tab="measures">Measures</button></li>
      <li><button class="tab-btn px-4 py-2 border-b-2 border-transparent" data-tab="workout">Workout</button></li>
      <li><button class="tab-btn px-4 py-2 border-b-2 border-transparent" data-tab="workout-rev1">Workout Rev1</button></li>
      <li><button class="tab-btn px-4 py-2 border-b-2 border-transparent" data-tab="nutrition">Nutrition</button></li>
      <li><button class="tab-btn px-4 py-2 border-b-2 border-transparent" data-tab="communication">Communication</button></li>
    </ul>
    <span id="tabUnderline"></span>
  </div>

  <!-- Profile -->
  <div id="profile" class="tab-content space-y-6 p-4">
    {% include 'charts/_header_table.html' %}
  </div>

  <!-- Measures -->
  <div id="measures" class="tab-content hidden space-y-6 p-4">
    <style>#measures .scrollable-table { max-height: none; overflow-y: visible; }</style>
    <h2 class="text-lg font-semibold mb-2">Measures</h2>
    <div class="card card-pad scrollable-table mb-6">
      {% include 'charts/_measures_table.html' %}
    </div>
  </div>

  {# ===== Workout (original) â€“ visual refresh, behavior unchanged ===== #}
  <div id="workout" class="tab-content hidden space-y-4 p-4">
    {% set wdata = (sheets['workout'].data if sheets and sheets.get('workout') and sheets['workout'].data else []) %}
    {% set has_meta = wdata and ('KG' in wdata[0] or 'Tools' in wdata[0] or 'Stretching' in wdata[0]) %}
    {% set offset = 1 if has_meta else 0 %}
    {% set wrec = (wdata[0] if has_meta else {}) %}

    <h2 class="text-lg font-semibold">Program</h2>

    <div class="card card-pad">
      <div class="flex items-center gap-3 mb-3">
        <label for="workout-kg" class="font-medium">KG :</label>
        <input id="workout-kg" name="workout_kg" type="text" value="{{ wrec.get('KG','') }}" class="field w-24"/>
        <label for="workout-tools" class="font-medium ml-4">Tools :</label>
        <input id="workout-tools" name="workout_tools" type="text" value="{{ wrec.get('Tools','') }}" class="field w-64"/>
      </div>

      <div class="overflow-x-auto">
        <table class="clean zebra-pink sticky-header">
          <thead>
            <tr>
              <th style="width:60px">#</th>
              <th>Workout</th>
              <th style="width:240px">Rings</th>
              <th style="width:280px">Notes</th>
            </tr>
          </thead>
          <tbody>
            {% for i in range(1,18) %}
              {% set idx = (i - 1) + offset %}
              {% set row = (wdata[idx] if wdata|length > idx else {}) %}
              <tr>
                <td class="text-center font-semibold">{{ i }}</td>
                <td><input class="w-full field workout-workout" type="text" value="{{ row.get('Workout','') }}"/></td>
                <td><input class="w-full field workout-rings" type="text" value="{{ row.get('Rings','') }}"/></td>
                <td><input class="w-full field workout-notes" type="text" value="{{ row.get('Notes', row.get('Comment','')) }}"/></td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>

    <div class="card card-pad">
      <h3 class="text-md font-semibold mb-2">Goldorack</h3>
      <div class="overflow-x-auto">
        <table id="goldorack-table" class="clean zebra-pink sticky-header">
          <thead>
            <tr>
              <th style="width:120px">GK</th>
              <th>Value</th>
            </tr>
          </thead>
          <tbody>
            {% set gold_rows = (wdata | selectattr('Goldorack') | list) if wdata else [] %}
            {% for j in range(0,4) %}
              {% set grow = gold_rows[j] if gold_rows|length > j else {} %}
              <tr>
                <td class="whitespace-nowrap">{{ grow.get('Goldorack','GK') }}</td>
                <td><input class="w-full field workout-gk" name="workout_gk[]" type="text" value="{{ grow.get('Value','') }}"/></td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

      <div class="flex items-center gap-2 mt-4">
        <label for="stretching" class="font-medium">Stretching :</label>
        <input id="stretching" name="stretching" type="text" value="{{ wrec.get('Stretching','') }}" class="field w-80"/>
      </div>
    </div>
  </div>

  {# ===== Workout Rev1 (upgraded UI; Workout narrower, Notes wider) ===== #}
  <div id="workout-rev1" class="tab-content hidden space-y-4 p-0">

    {% set wrdata     = (sheets['workout_rev1'].data if sheets and sheets.get('workout_rev1') and sheets['workout_rev1'].data else []) %}
    {% set wr_hasmeta = wrdata and ('KG' in wrdata[0] or 'Tools' in wrdata[0]) %}
    {% set wr_offset  = 1 if wr_hasmeta else 0 %}
    {% set wr_rec     = (wrdata[0] if wr_hasmeta else {}) %}

    <!-- Sticky Rev1 toolbar -->
    <div class="rev1-toolbar">
      <div class="toolbar-row">
        <span class="text-sm font-semibold">Program (Rev1)</span>

        <label for="workout-rev1-type" class="ml-4 text-sm font-medium">Type:</label>
        <select id="workout-rev1-type" class="select">
          {% for opt in ['C1','C2','C3','C4','C5','V1','V2','V3','V4','V5','TO1','TO2','TO3','TO4','TO5'] %}
            <option value="{{ opt }}">{{ opt }}</option>
          {% endfor %}
        </select>

        <button type="button" id="workout-rev1-apply" class="btn btn-primary">Apply</button>
        <button type="button" id="workout-rev1-clear" class="btn">Clear</button>

        <div class="toolbar-sp">
          <label class="text-sm">KG :</label>
          <input id="workout-rev1-kg" type="text" value="{{ wr_rec.get('KG','') }}" class="field w-24">
          <label class="text-sm">Tools :</label>
          <input id="workout-rev1-tools" type="text" value="{{ wr_rec.get('Tools','') }}" class="field w-64">
          <label class="flex items-center gap-2 text-sm text-gray-600 ml-2">
            <input id="rev1-compact" type="checkbox" class="toggle">
            <span>Compact</span>
          </label>
        </div>
      </div>
    </div>

    <!-- Program table -->
    <div class="p-4">
      <div class="card">
        <div class="card-pad overflow-x-auto">
          <table class="clean zebra-pink sticky-header" id="rev1-table">
            <colgroup>
              <col class="num">
              <col class="workout">
              <col class="rings">
              <col class="notes">
            </colgroup>
            <thead>
              <tr>
                <th>#</th>
                <th>Workout</th>
                <th>Rings</th>
                <th>Notes</th>
              </tr>
            </thead>
            <tbody>
            {% for i in range(1,17) %}
              {% set idx = (i - 1) + wr_offset %}
              {% set row = (wrdata[idx] if wrdata|length > idx else {}) %}
              <tr>
                <td class="text-center font-semibold">{{ i }}</td>
                <td><input class="rev1-workout w-full field" type="text" value="{{ row.get('Workout','') }}"></td>
                <td><input class="rev1-rings   w-full field" type="text" value="{{ row.get('Rings','') }}"></td>
                <td><input class="rev1-notes   w-full field" type="text" value="{{ row.get('Notes','') }}"></td>
              </tr>
            {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- GK (visible only for TO* codes) -->
    <div class="px-4">
      <div class="card">
        <div class="card-pad">
          <h3 class="text-md font-semibold mb-2">Goldorack (TO plans only)</h3>
          <div id="gk-rev1-section" class="overflow-x-auto hidden">
            <table class="clean zebra-pink sticky-header">
              <thead>
                <tr>
                  <th>Workout</th>
                  <th style="width:180px">Rings</th>
                  <th>Notes</th>
                </tr>
              </thead>
              <tbody>
                {% set wr_gold = (wrdata | selectattr('Goldorack') | list) if wrdata else [] %}
                {% for j in range(0,4) %}
                  {% set grow = wr_gold[j] if wr_gold|length > j else {} %}
                  <tr>
                    <td><input class="rev1-gk-workout w-full field" type="text" value="{{ grow.get('Workout', grow.get('Value','')) }}"></td>
                    <td><input class="rev1-gk-rings w-full field"   type="text" value="{{ grow.get('Rings','') }}"></td>
                    <td><input class="rev1-gk-notes w-full field"   type="text" value="{{ grow.get('Notes','') }}"></td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

  </div> <!-- /workout-rev1 -->

  {# ===== Nutrition ===== #}
  <div id="nutrition" class="tab-content hidden space-y-6 p-4">
    <h2 class="text-xl font-bold">Nutrition</h2>

    <template id="nutrition-row-template">
      <div class="flex space-x-4 form-row mt-4 nutrition-row">
        <div class="flex flex-col w-32">
          <label class="text-sm font-medium mb-1">Date</label>
          <input name="nutrition_date[]" type="date" class="field w-full nutrition-date"/>
        </div>
        <div class="flex flex-col w-32">
          <label class="text-sm font-medium mb-1">Type</label>
          <input name="nutrition_type[]" type="text" placeholder="Type" class="field w-full nutrition-type"/>
        </div>
        <div class="flex flex-col flex-1">
          <label class="text-sm font-medium mb-1">Notes</label>
          <textarea name="nutrition_notes[]" rows="3" placeholder="Notes" class="field w-full nutrition-notes"></textarea>
        </div>
      </div>
    </template>

    {% set nut_rows = (sheets['nutrition'].data if sheets and sheets.get('nutrition') and sheets['nutrition'].data else []) %}
    <div id="nutrition-rows" class="card card-pad">
      {% for row in nut_rows %}
        <div class="flex space-x-4 form-row mt-4 nutrition-row">
          <div class="flex flex-col w-32">
            <label class="text-sm font-medium mb-1">Date</label>
            <input name="nutrition_date[]" type="date" value="{{ row.get('Date','') }}" class="field w-full nutrition-date"/>
          </div>
          <div class="flex flex-col w-32">
            <label class="text-sm font-medium mb-1">Type</label>
            <input name="nutrition_type[]" type="text" value="{{ row.get('Type','') }}" class="field w-full nutrition-type"/>
          </div>
          <div class="flex flex-col flex-1">
            <label class="text-sm font-medium mb-1">Notes</label>
            <textarea name="nutrition_notes[]" rows="3" class="field w-full nutrition-notes">{{ row.get('Notes','') }}</textarea>
          </div>
        </div>
      {% endfor %}

      {% if not nut_rows %}
        <div class="flex space-x-4 form-row mt-4 nutrition-row">
          <div class="flex flex-col w-32">
            <label class="text-sm font-medium mb-1">Date</label>
            <input name="nutrition_date[]" type="date" class="field w-full nutrition-date"/>
          </div>
          <div class="flex flex-col w-32">
            <label class="text-sm font-medium mb-1">Type</label>
            <input name="nutrition_type[]" type="text" placeholder="Type" class="field w-full nutrition-type"/>
          </div>
          <div class="flex flex-col flex-1">
            <label class="text-sm font-medium mb-1">Notes</label>
            <textarea name="nutrition_notes[]" rows="3" placeholder="Notes" class="field w-full nutrition-notes"></textarea>
          </div>
        </div>
      {% endif %}
    </div>

    <button id="add-nutrition" type="button" class="mt-2 btn btn-primary">+ Add Row</button>
  </div>

  {# ===== Communication ===== #}
  <div id="communication" class="tab-content hidden space-y-6 p-4">
    <h2 class="text-xl font-bold">Communication Log</h2>

    <template id="comm-row-template">
      <div class="flex space-x-4 form-row mt-4 comm-row">
        <div class="flex flex-col w-32">
          <label class="text-sm font-medium mb-1">Date</label>
          <input name="comm_date[]" type="date" class="field w-full comm-date"/>
        </div>
        <div class="flex flex-col w-32">
          <label class="text-sm font-medium mb-1">Type</label>
          <input name="comm_type[]" type="text" placeholder="Type" class="field w-full comm-type"/>
        </div>
        <div class="flex flex-col flex-1">
          <label class="text-sm font-medium mb-1">Notes</label>
          <textarea name="comm_notes[]" rows="3" placeholder="Notes" class="field w-full comm-notes"></textarea>
        </div>
      </div>
    </template>

    {% set comm_rows = (sheets['communication'].data if sheets and sheets.get('communication') and sheets['communication'].data else []) %}
    <div id="comm-rows" class="card card-pad">
      {% for row in comm_rows %}
        <div class="flex space-x-4 form-row mt-4 comm-row">
          <div class="flex flex-col w-32">
            <label class="text-sm font-medium mb-1">Date</label>
            <input name="comm_date[]" type="date" value="{{ row.get('Date','') }}" class="field w-full comm-date"/>
          </div>
          <div class="flex flex-col w-32">
            <label class="text-sm font-medium mb-1">Type</label>
            <input name="comm_type[]" type="text" value="{{ row.get('Type','') }}" class="field w-full comm-type"/>
          </div>
          <div class="flex flex-col flex-1">
            <label class="text-sm font-medium mb-1">Notes</label>
            <textarea name="comm_notes[]" rows="3" class="field w-full comm-notes">{{ row.get('Notes','') }}</textarea>
          </div>
        </div>
      {% endfor %}

      {% if not comm_rows %}
        <div class="flex space-x-4 form-row mt-4 comm-row">
          <div class="flex flex-col w-32">
            <label class="text-sm font-medium mb-1">Date</label>
            <input name="comm_date[]" type="date" class="field w-full comm-date"/>
          </div>
          <div class="flex flex-col w-32">
            <label class="text-sm font-medium mb-1">Type</label>
            <input name="comm_type[]" type="text" placeholder="Type" class="field w-full comm-type"/>
          </div>
          <div class="flex flex-col flex-1">
            <label class="text-sm font-medium mb-1">Notes</label>
            <textarea name="comm_notes[]" rows="3" placeholder="Notes" class="field w-full comm-notes"></textarea>
          </div>
        </div>
      {% endif %}
    </div>

    <button id="add-comm" type="button" class="mt-2 btn btn-primary">+ Add Row</button>
  </div>
</div>

{# ---- JSON that survives script stripping ---- #}
<template id="workout-blocks-json">
  {{ workout_blocks_json | tojson | safe }}
</template>

<!-- ===== Small helpers (Type stays a dropdown) ===== -->
<script>
(function(){
  if (window.__rev1SelectInit) return; window.__rev1SelectInit = true;

  const typeSelect = document.getElementById('workout-rev1-type');
  const gk = document.getElementById('gk-rev1-section');
  const table = document.getElementById('rev1-table');
  const compactToggle = document.getElementById('rev1-compact');

  function isTO(val){ return /^TO\\d$/i.test(val||''); }
  function updateGK(){ if (!gk || !typeSelect) return; gk.classList.toggle('hidden', !isTO(typeSelect.value)); }

  // Init & bind
  updateGK();
  typeSelect?.addEventListener('change', updateGK);

  // Compact density toggle
  compactToggle?.addEventListener('change', e=>{
    table?.classList.toggle('compact', e.target.checked);
  });

  // Hooks for Apply / Clear if you expose them globally
  document.getElementById('workout-rev1-apply')?.addEventListener('click', ()=>{
    if (window.applyWorkoutBlock) window.applyWorkoutBlock(typeSelect.value);
  });
  document.getElementById('workout-rev1-clear')?.addEventListener('click', ()=>{
    if (window.clearWorkoutBlock) window.clearWorkoutBlock();
  });
})();
</script>
