{# templates/charts/_measures_table.html #}
{% set m_sheet = sheets['measures'] if sheets and sheets.get('measures') else None %}
{% set m_data  = m_sheet.data if m_sheet and m_sheet.data else [] %}

{% macro v(d, k, default='') -%}
  {%- if d is mapping and (k in d) -%}{{ d[k] }}{%- else -%}{{ default }}{%- endif -%}
{%- endmacro %}

{# prefetch grid rows from measures #}
{% set r_DATE   = (m_data | selectattr('Field','equalto','DATE')   | list | first) or {} %}
{% set r_FA     = (m_data | selectattr('Field','equalto','FA')     | list | first) or {} %}
{% set r_Freq   = (m_data | selectattr('Field','equalto','Freq.')  | list | first) or {} %}
{% set r_Reps   = (m_data | selectattr('Field','equalto','Reps')   | list | first) or {} %}
{% set r_STEP   = (m_data | selectattr('Field','equalto','STEP')   | list | first) or {} %}
{% set r_NC     = (m_data | selectattr('Field','equalto','NC')     | list | first) or {} %}
{% set r_Weight = (m_data | selectattr('Field','equalto','Weight') | list | first) or {} %}

<style>
  .zebra-pink tbody tr:nth-child(even){ background-color: rgba(204,0,102,.1); }
  .sticky-header th{ position: sticky; top: 0; background: #f9fafb; z-index: 10; }
</style>

<div id="measures" class="flex flex-col gap-8">
  <!-- ====== Workout Session Grid (1–20) ====== -->
  <table data-grid="1" class="min-w-full border-collapse border text-sm zebra-pink mb-6">
    <thead class="bg-gray-100 text-center text-xs font-semibold uppercase sticky-header">
      <tr>
        <th class="border px-2 py-1">#</th>
        {% for i in range(1,21) %}
          <th class="border px-2 py-1{% if i in [10,20] %} border-l-2 border-gray-300{% endif %}">{{ i }}</th>
        {% endfor %}
      </tr>
    </thead>
    <tbody>
      {% macro grid_row(label, row) -%}
        <tr class="text-left">
          <th class="border px-2 py-1 text-xs font-medium">{{ label }}</th>
          {% for i in range(1,21) %}
            {% set key = i|string %}
            <td class="border px-2 py-1" contenteditable="true">{{ v(row, key) }}</td>
          {% endfor %}
        </tr>
      {%- endmacro %}

      {{ grid_row('DATE',   r_DATE)  }}
      {{ grid_row('FA',     r_FA)    }}
      {{ grid_row('Freq.',  r_Freq)  }}
      {{ grid_row('Reps',   r_Reps)  }}
      {{ grid_row('STEP',   r_STEP)  }}
      {{ grid_row('NC',     r_NC)    }}
      {{ grid_row('Weight', r_Weight)}}
    </tbody>
  </table>

  <!-- ====== Notes (stored inside the *measures* sheet) ====== -->
  <section id="measures-notes" class="space-y-6 p-4">
    <h2 class="text-xl font-bold">Notes</h2>

    <template id="meas-notes-row-template">
      <div class="flex space-x-4 form-row mt-4 meas-notes-row">
        <div class="flex flex-col w-32">
          <label class="text-sm font-medium mb-1">Date</label>
          <input name="meas_notes_date[]" type="date" class="field w-full meas-notes-date"/>
        </div>
        <div class="flex flex-col w-32">
          <label class="text-sm font-medium mb-1">Type</label>
          <input name="meas_notes_type[]" type="text" placeholder="Type" class="field w-full meas-notes-type"/>
        </div>
        <div class="flex flex-col flex-1">
          <label class="text-sm font-medium mb-1">Notes</label>
          <textarea name="meas_notes_text[]" rows="3" placeholder="Notes" class="field w-full meas-notes-text"></textarea>
        </div>
      </div>
    </template>

    <div id="meas-notes-rows" class="card card-pad">
      {% set _notes = namespace(count=0) %}
      {% for row in m_data %}
        {% set field = (row.get('Field','') | string) %}
        {% if field[:6] == 'NOTES:' %}
          {% set _notes.count = _notes.count + 1 %}
          <div class="flex space-x-4 form-row mt-4 meas-notes-row">
            <div class="flex flex-col w-32">
              <label class="text-sm font-medium mb-1">Date</label>
              <input name="meas_notes_date[]" type="date" value="{{ row.get('Date','') }}" class="field w-full meas-notes-date"/>
            </div>
            <div class="flex flex-col w-32">
              <label class="text-sm font-medium mb-1">Type</label>
              <input name="meas_notes_type[]" type="text" value="{{ row.get('Type','') }}" class="field w-full meas-notes-type"/>
            </div>
            <div class="flex flex-col flex-1">
              <label class="text-sm font-medium mb-1">Notes</label>
              <textarea name="meas_notes_text[]" rows="3" class="field w-full meas-notes-text">{{ row.get('Notes','') }}</textarea>
            </div>
          </div>
        {% endif %}
      {% endfor %}

      {% if _notes.count == 0 %}
        <div class="flex space-x-4 form-row mt-4 meas-notes-row">
          <div class="flex flex-col w-32">
            <label class="text-sm font-medium mb-1">Date</label>
            <input name="meas_notes_date[]" type="date" class="field w-full meas-notes-date"/>
          </div>
          <div class="flex flex-col w-32">
            <label class="text-sm font-medium mb-1">Type</label>
            <input name="meas_notes_type[]" type="text" placeholder="Type" class="field w-full meas-notes-type"/>
          </div>
          <div class="flex flex-col flex-1">
            <label class="text-sm font-medium mb-1">Notes</label>
            <textarea name="meas_notes_text[]" rows="3" placeholder="Notes" class="field w-full meas-notes-text"></textarea>
          </div>
        </div>
      {% endif %}
    </div>

    <button type="button" class="mt-2 btn btn-primary"
      onclick="(function(){
        var host=document.getElementById('meas-notes-rows');
        if(!host) return;
        var tpl=document.getElementById('meas-notes-row-template');
        var node = tpl && tpl.content && tpl.content.firstElementChild
          ? tpl.content.firstElementChild.cloneNode(true)
          : (function(){var d=document.createElement('div'); d.className='flex space-x-4 form-row mt-4 meas-notes-row'; d.innerHTML='<div class=&quot;flex flex-col w-32&quot;><label class=&quot;text-sm font-medium mb-1&quot;>Date</label><input name=&quot;meas_notes_date[]&quot; type=&quot;date&quot; class=&quot;field w-full meas-notes-date&quot;/></div><div class=&quot;flex flex-col w-32&quot;><label class=&quot;text-sm font-medium mb-1&quot;>Type</label><input name=&quot;meas_notes_type[]&quot; type=&quot;text&quot; placeholder=&quot;Type&quot; class=&quot;field w-full meas-notes-type&quot;/></div><div class=&quot;flex flex-col flex-1&quot;><label class=&quot;text-sm font-medium mb-1&quot;>Notes</label><textarea name=&quot;meas_notes_text[]&quot; rows=&quot;3&quot; placeholder=&quot;Notes&quot; class=&quot;field w-full meas-notes-text&quot;></textarea></div>'; return d; })();
        host.appendChild(node);
        window.__saveMeasuresNotes && window.__saveMeasuresNotes();
      })()">+ Add Row</button>
  </section>
</div>

<script>
/* Autosave Notes into the existing 'measures' sheet using Field='NOTES:<idx>' */
(function(){
  const onReady = (fn)=>{ document.readyState==='loading' ? document.addEventListener('DOMContentLoaded', fn) : fn(); };

  onReady(function(){
    const host  = document.getElementById('meas-notes-rows');
    if (!host) return;

    function serializeNotes(){
      const rows = [];
      host.querySelectorAll('.meas-notes-row').forEach((row,i)=>{
        const date = row.querySelector('.meas-notes-date')?.value?.trim() || '';
        const type = row.querySelector('.meas-notes-type')?.value?.trim() || '';
        const text = row.querySelector('.meas-notes-text')?.value?.trim() || '';
        if (date || type || text){
          rows.push({ Field: 'NOTES:' + i, Date: date, Type: type, Notes: text });
        }
      });
      return rows;
    }

    function debounce(fn, t){ let h; return (...a)=>{ clearTimeout(h); h=setTimeout(()=>fn(...a), t); }; }

    function showSaving(isSaving, msg='Saving…'){
      let el = document.getElementById('meas-notes-saving');
      if (!el){
        el = document.createElement('div');
        el.id='meas-notes-saving';
        el.style.cssText='position:fixed;bottom:14px;right:14px;padding:6px 10px;border:1px solid #ddd;border-radius:8px;background:#fff;box-shadow:0 2px 8px rgba(0,0,0,.08);font-size:12px;opacity:0;transition:opacity .15s;z-index:9999';
        document.body.appendChild(el);
      }
      el.textContent = msg;
      el.style.opacity = isSaving ? '1' : '0';
    }

    async function saveNow(){
      const data = serializeNotes();
      const payload = { section: 'measures', data: data };  // save INSIDE measures
      const headers = { 'Content-Type': 'application/json' };
      const csrf = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content');
      if (csrf) headers['X-CSRFToken'] = csrf;

      const url = "{{ url_for('charts.save_client_chart', client=client) }}";
      console.log('[MEASURES:NOTES] POST', url, payload);
      showSaving(true, 'Saving…');
      try{
        const resp = await fetch(url, { method: 'POST', headers, credentials: 'same-origin', body: JSON.stringify(payload) });
        const txt  = await resp.text();
        console.log('[MEASURES:NOTES] status', resp.status, 'body:', txt);
        if (!resp.ok){ showSaving(true, 'Save failed'); setTimeout(()=>showSaving(false), 1200); return; }
        showSaving(true, 'Saved ✓'); setTimeout(()=>showSaving(false), 700);
      }catch(e){
        console.error('[MEASURES:NOTES] network error', e);
        showSaving(true, 'Save error'); setTimeout(()=>showSaving(false), 1600);
      }
    }

    const saveDebounced = debounce(saveNow, 600);
    window.__saveMeasuresNotes = saveDebounced;

    host.addEventListener('input', saveDebounced);
    host.addEventListener('paste', ()=>setTimeout(saveDebounced,0), true);
    host.addEventListener('change', saveDebounced);
    host.addEventListener('blur', saveDebounced, true);
  });
})();
</script>
