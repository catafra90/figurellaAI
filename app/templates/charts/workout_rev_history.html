{# app/templates/charts/workout_rev_history.html #}
{% extends "base.html" %}

{% block content %}
<div class="p-6 h-[85vh] flex flex-col">
  <h2 class="text-2xl font-bold mb-4 flex-shrink-0">
    Workout — {{ client_name }}
  </h2>

  <style>
    /* Compact, centered KG & Tools */
    .col-kg   { width:72px;  text-align:center; }
    .col-tools{ width:160px; text-align:center; }
    .kg-badge{
      display:inline-block; min-width:40px; padding:2px 8px;
      border-radius:9999px; background:#f3f4f6; font-weight:600;
      line-height:1.2; font-size:.85rem;
    }
    .tool-chip{
      display:inline-block; margin:0 4px 4px 0; padding:2px 8px;
      border-radius:10px; background:#eef2f7; font-size:.8rem; white-space:nowrap;
    }
    .rings-badge{
      display:inline-block; padding:2px 8px; border-radius:9999px;
      background:#fafafa; border:1px solid #e5e7eb; font-size:.8rem;
    }
    .notes-cell{ max-width:220px; }
    .th-center{ text-align:center; }
    .th-left{ text-align:left; }
    .subhead{ font-weight:600; color:#374151; margin:.5rem 0 .25rem; }
  </style>

  {% if history_entries and history_entries|length %}
    <div class="flex-1 overflow-y-auto bg-white rounded-xl border border-gray-200">
      <table class="min-w-full text-sm">
        <thead class="bg-gray-50 text-gray-700 sticky top-0">
          <tr>
            <th class="px-4 py-2 th-left">Date</th>
            <th class="px-4 py-2 th-left">Details</th>
            <th class="px-4 py-2 th-left">Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for entry in history_entries %}
            <tr class="border-t align-top" id="history-row-{{ entry.meta.snapshot_id }}">
              <td class="px-4 py-3 whitespace-nowrap align-top">
                {{ entry.label | format_est }}
              </td>

              <td class="px-4 py-3 align-top">
                {# ---------- Main Program (Rev1) ---------- #}
                {% if entry.rows and entry.rows|length %}
                  <div class="overflow-x-auto">
                    <table class="clean zebra-pink compact" style="min-width: 900px;">
                      <thead class="sticky top-0 bg-gray-50">
                        <tr>
                          <th style="width:56px">#</th>
                          <th class="th-left">Workout</th>
                          <th class="col-kg th-center">KG</th>
                          <th class="col-tools th-center">Tools</th>
                          <th style="width:120px" class="th-center">Rings</th>
                          <th class="th-left">Notes</th>
                        </tr>
                      </thead>
                      <tbody>
                        {% for row in entry.rows %}
                          {% set kg = (row.get('KG','') | string).strip() %}
                          {% set tools_raw = (row.get('Tools','') | string).strip() %}
                          {% set tools = tools_raw.replace('+', ',').replace('  ',' ').split(',') if ',' in tools_raw or '+' in tools_raw else tools_raw.split() %}
                          <tr>
                            <td class="text-center font-semibold">{{ loop.index }}</td>
                            <td>{{ row.get('Workout','') }}</td>

                            <td class="col-kg">
                              {% if kg %}
                                <span class="kg-badge">{{ kg }}</span>
                              {% endif %}
                            </td>

                            <td class="col-tools">
                              {% if tools_raw %}
                                {% for t in tools if t %}
                                  <span class="tool-chip">{{ t }}</span>
                                {% endfor %}
                              {% endif %}
                            </td>

                            <td class="th-center">
                              {% set rings = (row.get('Rings','') | string).strip() %}
                              {% if rings %}
                                <span class="rings-badge">{{ rings }}</span>
                              {% endif %}
                            </td>

                            <td class="notes-cell">{{ row.get('Notes','') }}</td>
                          </tr>
                        {% endfor %}
                      </tbody>
                    </table>
                  </div>
                {% else %}
                  <span class="text-gray-600">No details</span>
                {% endif %}

                {# ---------- Goldorack (GK) — show ALL rows ---------- #}
                {% set gk_source =
                     (entry.gk_rows if entry.gk_rows is defined else []) %}
                {% if (not gk_source or not gk_source|length) and entry.rows %}
                  {# fallback: any rows that were tagged as Goldorack in payload #}
                  {% set gk_source = entry.rows | selectattr('Goldorack') | list %}
                {% endif %}

                {% if gk_source and gk_source|length %}
                  <div class="subhead">Goldorack</div>
                  <div class="overflow-x-auto">
                    <table class="clean zebra-pink compact" style="min-width: 720px;">
                      <thead class="sticky top-0 bg-gray-50">
                        <tr>
                          <th style="width:56px">#</th>
                          <th class="th-left">Workout</th>
                          <th style="width:120px" class="th-center">Rings</th>
                          <th class="th-left">Notes</th>
                        </tr>
                      </thead>
                      <tbody>
                        {# render every non-empty GK row #}
                        {% for r in gk_source %}
                          {% set w = (r.get('Workout','') | string).strip() %}
                          {% set rr = (r.get('Rings','')   | string).strip() %}
                          {% set n = (r.get('Notes','')   | string).strip() %}
                          {% if w or rr or n %}
                            <tr>
                              <td class="text-center font-semibold">{{ loop.index }}</td>
                              <td>{{ w }}</td>
                              <td class="th-center">
                                {% if rr %}<span class="rings-badge">{{ rr }}</span>{% endif %}
                              </td>
                              <td class="notes-cell">{{ n }}</td>
                            </tr>
                          {% endif %}
                        {% endfor %}
                      </tbody>
                    </table>
                  </div>
                {% endif %}
              </td>

              <td class="px-4 py-3 align-top">
                <button class="text-red-600 hover:underline"
                        onclick="deleteSnapshot('{{ entry.meta.snapshot_id }}')">
                  Delete
                </button>
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  {% else %}
    <p class="text-gray-600">No archived Workout Rev entries yet.</p>
  {% endif %}



<!-- Back button directly below -->
<div class="mt-4">
  <a href="{{ url_for('charts.view_charts', client=client_name) }}"
     class="inline-flex items-center px-3 py-1.5 text-sm font-medium text-white bg-pink-600 rounded-md shadow hover:bg-pink-700 transition">
    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
    </svg>
    Back
  </a>
</div>


<script>
function deleteSnapshot(snapshotId) {
  if (!confirm("Are you sure you want to delete this history entry?")) return;
  fetch(`/charts/client/{{ client_name }}/workout-rev-history/${snapshotId}/delete`, {
    method: "POST",
    headers: { "Content-Type": "application/json" }
  })
  .then(res => res.json())
  .then(data => {
    if (data.status === "success") {
      document.getElementById(`history-row-${snapshotId}`)?.remove();
    } else {
      alert("Failed to delete entry");
    }
  })
  .catch(err => {
    console.error(err);
    alert("Error deleting entry");
  });
}
</script>
{% endblock %}
