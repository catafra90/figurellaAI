<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Figurella Platform</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5, user-scalable=no">

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: { figurella: '#CC0066' },
          fontFamily: { sans: ['ui-sans-serif', 'system-ui', 'sans-serif'] }
        }
      }
    }
  </script>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/interactjs/dist/interact.min.js"></script>

  {% block extra_head %}{% endblock %}

  <style>
    html, body { height: 100%; overflow: hidden; overflow-y: auto; }

    /* ---- Command Palette must be above EVERYTHING ---- */
    #cmdk { z-index: 2147483647 !important; }           /* max-ish z-index */
    #cmdk .cmdk-panel { position: relative; z-index: 1; }
    body.cmdk-open { overflow: hidden; touch-action: none; }

    .modal-window {
      position: absolute; background: white; border: 1px solid #ddd; border-radius: .5rem;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15); overflow: hidden; display: flex; flex-direction: column;
      width: 600px; height: 500px; top: 100px; left: 100px; z-index: 1000; touch-action: none; user-select: none;
    }
    .modal-header {
      background: #f3f4f6; padding: 1rem; display: flex; justify-content: space-between;
      align-items: flex-start; flex-direction: column; gap: .5rem; position: relative;
    }
    .modal-header h2 { font-weight: 600; }
    .modal-controls { position: absolute; top: .5rem; right: .5rem; display: flex; gap: .25rem; }
    .modal-controls button {
      background: #e5e7eb; border-radius: .375rem; padding: .25rem .5rem; font-weight: bold;
      font-size: 1rem; color: #1f2937; transition: background .2s;
    }
    .modal-controls button:hover { background: #d1d5db; }
    .modal-body { flex: 1; overflow-y: auto; overflow-x: hidden; padding: 1rem; overscroll-behavior: contain; -webkit-overflow-scrolling: touch; user-select: text; }
    .modal-resizer { position: absolute; right: 0; bottom: 0; width: 28px; height: 28px; cursor: se-resize; z-index: 20; background: white; }
    .modal-resizer::after {
      content: ''; display: block; width: 16px; height: 16px;
      background-image: url('data:image/svg+xml,%3Csvg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg"%3E%3Cpath d="M1 15L15 1M5 15L15 5M9 15L15 9" stroke="%23999" stroke-width="1.5"/%3E%3C/svg%3E');
      background-repeat: no-repeat; background-position: center; opacity: .5;
    }
  </style>
</head>

<body class="font-sans text-gray-900 h-full flex flex-col overflow-hidden">

  <!-- Header (click/tap logo opens Command Palette immediately) -->
  <header class="bg-gray-800 fixed top-0 left-0 w-full z-40 h-16 flex items-center justify-center shadow">
    <img id="figurella-logo"
         src="{{ url_for('static', filename='images/figurella-logo.png') }}"
         alt="Figurella Logo"
         class="h-10 select-none"
         draggable="false">
  </header>

  <!-- Main -->
  <main class="flex-1 pt-20 pb-14 overflow-hidden bg-gray-200">
    {% block content %}{% endblock %}
  </main>

  <!-- Bottom nav (Home only) -->
  <nav class="fixed bottom-0 w-full h-11 bg-gray-800 text-white shadow flex justify-around text-xs z-40">
    <a href="{{ url_for('home.index') }}" class="flex-1 flex items-center justify-center border-t-4 border-transparent hover:border-figurella {% if active_page=='home' %}border-figurella{% endif %}">
      <i class="bi bi-house-door text-lg"></i>
    </a>
  </nav>

  {% block scripts %}
  <script>
    // Helper for draggable/resizable modals (if you use them elsewhere).
    function makeInteractive(modal) {
      let offsetX = 0, offsetY = 0;
      interact(modal)
        .draggable({
          allowFrom: '.modal-header',
          listeners: {
            start(event) {
              const rect = modal.getBoundingClientRect();
              offsetX = event.client.x - rect.left;
              offsetY = event.client.y - rect.top;
            },
            move(event) {
              const x = event.client.x - offsetX;
              const y = event.client.y - offsetY;
              modal.style.left = `${x}px`;
              modal.style.top = `${y}px`;
              modal.style.transform = 'none';
            }
          }
        })
        .resizable({
          edges: { bottom: true, right: true },
          modifiers: [interact.modifiers.restrictSize({ min: { width: 300, height: 200 } })],
          listeners: {
            move(event) {
              modal.style.width = `${event.rect.width}px`;
              modal.style.height = `${event.rect.height}px`;
            }
          }
        });
    }
  </script>
  {% endblock %}

  <!-- Editable table popup modal -->
  <div id="table-modal" class="fixed inset-0 hidden items-center justify-center bg-black bg-opacity-50 z-50">
    <div class="relative bg-white rounded-lg p-6 max-w-4xl max-h-[80vh] overflow-auto">
      <button id="table-modal-close" class="absolute top-2 right-2 text-gray-600 hover:text-gray-800 text-2xl leading-none">&times;</button>
      <div id="table-modal-content"></div>
    </div>
  </div>

  <!-- Command Palette (always-on-top overlay) -->
  <div id="cmdk"
       class="fixed inset-0 hidden items-start justify-center pt-24 bg-black/40"
       role="dialog" aria-modal="true">
    <div class="cmdk-panel w-full max-w-xl mx-4 bg-white rounded-xl shadow-xl overflow-hidden">
      <input id="cmdk-input" placeholder="Type to jump… (↑/↓ to navigate, Enter to open)"
             class="w-full px-4 py-3 text-lg outline-none border-b"
             autocomplete="off" />
      <ul id="cmdk-list" class="max-h-80 overflow-auto divide-y"></ul>
      <div id="cmdk-empty" class="hidden px-4 py-3 text-gray-500">No matches</div>
    </div>
  </div>

  <script>
  (function(){
    // ---- Items (labels + routes) ----
    const CMDK_ITEMS = [
      { label: 'Home',               href: "{{ url_for('home.index') }}" },
      { label: 'Daily Check-in',     href: "{{ url_for('daily_checkin.report_home') }}" },
      { label: 'Clients',            href: "{{ url_for('clients.clients') }}" },
      { label: 'Figurella Reports',  href: "{{ url_for('reports_bp.reports_home') }}" },
      { label: 'Charts',             href: "{{ url_for('charts.view_charts') }}" }
    ];

    const modal = document.getElementById('cmdk');
    const input = document.getElementById('cmdk-input');
    const list  = document.getElementById('cmdk-list');
    const empty = document.getElementById('cmdk-empty');
    const logo  = document.getElementById('figurella-logo');

    let results = [];
    let activeIndex = 0;

    function openPalette() {
      modal.classList.remove('hidden'); modal.classList.add('flex');
      document.body.classList.add('cmdk-open');
      input.value = ''; render('');
      input.focus();
    }
    function closePalette() {
      modal.classList.remove('flex'); modal.classList.add('hidden');
      document.body.classList.remove('cmdk-open');
    }

    // ---- Fuzzy matching (lightweight) ----
    function fuzzyMatch(str, query) {
      const s = str.toLowerCase();
      const q = query.toLowerCase().trim();
      if (q.length === 0) return { score: 0, indices: [] };
      let score = 0, last = -1, streak = 0;
      const idxs = [];
      for (let qi = 0; qi < q.length; qi++) {
        const ch = q[qi];
        const pos = s.indexOf(ch, last + 1);
        if (pos === -1) return null;
        idxs.push(pos);

        score += 1;
        if (pos === last + 1) { streak += 1; score += 1 + streak * 0.5; }
        else { streak = 0; }
        if (pos === 0 || /\s|[_-]/.test(s[pos - 1])) score += 1.25;

        last = pos;
      }
      score -= Math.max(0, s.length - q.length) * 0.02;
      return { score, indices: idxs };
    }

    function highlightLabel(label, indices) {
      if (!indices || !indices.length) return escapeHtml(label);
      let out = '', last = 0;
      for (let i = 0; i < indices.length; i++) {
        const idx = indices[i];
        if (idx > last) out += escapeHtml(label.slice(last, idx));
        out += '<span class="text-figurella font-semibold">' + escapeHtml(label[idx]) + '</span>';
        last = idx + 1;
      }
      out += escapeHtml(label.slice(last));
      return out;
    }

    function escapeHtml(s) {
      return s.replace(/[&<>"']/g, (c) => ({
        '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;'
      }[c]));
    }

    function render(query) {
      const scored = [];
      for (const item of CMDK_ITEMS) {
        const m = fuzzyMatch(item.label, query);
        if (m) scored.push({ ...item, score: m.score, indices: m.indices });
      }
      scored.sort((a,b) => b.score - a.score || a.label.localeCompare(b.label));
      results = scored;

      list.innerHTML = '';
      if (results.length === 0) {
        empty.classList.remove('hidden');
        activeIndex = -1;
      } else {
        empty.classList.add('hidden');
        results.forEach((r, i) => {
          const li = document.createElement('li');
          li.className = 'px-4 py-3 hover:bg-gray-50 cursor-pointer';
          li.dataset.href = r.href;
          li.dataset.index = i;
          li.innerHTML = highlightLabel(r.label, r.indices);
          li.addEventListener('click', () => { window.location = r.href; });
          li.addEventListener('mousemove', () => setActive(i));
          list.appendChild(li);
        });
        activeIndex = 0;
        updateActive();
      }
    }

    function updateActive() {
      [...list.children].forEach((li, i) => {
        li.classList.toggle('bg-gray-100', i === activeIndex);
      });
    }

    function setActive(i) {
      if (i < 0 || i >= results.length) return;
      activeIndex = i;
      updateActive();
    }

    // ---- Keyboard handling (open/close + navigate) ----
    window.addEventListener('keydown', (e) => {
      const k = e.key.toLowerCase();
      if ((e.ctrlKey || e.metaKey) && k === 'k') { e.preventDefault(); openPalette(); }
      if (!modal.classList.contains('hidden') && e.key === 'Escape') closePalette();
    });

    input.addEventListener('keydown', (e) => {
      if (results.length === 0) return;
      if (e.key === 'ArrowDown') {
        e.preventDefault();
        const next = (activeIndex + 1) % results.length;
        setActive(next); ensureVisible(next);
      } else if (e.key === 'ArrowUp') {
        e.preventDefault();
        const prev = (activeIndex - 1 + results.length) % results.length;
        setActive(prev); ensureVisible(prev);
      } else if (e.key === 'Enter') {
        e.preventDefault();
        if (activeIndex >= 0) window.location = results[activeIndex].href;
      }
    });

    function ensureVisible(i) {
      const li = list.children[i];
      if (!li) return;
      const rect = li.getBoundingClientRect();
      const parent = list.getBoundingClientRect();
      if (rect.top < parent.top) li.scrollIntoView({ block: 'nearest' });
      if (rect.bottom > parent.bottom) li.scrollIntoView({ block: 'nearest' });
    }

    // ---- Open palette instantly on logo click/tap ----
    logo.addEventListener('touchstart', (e) => { e.preventDefault(); openPalette(); }, { passive: false });
    logo.addEventListener('click', (e) => { e.preventDefault(); openPalette(); });

    // Close on backdrop click
    modal.addEventListener('click', (e) => { if (e.target === modal) closePalette(); });

    // Prevent image drag
    logo.addEventListener('dragstart', (e) => e.preventDefault());
  })();
  </script>

</body>
</html>
